/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var A=Object.create;var $=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var N=(d,o)=>{for(var e in o)$(d,e,{get:o[e],enumerable:!0})},L=(d,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of O(o))!W.call(d,n)&&n!==e&&$(d,n,{get:()=>o[n],enumerable:!(t=U(o,n))||t.enumerable});return d};var P=(d,o,e)=>(e=d!=null?A(D(d)):{},L(o||!d||!d.__esModule?$(e,"default",{value:d,enumerable:!0}):e,d)),V=d=>L($({},"__esModule",{value:!0}),d);var B={};N(B,{default:()=>M});module.exports=V(B);var c=require("obsidian");var u=require("obsidian"),w="local-chat-view",b=class extends u.ItemView{constructor(e,t){super(e);this.knownUsers=new Map;this.plugin=t}getViewType(){return w}getDisplayText(){return"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0438\u0439 \u0427\u0430\u0442"}getIcon(){return"message-circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("local-chat-view-container");let t=e.createDiv({cls:"chat-sidebar"});t.createEl("h5",{text:"\u041E\u043D\u043B\u0430\u0439\u043D:",cls:"chat-user-list-header"}),this.userListEl=t.createDiv({cls:"chat-user-list"});let n=e.createDiv({cls:"chat-main-area"});this.messageContainerEl=n.createDiv({cls:"chat-message-area"}),this.messageContainerEl.id="chat-message-area-id";let i=n.createDiv({cls:"chat-input-area"});this.inputEl=i.createEl("input",{type:"text",placeholder:"\u0412\u0432\u0435\u0434\u0456\u0442\u044C \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F...",cls:"chat-input"}),this.sendButtonEl=i.createEl("button",{cls:"chat-send-button"}),(0,u.setIcon)(this.sendButtonEl,"send-horizontal"),this.sendButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438"),this.fileButtonEl=i.createEl("button",{cls:"chat-file-button"}),(0,u.setIcon)(this.fileButtonEl,"paperclip"),this.fileButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B"),this.fileButtonEl.onClickEvent(this.handleSendFileClick.bind(this)),this.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.handleSendMessage())}),this.sendButtonEl.addEventListener("click",()=>{this.handleSendMessage()}),console.log(`[${this.plugin.manifest.name}] ChatView \u0432\u0456\u0434\u043A\u0440\u0438\u0442\u043E`),this.inputEl.focus()}handleSendFileClick(){let e=createEl("input",{type:"file"});e.onchange=async t=>{if(!e.files||e.files.length===0)return;let n=null;for(let i=0;i<e.files.length;i++){let a=e.files[i];console.log(`\u041E\u0431\u0440\u0430\u043D\u043E \u0444\u0430\u0439\u043B: ${a.name}, \u0440\u043E\u0437\u043C\u0456\u0440: ${a.size}`),await this.plugin.initiateSendFile(a,n)}e.value=""},e.click()}async onClose(){console.log(`[${this.plugin.manifest.name}] ChatView \u0437\u0430\u043A\u0440\u0438\u0442\u043E`)}handleSendMessage(){let e=this.inputEl.value.trim();if(e)try{this.plugin.sendMessage(null,e),this.inputEl.value="",this.inputEl.focus()}catch(t){console.error(`[${this.plugin.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F:`,t),new u.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F.")}}displayMessage(e,t,n,i){let a=this.messageContainerEl.createDiv({cls:`chat-message ${i?"own-message":"other-message"}`}),s=a.createDiv({cls:"message-header"});s.createSpan({cls:"message-sender",text:i?"\u0412\u0438":e}),s.createSpan({cls:"message-timestamp",text:new Date(n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let r=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");a.createDiv({cls:"message-content"}).innerHTML=r,this.scrollToBottom()}addUserToList(e){if(this.knownUsers.has(e.nickname)){let i=this.knownUsers.get(e.nickname);i!=null&&i.element&&i.element.addClass("user-online");return}let t=this.userListEl.createDiv({cls:"chat-user-list-item user-online"});t.dataset.nickname=e.nickname;let n=t.createSpan({cls:"user-icon"});(0,u.setIcon)(n,"user"),t.createSpan({cls:"user-nickname",text:e.nickname}),this.knownUsers.set(e.nickname,{nickname:e.nickname,element:t})}removeUserFromList(e){var n;let t=this.knownUsers.get(e);(n=t==null?void 0:t.element)==null||n.remove(),this.knownUsers.delete(e)&&console.log(`[${this.plugin.manifest.name}] Removed user '${e}' from UI list.`)}clearUserList(){this.userListEl&&this.userListEl.empty(),this.knownUsers.clear(),console.log(`[${this.plugin.manifest.name}] Cleared user list in UI.`)}displayFileOffer(e,t){let n=this.messageContainerEl.createDiv({cls:"chat-message file-offer",attr:{"data-file-id":t.fileId}}),i=n.createDiv({cls:"message-header"});i.createSpan({cls:"message-sender",text:e}),i.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let a=n.createDiv({cls:"message-content"});a.setText(`${e} \u043F\u0440\u043E\u043F\u043E\u043D\u0443\u0454 \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B: `),a.createEl("strong",{text:t.filename}),a.createSpan({text:` (${this.formatFileSize(t.size)})`});let s=n.createDiv({cls:"file-offer-actions"});s.createEl("button",{text:"\u041F\u0440\u0438\u0439\u043D\u044F\u0442\u0438"}).addEventListener("click",()=>{this.plugin.acceptFileOffer(e,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"accepted")}),s.createEl("button",{text:"\u0412\u0456\u0434\u0445\u0438\u043B\u0438\u0442\u0438",cls:"mod-danger"}).addEventListener("click",()=>{this.plugin.declineFileOffer(e,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"declined")}),this.scrollToBottom()}updateFileProgress(e,t,n,i,a){let s=this.messageContainerEl.querySelector(`.chat-message[data-file-id="${e}"]`);if(!s)if(t==="upload"){console.warn(`UI element for uploading file ${e} not implemented yet.`);return}else{console.warn(`Could not find message element for file transfer ${e} to update progress.`);return}let r=s.querySelector(".file-progress-container");if(!r){r=s.createDiv({cls:"file-progress-container"});let g=s.querySelector(".file-offer-actions");g&&g.empty()}r.empty();let l=i>0?Math.round(n/i*100):0,h=r.createEl("progress");h.max=i,h.value=n;let m=r.createSpan({cls:"progress-text"});switch(a){case"starting":m.setText(t==="download"?" \u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u043F\u043E\u0447\u0430\u043B\u043E\u0441\u044F... 0%":" \u0412\u0456\u0434\u043F\u0440\u0430\u0432\u043A\u0430 \u043F\u043E\u0447\u0430\u043B\u0430\u0441\u044F... 0%");break;case"progressing":m.setText(` ${l}% (${this.formatFileSize(n)} / ${this.formatFileSize(i)})`);break;case"completed":h.remove();let g=t==="download"?"\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.":"\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.";m.setText(` ${g} (${this.formatFileSize(i)})`),s.addClass("transfer-completed");break;case"error":h.remove(),m.setText(" \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456."),m.addClass("progress-error"),s.addClass("transfer-error");break;case"accepted":m.setText(" \u041F\u0440\u0438\u0439\u043D\u044F\u0442\u043E. \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0434\u0430\u043D\u0438\u0445..."),s.removeClass("offer-declined"),s.addClass("offer-accepted");break;case"declined":h.remove(),m.setText(" \u0412\u0456\u0434\u0445\u0438\u043B\u0435\u043D\u043E."),s.removeClass("offer-accepted"),s.addClass("offer-declined");break}this.scrollToBottom()}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,n=["Bytes","KB","MB","GB","TB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+n[i]}scrollToBottom(){setTimeout(()=>{this.messageContainerEl.scrollTop=this.messageContainerEl.scrollHeight},50)}displayUploadProgress(e){let t=this.messageContainerEl.createDiv({cls:"chat-message own-message file-upload",attr:{"data-file-id":e.fileId}}),n=t.createDiv({cls:"message-header"});n.createSpan({cls:"message-sender",text:"\u0412\u0438"}),n.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let i=t.createDiv({cls:"message-content"});i.setText("\u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443: "),i.createEl("strong",{text:e.filename}),i.createSpan({text:` (${this.formatFileSize(e.size)})`}),e.recipientNickname&&i.createSpan({text:` \u0434\u043E ${e.recipientNickname}`}),t.createDiv({cls:"file-progress-container"}),this.updateFileProgress(e.fileId,"upload",0,e.size,"starting"),this.scrollToBottom()}};var T=require("obsidian"),y=class{constructor(o){this.socket=null;this.serverAddress=null;this.isConnected=!1;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectDelay=5e3;this.requestedNickname=null;this.callbacks=o}connect(o,e){if(this.socket&&(this.socket.readyState===WebSocket.CONNECTING||this.socket.readyState===WebSocket.OPEN)){console.warn(`[WSClient] Already connected or connecting to ${this.serverAddress}.`);return}if(!o){console.error("[WSClient] Cannot connect: Server address is empty.");return}this.serverAddress=o,this.requestedNickname=e,this.isConnected=!1,console.log(`[WSClient] Attempting to connect to ${this.serverAddress}...`);try{this.socket=new WebSocket(this.serverAddress),this.socket.onopen=t=>this._handleOpen(t),this.socket.onmessage=t=>this._handleMessage(t),this.socket.onerror=t=>this._handleError(t),this.socket.onclose=t=>this._handleClose(t)}catch(t){console.error(`[WSClient] Error creating WebSocket connection to ${this.serverAddress}:`,t),this.callbacks.onError(t),this.socket=null}}disconnect(){this.socket&&(console.log(`[WSClient] Disconnecting from ${this.serverAddress}...`),this.reconnectAttempts=this.maxReconnectAttempts+1,this.socket.close(1e3,"Client disconnecting normally")),this.socket=null,this.isConnected=!1,this.serverAddress=null,this.requestedNickname=null}async sendMessage(o){return new Promise((e,t)=>{if(!this.isConnected||!this.socket||this.socket.readyState!==WebSocket.OPEN){console.warn("[WSClient] Cannot send message: Not connected."),t(new Error("WebSocket is not connected."));return}try{this.socket.send(JSON.stringify(o)),e()}catch(n){console.error("[WSClient] Error sending message:",n),this.callbacks.onError(n),t(n)}})}_handleOpen(o){if(console.log(`[WSClient] Connection opened successfully to ${this.serverAddress}`),this.isConnected=!0,this.reconnectAttempts=0,this.requestedNickname){let e={type:"identify",nickname:this.requestedNickname};console.log("[WSClient] Sending identification:",e),this.sendMessage(e).catch(t=>{console.error("[WSClient] Failed to send identification message:",t)})}else{console.error("[WSClient] Cannot identify: Nickname was not provided during connect."),this.disconnect();return}this.callbacks.onOpen(o)}_handleMessage(o){if(typeof o.data=="string")try{let e=JSON.parse(o.data);this.callbacks.onMessage(e)}catch(e){console.error("[WSClient] Received non-JSON text message or parse error:",o.data,e)}else o.data instanceof ArrayBuffer?console.log(`[WSClient] Received binary message (ArrayBuffer), ${o.data.byteLength} bytes.`):o.data instanceof Blob?console.log(`[WSClient] Received binary message (Blob), ${o.data.size} bytes.`):console.warn("[WSClient] Received message with unknown data type:",o.data)}_handleError(o){console.error("[WSClient] WebSocket error:",o),this.isConnected=!1,this.callbacks.onError(o)}_handleClose(o){if(console.warn(`[WSClient] WebSocket closed. Code: ${o.code}, Reason: '${o.reason}', Clean: ${o.wasClean}`),this.isConnected=!1,this.socket=null,this.callbacks.onClose(o),o.code!==1e3&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let e=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);console.log(`[WSClient] Attempting reconnect #${this.reconnectAttempts} in ${e/1e3}s...`),setTimeout(()=>{this.serverAddress&&this.requestedNickname?this.connect(this.serverAddress,this.requestedNickname):console.log("[WSClient] Cannot reconnect: connection info missing.")},e)}else o.code!==1e3&&(console.error(`[WSClient] Max reconnect attempts (${this.maxReconnectAttempts}) reached. Giving up.`),new T.Notice("Failed to reconnect to chat server.",1e4))}};var v={role:"client",serverAddress:"ws://127.0.0.1:61338",serverPort:61338,userNickname:`ObsidianUser_${Math.random().toString(36).substring(2,8)}`,saveHistory:!0,downloadPath:""};var f=require("obsidian");var C=class extends f.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Local Chat Settings"}),new f.Setting(e).setName("Instance Role").setDesc("Client connects to a server. Server accepts connections (Desktop Only). Restart required.").addDropdown(i=>{if(i.addOption("client","Client").addOption("server","Server").setValue(this.plugin.settings.role).onChange(async a=>{if(f.Platform.isMobile&&a==="server"){new f.Notice("Server role not supported on mobile."),i.setValue("client");return}this.plugin.settings.role!==a&&(this.plugin.settings.role=a,await this.plugin.saveSettings(),this.display(),new f.Notice("Role changed. Restart Obsidian for changes to take effect.",7e3))}),f.Platform.isMobile){let a=i.selectEl.querySelector('option[value="server"]');a&&(a.disabled=!0),this.plugin.settings.role==="server"&&i.setValue("client")}});let t=new f.Setting(e).setName("Server Address").setDesc("WebSocket address (e.g., ws://192.168.1.100:61338)").addText(i=>i.setPlaceholder(v.serverAddress).setValue(this.plugin.settings.serverAddress).onChange(async a=>{this.plugin.settings.serverAddress=(a==null?void 0:a.trim())||v.serverAddress,await this.plugin.saveSettings()})),n=new f.Setting(e).setName("Server Port").setDesc("Port for the server to listen on. Restart required.").addText(i=>i.setPlaceholder(String(v.serverPort)).setValue(String(this.plugin.settings.serverPort)).onChange(async a=>{let s=parseInt(a),r=!1;!isNaN(s)&&s>1024&&s<65535?this.plugin.settings.serverPort!==s&&(this.plugin.settings.serverPort=s,r=!0):a!==String(this.plugin.settings.serverPort)&&(i.setValue(String(this.plugin.settings.serverPort)),new f.Notice("Invalid port (1025-65534).")),r&&(await this.plugin.saveSettings(),new f.Notice("Server port changed. Restart Obsidian to apply.",7e3))}));this.plugin.settings.role==="server"&&!f.Platform.isMobile?(t.settingEl.style.display="none",n.settingEl.style.display=""):(t.settingEl.style.display="",n.settingEl.style.display="none"),new f.Setting(e).setName("Your Nickname").setDesc("How you appear to others.").addText(i=>i.setPlaceholder(v.userNickname).setValue(this.plugin.settings.userNickname).onChange(async a=>{let s=(a==null?void 0:a.trim())||v.userNickname;this.plugin.settings.userNickname!==s&&(this.plugin.settings.userNickname=s,await this.plugin.saveSettings())})),new f.Setting(e).setName("Download Folder").setDesc("Relative to vault root. Leave empty for vault attachment folder.").addText(i=>{let a="Default: Vault attachment folder";try{let s=this.app.vault.getConfig("attachmentFolderPath");s&&typeof s=="string"&&s.trim()&&(a=s.trim())}catch(s){console.warn("[Local Chat Settings] Could not read attachment folder path for placeholder:",s)}i.setPlaceholder(a).setValue(this.plugin.settings.downloadPath).onChange(async s=>{var r;this.plugin.settings.downloadPath=(r=s==null?void 0:s.trim())!=null?r:"",await this.plugin.saveSettings()})}),new f.Setting(e).setName("Save Chat History").setDesc("Keep messages between sessions.").addToggle(i=>i.setValue(this.plugin.settings.saveHistory).onChange(async a=>{this.plugin.settings.saveHistory=a,await this.plugin.saveSettings()}))}};var F=P(require("fs")),p=P(require("path")),M=class extends c.Plugin{constructor(){super(...arguments);this.chatView=null;this.webSocketClientManager=null;this.webSocketServerManager=null;this.outgoingFileOffers=new Map;this.incomingFileOffers=new Map;this.knownUsers=new Map}async onload(){let e=`[${this.manifest.name}]`;console.log(`${e} Loading plugin...`),await this.loadSettings(),console.log(`${e} Role: ${this.settings.role}. Nickname: ${this.settings.userNickname}.`);let t=this.createClientCallbacks(),n=this.createServerCallbacks();if(this.settings.role==="server")if(c.Platform.isMobile)new c.Notice("Error: 'Server' role is not supported on mobile. Please change in settings.",1e4),console.error(`${e} Cannot start in server mode on mobile.`);else{console.log(`${e} Initializing in SERVER mode on port ${this.settings.serverPort}...`);try{new c.Notice(`${this.manifest.name}: Server started on port ${this.settings.serverPort}.`)}catch(i){console.error(`${e} CRITICAL ERROR starting WebSocket server:`,i),new c.Notice(`[${this.manifest.name}] Failed to start server! Error: ${i.message}.`,1e4),this.webSocketServerManager=null}}else console.log(`${e} Initializing in CLIENT mode. Connecting to ${this.settings.serverAddress}...`),!this.settings.serverAddress||!this.settings.serverAddress.toLowerCase().startsWith("ws")?(new c.Notice(`[${this.manifest.name}] Invalid server address: "${this.settings.serverAddress}". Check settings.`,1e4),console.error(`${e} Invalid server address.`)):(this.webSocketClientManager=new y(t),this.webSocketClientManager.connect(this.settings.serverAddress,this.settings.userNickname));this.registerView(w,i=>(this.chatView=new b(i,this),this.populateInitialChatViewState(),this.chatView)),this.addRibbonIcon("message-circle","Open Local Chat",()=>this.activateView()),this.addCommand({id:"open-local-chat-view",name:"Open Local Chat panel",callback:()=>this.activateView()}),this.addSettingTab(new C(this.app,this)),console.log(`${e} Plugin UI initialized.`)}async onunload(){console.log(`[${this.manifest.name}] Unloading plugin...`),await this.cleanupNetworkServices(),this.app.workspace.detachLeavesOfType(w),this.chatView=null,this.outgoingFileOffers.clear(),this.incomingFileOffers.clear(),this.knownUsers.clear(),console.log(`[${this.manifest.name}] Plugin unloaded.`)}populateInitialChatViewState(){this.chatView&&this.knownUsers.forEach(e=>{var t;return(t=this.chatView)==null?void 0:t.addUserToList(e)})}async cleanupNetworkServices(){if(this.webSocketClientManager&&(this.webSocketClientManager.disconnect(),this.webSocketClientManager=null,console.log(`[${this.manifest.name}] WebSocket client disconnected.`)),this.webSocketServerManager){try{await this.webSocketServerManager.stop(),console.log(`[${this.manifest.name}] WebSocket server stopped.`)}catch(e){console.error(`[${this.manifest.name}] Error stopping WebSocket server:`,e)}this.webSocketServerManager=null}}createClientCallbacks(){return{onOpen:()=>{console.log(`[${this.manifest.name}] Client: Connected.`),new c.Notice("Chat connected.",3e3)},onClose:e=>{var t,n;console.warn(`[${this.manifest.name}] Client: Disconnected. Code: ${e.code}`),new c.Notice("Chat disconnected.",5e3),this.knownUsers.clear(),(n=(t=this.chatView)==null?void 0:t.clearUserList)==null||n.call(t)},onError:e=>{console.error(`[${this.manifest.name}] Client: WebSocket Error`,e),new c.Notice("Chat connection error.",5e3)},onMessage:e=>{console.debug(`[${this.manifest.name}] Client: Received message`,e),this.handleServerMessage(e)}}}createServerCallbacks(){return{onClientConnected:(e,t)=>{var a;console.log(`[${this.manifest.name}] Server: Client '${t}' connected (ID: ${e})`);let n={nickname:t};this.handleUserFound(n);let i={type:"userList",users:this.getAllUsers(),timestamp:Date.now()};(a=this.webSocketServerManager)==null||a.sendToClient(e,i)},onClientDisconnected:(e,t)=>{console.log(`[${this.manifest.name}] Server: Client '${t}' disconnected (ID: ${e})`),this.handleUserLeft({nickname:t})},onMessage:(e,t,n)=>{console.debug(`[${this.manifest.name}] Server: Message from '${t}' (ID: ${e})`,n),this.handleClientMessage(e,t,n)},onError:e=>{console.error(`[${this.manifest.name}] Server: Error`,e),new c.Notice(`Chat Server Error: ${e.message}`,5e3)}}}handleServerMessage(e){var t,n,i,a;switch(e.type){case"text":{let s=e,r=s.senderNickname||"Unknown";console.log(`[${this.manifest.name}] Handling incoming text from ${r}`),(t=this.chatView)==null||t.displayMessage(r,s.content,s.timestamp||Date.now(),!1);break}case"fileOffer":{let s=e,r=s.senderNickname||"Unknown";console.log(`[${this.manifest.name}] Handling incoming fileOffer from ${r}`),this.incomingFileOffers.set(s.fileId,{...s,senderNickname:r}),(n=this.chatView)==null||n.displayFileOffer(r,s),this.isChatViewActive()||new c.Notice(`File offer '${s.filename}' from ${r}`);break}case"fileAccept":{let s=e;console.log(`[${this.manifest.name}] Handling incoming fileAccept for ${s.fileId} from ${s.senderNickname}`),this.handleRemoteFileAccept(s.fileId,s.senderNickname);break}case"fileDecline":{let s=e;console.log(`[${this.manifest.name}] Handling incoming fileDecline for ${s.fileId} from ${s.senderNickname}`),this.handleRemoteFileDecline(s.fileId,s.senderNickname);break}case"userList":{let s=e;console.log(`[${this.manifest.name}] Received user list from server`,s.users),this.knownUsers.clear(),s.users.forEach(r=>this.knownUsers.set(r.nickname,r)),(a=(i=this.chatView)==null?void 0:i.clearUserList)==null||a.call(i),this.knownUsers.forEach(r=>{var l;return(l=this.chatView)==null?void 0:l.addUserToList(r)});break}case"userJoin":{let s=e;console.log(`[${this.manifest.name}] User joined: ${s.nickname}`),this.handleUserFound({nickname:s.nickname});break}case"userLeave":{let s=e;console.log(`[${this.manifest.name}] User left: ${s.nickname}`),this.handleUserLeft({nickname:s.nickname});break}default:console.warn(`[${this.manifest.name}] Received unhandled message type from server:`,e.type)}}handleClientMessage(e,t,n){var i,a;if(this.webSocketServerManager)switch(n.senderNickname&&n.senderNickname!==t&&console.warn(`[${this.manifest.name}] Message senderNickname mismatch from client ${e}. Claimed: '${n.senderNickname}', Actual: '${t}'. Using actual.`),n.senderNickname=t,n.type){case"text":{let s=n;console.log(`[${this.manifest.name}] Broadcasting text from ${t}`),this.webSocketServerManager.broadcast(e,s),(i=this.chatView)==null||i.displayMessage(s.senderNickname,s.content,s.timestamp||Date.now(),!1);break}case"fileOffer":{let s=n,r=s.recipient;r?(console.log(`[${this.manifest.name}] Relaying private fileOffer from ${t} to ${r}`),this.webSocketServerManager.sendToClientByNickname(r,s)||console.warn(`[${this.manifest.name}] Recipient ${r} not found for file offer relay.`)):(console.log(`[${this.manifest.name}] Broadcasting fileOffer from ${t}`),this.webSocketServerManager.broadcast(e,s),this.incomingFileOffers.set(s.fileId,{...s,senderNickname:t,senderClientId:e}),(a=this.chatView)==null||a.displayFileOffer(t,s));break}case"fileAccept":case"fileDecline":{let s=n,r=s.originalSender;r?(console.log(`[${this.manifest.name}] Relaying ${s.type} for ${s.fileId} from ${t} to original sender ${r}`),this.webSocketServerManager.sendToClientByNickname(r,s)||console.warn(`[${this.manifest.name}] Cannot relay ${s.type}: Original sender ${r} not found.`)):console.warn(`[${this.manifest.name}] Cannot relay ${s.type}: Original sender not specified in message from ${t}.`,s);break}default:console.warn(`[${this.manifest.name}] Received unhandled message type from client ${t}:`,n.type)}}handleUserFound(e){var t;if(this.knownUsers.set(e.nickname,e),(t=this.chatView)==null||t.addUserToList(e),this.settings.role==="server"&&this.webSocketServerManager&&e.nickname!==this.settings.userNickname){let n={type:"userJoin",nickname:e.nickname,timestamp:Date.now()},i=this.webSocketServerManager.findClientIdByNickname(e.nickname);this.webSocketServerManager.broadcast(i,n)}}handleUserLeft(e){var t;if(this.knownUsers.delete(e.nickname)&&(console.log(`[${this.manifest.name}] User Left: ${e.nickname}`),(t=this.chatView)==null||t.removeUserFromList(e.nickname),this.settings.role==="server"&&this.webSocketServerManager)){let n={type:"userLeave",nickname:e.nickname,timestamp:Date.now()};this.webSocketServerManager.broadcast(null,n)}}getAllUsers(){return Array.from(this.knownUsers.values())}async sendMessage(e,t){var l;let n=this.settings.userNickname;if(!(t!=null&&t.trim()))return;let i=t.trim(),a=Date.now();(l=this.chatView)==null||l.displayMessage(n,i,a,!0);let s={type:"text",senderNickname:n,content:i,timestamp:a,recipient:e},r=null;try{if(this.settings.role==="client"&&this.webSocketClientManager)await this.webSocketClientManager.sendMessage(s);else if(this.settings.role==="server"&&this.webSocketServerManager)this.webSocketServerManager.handleLocalMessage(s,e);else throw new Error("Chat service not configured or active.")}catch(h){console.error(`[${this.manifest.name}] Error sending message:`,h),r=`Send Error: ${h.message}`}r&&new c.Notice(r)}async initiateSendFile(e,t){var E,S,x;let n=`[${this.manifest.name}]`;if(!(this.settings.role==="client"?this.webSocketClientManager:this.webSocketServerManager)){new c.Notice("Chat service is not ready to send files."),console.error(`${n} initiateSendFile: No active WebSocket manager.`);return}if(t!==null){new c.Notice("User discovery service not ready for private file offer."),console.warn(`${n} initiateSendFile: UserDiscovery needed for private offer to ${t}`);return}let a=`file_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s=e.name,r=e.size,l=e.path;if(!l||typeof l!="string"){let k="Error: Could not determine file path. File sending may require copying the file first (feature not fully implemented).";new c.Notice(k,1e4),console.error(`${n} initiateSendFile: Failed to determine file path for '${s}'. '.path' property is unreliable.`);return}console.warn(`${n} initiateSendFile: Using potentially unreliable file path: ${l}`);let h={fileId:a,filePath:l,filename:s,size:r,recipientNickname:t};this.outgoingFileOffers.set(a,h),console.log(`${n} Stored outgoing file offer: ${s} (ID: ${a})`),(E=this.chatView)==null||E.displayUploadProgress({fileId:a,filename:s,size:r,recipientNickname:t});let m={type:"fileOffer",senderNickname:this.settings.userNickname,fileId:a,filename:s,size:r,recipient:t,timestamp:Date.now()},g=null;try{if(console.log(`${n} Sending fileOffer ${a} (To: ${t!=null?t:"broadcast"})...`),this.settings.role==="client"){if(!this.webSocketClientManager)throw new Error("Client manager not available.");await this.webSocketClientManager.sendMessage(m)}else{if(!this.webSocketServerManager)throw new Error("Server manager not available.");this.webSocketServerManager.handleLocalMessage(m,t)}console.log(`${n} File offer ${a} sent successfully.`)}catch(k){console.error(`${n} Error sending fileOffer for ${a}:`,k),g=`Error sending file offer: ${k.message}`,this.outgoingFileOffers.delete(a),(x=(S=this.chatView)==null?void 0:S.updateFileProgress)==null||x.call(S,a,"upload",0,r,"error")}g&&new c.Notice(g)}async acceptFileOffer(e,t){var s,r,l,h;let n=this.incomingFileOffers.get(t);if(!n){new c.Notice("Error: File offer not found or already handled.");return}console.log(`[${this.manifest.name}] Accepting file offer ${t} from ${e}`),(r=(s=this.chatView)==null?void 0:s.updateFileProgress)==null||r.call(s,t,"download",0,n.size,"accepted");let i={type:"fileAccept",senderNickname:this.settings.userNickname,fileId:t,originalSender:e,timestamp:Date.now()},a=null;try{if(this.settings.role==="client"&&this.webSocketClientManager)await this.webSocketClientManager.sendMessage(i);else if(this.settings.role==="server"&&this.webSocketServerManager){if(!this.webSocketServerManager.sendToClientByNickname(e,i))throw new Error(`Cannot send acceptance, user ${e} not found.`)}else throw new Error("Chat service not configured or active.");console.log(`[${this.manifest.name}] File acceptance for ${t} sent.`)}catch(m){console.error(`[${this.manifest.name}] Error sending file acceptance for ${t}:`,m),a=`Error accepting file: ${m.message}`,this.incomingFileOffers.delete(t),(h=(l=this.chatView)==null?void 0:l.updateFileProgress)==null||h.call(l,t,"download",0,n.size,"error")}a&&new c.Notice(a)}async declineFileOffer(e,t){var a,s,r,l;let n=this.incomingFileOffers.get(t);if(!n){(s=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||s.call(a,t,"download",0,0,"declined");return}console.log(`[${this.manifest.name}] Declining file offer ${t} from ${e}`),this.incomingFileOffers.delete(t),(l=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||l.call(r,t,"download",0,n.size||0,"declined");let i={type:"fileDecline",senderNickname:this.settings.userNickname,fileId:t,originalSender:e,timestamp:Date.now()};try{this.settings.role==="client"&&this.webSocketClientManager?await this.webSocketClientManager.sendMessage(i):this.settings.role==="server"&&this.webSocketServerManager&&(this.webSocketServerManager.sendToClientByNickname(e,i)||console.warn(`[${this.manifest.name}] Cannot send decline, user ${e} not found.`)),console.log(`[${this.manifest.name}] Decline message for ${t} sent (or attempted).`)}catch(h){console.warn(`[${this.manifest.name}] Error sending file decline for ${t}: ${h.message}`)}}handleRemoteFileDecline(e,t){var i,a;let n=this.outgoingFileOffers.get(e);n?(console.log(`[${this.manifest.name}] User ${t} declined file ${n.filename} (ID: ${e})`),new c.Notice(`User ${t} declined file: ${n.filename}`),this.outgoingFileOffers.delete(e),(a=(i=this.chatView)==null?void 0:i.updateFileProgress)==null||a.call(i,e,"upload",0,n.size||0,"declined")):console.warn(`[${this.manifest.name}] Received remote fileDecline for unknown outgoing offer ID: ${e}`)}async handleRemoteFileAccept(e,t){var a,s,r,l;let n=this.outgoingFileOffers.get(e);if(!n){console.warn(`[${this.manifest.name}] Received acceptance for unknown outgoing offer ${e}`);return}if(console.log(`[${this.manifest.name}] User ${t} accepted file ${n.filename} (ID: ${e}). Preparing upload...`),!await this.adapterFileExists(n.filePath)){console.error(`[${this.manifest.name}] Cannot start upload for ${e}: File not accessible at path: ${n.filePath}.`),console.error("Reminder: The method to obtain 'filePath' in 'initiateSendFile' needs a proper implementation (e.g., copying the file)."),new c.Notice(`Error starting upload: Cannot access file ${n.filename}`),this.outgoingFileOffers.delete(e),(s=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||s.call(a,e,"upload",0,n.size,"error");return}(l=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||l.call(r,e,"upload",0,n.size,"starting"),console.error("<<<<< FILE UPLOAD STREAMING VIA WEBSOCKET IS NOT IMPLEMENTED >>>>>"),new c.Notice(`File upload streaming for ${n.filename} not implemented yet.`),setTimeout(()=>{console.warn(`[${this.manifest.name}] Placeholder: Simulating error for unimplemented upload of ${e}`),this.handleFileTransferError(e,"upload",new Error("File upload streaming not implemented"))},1500)}handleFileAcceptReceived(e,t){t.originalSender===this.settings.userNickname?(console.log(`[${this.manifest.name}] Handling fileAccept message from ${e.nickname} for our offer ${t.fileId}`),this.handleRemoteFileAccept(t.fileId,e.nickname)):console.warn(`[${this.manifest.name}] Received fileAccept message for an offer not originated by us. Original Sender: ${t.originalSender}, File ID: ${t.fileId}`)}handleFileTransferError(e,t,n){var s,r;console.error(`[${this.manifest.name}] File transfer error: ${e} (${t})`,n);let i=t==="upload"?this.outgoingFileOffers.get(e):this.incomingFileOffers.get(e),a=(i==null?void 0:i.filename)||"\u0444\u0430\u0439\u043B";new c.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456 \u0444\u0430\u0439\u043B\u0443 '${a}': ${n.message}`,7e3),t==="upload"?this.outgoingFileOffers.delete(e):this.incomingFileOffers.delete(e),(r=(s=this.chatView)==null?void 0:s.updateFileProgress)==null||r.call(s,e,t,0,0,"error")}async loadSettings(){this.settings=Object.assign({},v,await this.loadData())}async saveSettings(){await this.saveData(this.settings),console.log(`[${this.manifest.name}] Settings saved.`)}async activateView(){var i;let{workspace:e}=this.app,t=null,n=e.getLeavesOfType(w);if(n.length>0)t=n[0];else{let a=(i=e.getRightLeaf(!1))!=null?i:e.getLeftLeaf(!1);if(a)t=a,await t.setViewState({type:w,active:!0});else{console.error("Could not get a side leaf."),new c.Notice("Error opening chat panel.");return}}t?e.revealLeaf(t):console.error("Logic error in activateView: leafToReveal is unexpectedly null.")}isChatViewActive(){let e=this.app.workspace.activeLeaf;return!!e&&e.getViewState().type===w}async determineSavePath(e){var m;let t=((m=this.settings.downloadPath)==null?void 0:m.trim())||"";if(!t)try{let g=this.app.vault.getConfig("attachmentFolderPath");g&&typeof g=="string"?t=g.startsWith("/")?g.substring(1):g:t=""}catch(g){console.warn(`[${this.manifest.name}] Error reading attachment folder setting, using vault root.`,g),t=""}try{let g=this.app.vault.getAbstractFileByPath(t);g&&!(g instanceof c.TFolder)?(console.warn(`[${this.manifest.name}] Download path '${t}' is not a folder. Using vault root.`),t=""):!g&&t&&await this.app.vault.createFolder(t)}catch(g){console.error(`[${this.manifest.name}] Error ensuring download directory '${t}' exists. Using vault root.`,g),t=""}let n=this.app.vault.adapter;if(typeof n.getBasePath!="function")throw new Error("Cannot determine vault base path via adapter.");let i=p.join(n.getBasePath(),t),a=0,s=this.sanitizeFilename(e),r=s,l=p.join(i,r),h=100;for(;await this.adapterFileExists(l)&&a<h;){a++;let g=p.extname(s);r=`${p.basename(s,g)} (${a})${g}`,l=p.join(i,r)}if(a>=h)throw new Error(`Failed to find unique filename for ${e}`);return console.log(`[${this.manifest.name}] Determined save path: ${l}`),l}async adapterFileExists(e){try{let t=this.app.vault.adapter;if(typeof t.getBasePath!="function"||typeof t.stat!="function")return console.warn("[adapterFileExists] Adapter missing required methods, falling back to fs.existsSync"),F.existsSync(e);let n=t.getBasePath(),i=p.relative(n,e).replace(/\\/g,"/");return!i||i.startsWith("..")?(console.warn(`[adapterFileExists] Path outside vault? ${i}. Using fs.existsSync.`),F.existsSync(e)):!!await t.stat(i)}catch(t){return!1}}sanitizeFilename(e){let t=/[<>:"/\\|?*\x00-\x1F]/g,n=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,i=e.replace(t,"_");return n.test(i)&&(i=`_${i}`),(i.trim()||"downloaded_file").substring(0,200)}};
