/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Wn=Object.create;var $e=Object.defineProperty;var Gn=Object.getOwnPropertyDescriptor;var Qn=Object.getOwnPropertyNames;var Jn=Object.getPrototypeOf,Zn=Object.prototype.hasOwnProperty;var k=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),fn=(r,e)=>{for(var n in e)$e(r,n,{get:e[n],enumerable:!0})},un=(r,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Qn(e))!Zn.call(r,i)&&i!==n&&$e(r,i,{get:()=>e[i],enumerable:!(t=Gn(e,i))||t.enumerable});return r};var ae=(r,e,n)=>(n=r!=null?Wn(Jn(r)):{},un(e||!r||!r.__esModule?$e(n,"default",{value:r,enumerable:!0}):n,r)),et=r=>un($e({},"__esModule",{value:!0}),r);var Oe=k(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.default=nt;var gn=/[A-Z]/g;function pn(r){return r.toLowerCase()}function nt(r,e){let n=r.replace(gn,pn),t=e.replace(gn,pn);return n===t}});var qe=k(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.DnsTxt=void 0;var Fe=class{constructor(e={}){this.binary=e?e.binary:!1}encode(e={}){return Object.entries(e).map(([n,t])=>{let i=`${n}=${t}`;return Buffer.from(i)})}decode(e){var n={};try{let i=e.toString().split(/=(.+)/),s=i[0],a=i[1];n[s]=a}catch(t){}return n}decodeAll(e){return e.filter(n=>n.length>1).map(n=>this.decode(n)).reduce((n,t)=>{var i=n;let[s]=Object.keys(t),[a]=Object.values(t);return i[s]=a,i},{})}};Ee.DnsTxt=Fe;Ee.default=Fe});var ze=k(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});ge.toType=ge.toString=void 0;var mn=r=>"_"+r,tt=r=>["name","protocol","subtype"].includes(r),rt=r=>{let e={name:r.name,protocol:r.protocol,subtype:r.subtype};return Object.entries(e).filter(([t,i])=>tt(t)&&i!==void 0).reduce((t,[i,s])=>{switch(typeof s){case"object":s.map(a=>t.push(mn(a)));break;default:t.push(mn(s));break}return t},[]).join(".")};ge.toString=rt;var it=r=>{let e=r.split("."),n;for(let t in e)e[t][0]==="_"&&(e[t]=e[t].slice(1));return e.includes("sub")&&(n=e.shift(),e.shift()),{name:e.shift(),protocol:e.shift()||null,subtype:n}};ge.toType=it});var Ve=k(ce=>{"use strict";var vn=ce&&ce.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ce,"__esModule",{value:!0});ce.Service=void 0;var yn=vn(require("os")),st=vn(qe()),at=require("events"),ot=ze(),Te=".local",Ie=class extends at.EventEmitter{constructor(e){if(super(),this.probe=!0,this.published=!1,this.activated=!1,this.destroyed=!1,this.txtService=new st.default,!e.name)throw new Error("ServiceConfig requires `name` property to be set");if(!e.type)throw new Error("ServiceConfig requires `type` property to be set");if(!e.port)throw new Error("ServiceConfig requires `port` property to be set");this.name=e.name.split(".").join("-"),this.protocol=e.protocol||"tcp",this.type=(0,ot.toString)({name:e.type,protocol:this.protocol}),this.port=e.port,this.host=e.host||yn.default.hostname(),this.fqdn=`${this.name}.${this.type}${Te}`,this.txt=e.txt,this.subtypes=e.subtypes,this.disableIPv6=!!e.disableIPv6}records(){var e=[this.RecordPTR(this),this.RecordSRV(this),this.RecordTXT(this)];for(let t of this.subtypes||[])e.push(this.RecordSubtypePTR(this,t));let n=Object.values(yn.default.networkInterfaces());for(let t of n){let i=t;for(let s of i)if(!(s.internal||s.mac==="00:00:00:00:00:00"))switch(s.family){case"IPv4":e.push(this.RecordA(this,s.address));break;case"IPv6":if(this.disableIPv6)break;e.push(this.RecordAAAA(this,s.address));break}}return e}RecordPTR(e){return{name:`${e.type}${Te}`,type:"PTR",ttl:28800,data:e.fqdn}}RecordSubtypePTR(e,n){return{name:`_${n}._sub.${e.type}${Te}`,type:"PTR",ttl:28800,data:`${e.name}.${e.type}${Te}`}}RecordSRV(e){return{name:e.fqdn,type:"SRV",ttl:120,data:{port:e.port,target:e.host}}}RecordTXT(e){return{name:e.fqdn,type:"TXT",ttl:4500,data:this.txtService.encode(e.txt)}}RecordA(e,n){return{name:e.host,type:"A",ttl:120,data:n}}RecordAAAA(e,n){return{name:e.host,type:"AAAA",ttl:120,data:n}}};ce.Service=Ie;ce.default=Ie});var En=k(le=>{"use strict";var wn=le&&le.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(le,"__esModule",{value:!0});le.Registry=void 0;var ct=wn(Oe()),He=wn(Ve()),lt=60*60*1e3,dt=3,ut=function(){},Le=class{constructor(e){this.services=[],this.server=e}publish(e){function n(s,a,o){s.activated||(s.activated=!0,a.services.push(s),s instanceof He.default&&(o!=null&&o.probe?a.probe(a.server.mdns,s,c=>{if(c){s.stop!==void 0&&s.stop(),console.log(new Error("Service name is already in use on the network"));return}a.announce(a.server,s)}):a.announce(a.server,s)))}function t(s,a,o){if(o||(o=ut),!s.activated||!(s instanceof He.default))return process.nextTick(o);a.teardown(a.server,s,o);let c=a.services.indexOf(s);c!==-1&&a.services.splice(c,1)}let i=new He.default(e);return i.start=n.bind(null,i,this),i.stop=t.bind(null,i,this),i.start({probe:e.probe!==!1}),i}unpublishAll(e){this.teardown(this.server,this.services,e),this.services=[]}destroy(){this.services.map(e=>e.destroyed=!0)}probe(e,n,t){var i=!1,s=0,a;let o=()=>{!n.activated||n.destroyed||e.query(n.fqdn,"ANY",function(){i=!0,a=setTimeout(++s<3?o:m,250),a.unref()})},c=l=>{i&&(l.answers.some(h)||l.additionals.some(h))&&m(!0)},h=l=>(0,ct.default)(l.name,n.fqdn),m=l=>{e.removeListener("response",c),clearTimeout(a),t(!!l)};e.on("response",c),setTimeout(o,Math.random()*250)}announce(e,n){var t=1e3,i=n.records();e.register(i);let s=()=>{!n.activated||n.destroyed||e.mdns.respond(i,function(){n.published||(n.activated=!0,n.published=!0,n.emit("up")),t=t*dt,t<lt&&!n.destroyed&&setTimeout(s,t).unref()})};s()}teardown(e,n,t){Array.isArray(n)||(n=[n]),n=n.filter(s=>s.activated);var i=n.flatMap(function(s){s.activated=!1;var a=s.records();return a.forEach(o=>{o.ttl=0}),a});if(i.length===0)return t&&process.nextTick(t);e.unregister(i),e.mdns.respond(i,function(){n.forEach(function(s){s.published=!1}),typeof t=="function"&&t.apply(null,arguments)})}};le.Registry=Le;le.default=Le});var Sn=k(je=>{"use strict";je.toString=function(r){switch(r){case 1:return"A";case 10:return"NULL";case 28:return"AAAA";case 18:return"AFSDB";case 42:return"APL";case 257:return"CAA";case 60:return"CDNSKEY";case 59:return"CDS";case 37:return"CERT";case 5:return"CNAME";case 49:return"DHCID";case 32769:return"DLV";case 39:return"DNAME";case 48:return"DNSKEY";case 43:return"DS";case 55:return"HIP";case 13:return"HINFO";case 45:return"IPSECKEY";case 25:return"KEY";case 36:return"KX";case 29:return"LOC";case 15:return"MX";case 35:return"NAPTR";case 2:return"NS";case 47:return"NSEC";case 50:return"NSEC3";case 51:return"NSEC3PARAM";case 12:return"PTR";case 46:return"RRSIG";case 17:return"RP";case 24:return"SIG";case 6:return"SOA";case 99:return"SPF";case 33:return"SRV";case 44:return"SSHFP";case 32768:return"TA";case 249:return"TKEY";case 52:return"TLSA";case 250:return"TSIG";case 16:return"TXT";case 252:return"AXFR";case 251:return"IXFR";case 41:return"OPT";case 255:return"ANY"}return"UNKNOWN_"+r};je.toType=function(r){switch(r.toUpperCase()){case"A":return 1;case"NULL":return 10;case"AAAA":return 28;case"AFSDB":return 18;case"APL":return 42;case"CAA":return 257;case"CDNSKEY":return 60;case"CDS":return 59;case"CERT":return 37;case"CNAME":return 5;case"DHCID":return 49;case"DLV":return 32769;case"DNAME":return 39;case"DNSKEY":return 48;case"DS":return 43;case"HIP":return 55;case"HINFO":return 13;case"IPSECKEY":return 45;case"KEY":return 25;case"KX":return 36;case"LOC":return 29;case"MX":return 15;case"NAPTR":return 35;case"NS":return 2;case"NSEC":return 47;case"NSEC3":return 50;case"NSEC3PARAM":return 51;case"PTR":return 12;case"RRSIG":return 46;case"RP":return 17;case"SIG":return 24;case"SOA":return 6;case"SPF":return 99;case"SRV":return 33;case"SSHFP":return 44;case"TA":return 32768;case"TKEY":return 249;case"TLSA":return 52;case"TSIG":return 250;case"TXT":return 16;case"AXFR":return 252;case"IXFR":return 251;case"OPT":return 41;case"ANY":return 255;case"*":return 255}return r.toUpperCase().startsWith("UNKNOWN_")?parseInt(r.slice(8)):0}});var Un=k(Ye=>{"use strict";Ye.toString=function(r){switch(r){case 0:return"NOERROR";case 1:return"FORMERR";case 2:return"SERVFAIL";case 3:return"NXDOMAIN";case 4:return"NOTIMP";case 5:return"REFUSED";case 6:return"YXDOMAIN";case 7:return"YXRRSET";case 8:return"NXRRSET";case 9:return"NOTAUTH";case 10:return"NOTZONE";case 11:return"RCODE_11";case 12:return"RCODE_12";case 13:return"RCODE_13";case 14:return"RCODE_14";case 15:return"RCODE_15"}return"RCODE_"+r};Ye.toRcode=function(r){switch(r.toUpperCase()){case"NOERROR":return 0;case"FORMERR":return 1;case"SERVFAIL":return 2;case"NXDOMAIN":return 3;case"NOTIMP":return 4;case"REFUSED":return 5;case"YXDOMAIN":return 6;case"YXRRSET":return 7;case"NXRRSET":return 8;case"NOTAUTH":return 9;case"NOTZONE":return 10;case"RCODE_11":return 11;case"RCODE_12":return 12;case"RCODE_13":return 13;case"RCODE_14":return 14;case"RCODE_15":return 15}return 0}});var kn=k(Ke=>{"use strict";Ke.toString=function(r){switch(r){case 0:return"QUERY";case 1:return"IQUERY";case 2:return"STATUS";case 3:return"OPCODE_3";case 4:return"NOTIFY";case 5:return"UPDATE";case 6:return"OPCODE_6";case 7:return"OPCODE_7";case 8:return"OPCODE_8";case 9:return"OPCODE_9";case 10:return"OPCODE_10";case 11:return"OPCODE_11";case 12:return"OPCODE_12";case 13:return"OPCODE_13";case 14:return"OPCODE_14";case 15:return"OPCODE_15"}return"OPCODE_"+r};Ke.toOpcode=function(r){switch(r.toUpperCase()){case"QUERY":return 0;case"IQUERY":return 1;case"STATUS":return 2;case"OPCODE_3":return 3;case"NOTIFY":return 4;case"UPDATE":return 5;case"OPCODE_6":return 6;case"OPCODE_7":return 7;case"OPCODE_8":return 8;case"OPCODE_9":return 9;case"OPCODE_10":return 10;case"OPCODE_11":return 11;case"OPCODE_12":return 12;case"OPCODE_13":return 13;case"OPCODE_14":return 14;case"OPCODE_15":return 15}return 0}});var $n=k(Xe=>{"use strict";Xe.toString=function(r){switch(r){case 1:return"IN";case 2:return"CS";case 3:return"CH";case 4:return"HS";case 255:return"ANY"}return"UNKNOWN_"+r};Xe.toClass=function(r){switch(r.toUpperCase()){case"IN":return 1;case"CS":return 2;case"CH":return 3;case"HS":return 4;case"ANY":return 255}return 0}});var Cn=k(We=>{"use strict";We.toString=function(r){switch(r){case 1:return"LLQ";case 2:return"UL";case 3:return"NSID";case 5:return"DAU";case 6:return"DHU";case 7:return"N3U";case 8:return"CLIENT_SUBNET";case 9:return"EXPIRE";case 10:return"COOKIE";case 11:return"TCP_KEEPALIVE";case 12:return"PADDING";case 13:return"CHAIN";case 14:return"KEY_TAG";case 26946:return"DEVICEID"}return r<0?null:`OPTION_${r}`};We.toCode=function(r){if(typeof r=="number")return r;if(!r)return-1;switch(r.toUpperCase()){case"OPTION_0":return 0;case"LLQ":return 1;case"UL":return 2;case"NSID":return 3;case"OPTION_4":return 4;case"DAU":return 5;case"DHU":return 6;case"N3U":return 7;case"CLIENT_SUBNET":return 8;case"EXPIRE":return 9;case"COOKIE":return 10;case"TCP_KEEPALIVE":return 11;case"PADDING":return 12;case"CHAIN":return 13;case"KEY_TAG":return 14;case"DEVICEID":return 26946;case"OPTION_65535":return 65535}let e=r.match(/_(\d+)$/);return e?parseInt(e[1],10):-1}});var Fn=k((On,Ge)=>{var Dn=function(r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.decode=l,r.encode=m,r.familyOf=h,r.name=void 0,r.sizeOf=c,r.v6=r.v4=void 0;let e=/^(\d{1,3}\.){3,3}\d{1,3}$/,n=4,t=/^(::)?(((\d{1,3}\.){3}(\d{1,3}){1})?([0-9a-f]){0,4}:{0,2}){1,8}(::)?$/i,i=16,s={name:"v4",size:n,isFormat:g=>e.test(g),encode(g,u,d){d=~~d,u=u||new Uint8Array(d+n);let y=g.length,U=0;for(let $=0;$<y;){let P=g.charCodeAt($++);P===46?(u[d++]=U,U=0):U=U*10+(P-48)}return u[d]=U,u},decode(g,u){return u=~~u,`${g[u++]}.${g[u++]}.${g[u++]}.${g[u]}`}};r.v4=s;let a={name:"v6",size:i,isFormat:g=>g.length>0&&t.test(g),encode(g,u,d){d=~~d;let y=d+i,U=-1,$=0,P=0,ve=!0,ke=!1;u=u||new Uint8Array(d+i);for(let re=0;re<g.length;re++){let Y=g.charCodeAt(re);Y===58?(ve?U!==-1?(d<y&&(u[d]=0),d<y-1&&(u[d+1]=0),d+=2):d<y&&(U=d):(ke===!0?(d<y&&(u[d]=P),d++):(d<y&&(u[d]=$>>8),d<y-1&&(u[d+1]=$&255),d+=2),$=0,P=0),ve=!0,ke=!1):Y===46?(d<y&&(u[d]=P),d++,P=0,$=0,ve=!1,ke=!0):(ve=!1,Y>=97?Y-=87:Y>=65?Y-=55:(Y-=48,P=P*10+Y),$=($<<4)+Y)}if(ve===!1)ke===!0?(d<y&&(u[d]=P),d++):(d<y&&(u[d]=$>>8),d<y-1&&(u[d+1]=$&255),d+=2);else if(U===0)d<y&&(u[d]=0),d<y-1&&(u[d+1]=0),d+=2;else if(U!==-1){d+=2;for(let re=Math.min(d-1,y-1);re>=U+2;re--)u[re]=u[re-2];u[U]=0,u[U+1]=0,U=d}if(U!==d&&U!==-1)for(d>y-2&&(d=y-2);y>U;)u[--y]=d<y&&d>U?u[--d]:0;else for(;d<y;)u[d++]=0;return u},decode(g,u){u=~~u;let d="";for(let y=0;y<i;y+=2)y!==0&&(d+=":"),d+=(g[u+y]<<8|g[u+y+1]).toString(16);return d.replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}};r.v6=a;let o="ip";r.name=o;function c(g){if(s.isFormat(g))return s.size;if(a.isFormat(g))return a.size;throw Error(`Invalid ip address: ${g}`)}function h(g){return c(g)===s.size?1:2}function m(g,u,d){d=~~d;let y=c(g);return typeof u=="function"&&(u=u(d+y)),y===s.size?s.encode(g,u,d):a.encode(g,u,d)}function l(g,u,d){if(u=~~u,d=d||g.length-u,d===s.size)return s.decode(g,u,d);if(d===a.size)return a.decode(g,u,d);throw Error(`Invalid buffer size needs to be ${s.size} for v4 or ${a.size} for v6.`)}return"default"in r?r.default:r}({});typeof define=="function"&&define.amd?define([],function(){return Dn}):typeof Ge=="object"&&typeof On=="object"&&(Ge.exports=Dn)});var Ln=k(v=>{"use strict";var w=require("buffer").Buffer,te=Sn(),ht=Un(),gt=kn(),Ne=$n(),Qe=Cn(),de=Fn(),pt=0,Tn=1<<15,Je=1<<15,mt=~Je,In=1<<15,yt=~In,p=v.name={};p.encode=function(r,e,n,{mail:t=!1}={}){e||(e=w.alloc(p.encodingLength(r))),n||(n=0);let i=n,s=r.replace(/^\.|\.$/gm,"");if(s.length){let a=[];if(t){let o="";s.split(".").forEach(c=>{c.endsWith("\\")?o+=(o.length?".":"")+c.slice(0,-1):a.length===0&&o.length?a.push(o+"."+c):a.push(c)})}else a=s.split(".");for(let o=0;o<a.length;o++){let c=e.write(a[o],n+1);e[n]=c,n+=c+1}}return e[n++]=0,p.encode.bytes=n-i,e};p.encode.bytes=0;p.decode=function(r,e,{mail:n=!1}={}){e||(e=0);let t=[],i=e,s=0,a=0,o=!1;for(;;){if(e>=r.length)throw new Error("Cannot decode name (buffer overflow)");let c=r[e++];if(a+=o?0:1,c===0)break;if(c&192)if((c&192)===192){if(e+1>r.length)throw new Error("Cannot decode name (buffer overflow)");let h=r.readUInt16BE(e-1)-49152;if(h>=i)throw new Error("Cannot decode name (bad pointer)");e=h,i=h,a+=o?0:1,o=!0}else throw new Error("Cannot decode name (bad label)");else{if(e+c>r.length)throw new Error("Cannot decode name (buffer overflow)");if(s+=c+1,s>254)throw new Error("Cannot decode name (name too long)");let h=r.toString("utf-8",e,e+c);n&&(h=h.replace(/\./g,"\\.")),t.push(h),e+=c,a+=o?0:c}}return p.decode.bytes=a,t.length===0?".":t.join(".")};p.decode.bytes=0;p.encodingLength=function(r){return r==="."||r===".."?1:w.byteLength(r.replace(/^\.|\.$/gm,""))+2};var E={};E.encode=function(r,e,n){e||(e=w.alloc(E.encodingLength(r))),n||(n=0);let t=e.write(r,n+1);return e[n]=t,E.encode.bytes=t+1,e};E.encode.bytes=0;E.decode=function(r,e){e||(e=0);let n=r[e],t=r.toString("utf-8",e+1,e+1+n);return E.decode.bytes=n+1,t};E.decode.bytes=0;E.encodingLength=function(r){return w.byteLength(r)+1};var B={};B.encode=function(r,e,n){e||(e=B.encodingLength(r)),n||(n=0);let t=(r.flags||0)&32767,i=r.type==="response"?Tn:pt;return e.writeUInt16BE(r.id||0,n),e.writeUInt16BE(t|i,n+2),e.writeUInt16BE(r.questions.length,n+4),e.writeUInt16BE(r.answers.length,n+6),e.writeUInt16BE(r.authorities.length,n+8),e.writeUInt16BE(r.additionals.length,n+10),e};B.encode.bytes=12;B.decode=function(r,e){if(e||(e=0),r.length<12)throw new Error("Header must be 12 bytes");let n=r.readUInt16BE(e+2);return{id:r.readUInt16BE(e),type:n&Tn?"response":"query",flags:n&32767,flag_qr:(n>>15&1)===1,opcode:gt.toString(n>>11&15),flag_aa:(n>>10&1)===1,flag_tc:(n>>9&1)===1,flag_rd:(n>>8&1)===1,flag_ra:(n>>7&1)===1,flag_z:(n>>6&1)===1,flag_ad:(n>>5&1)===1,flag_cd:(n>>4&1)===1,rcode:ht.toString(n&15),questions:new Array(r.readUInt16BE(e+4)),answers:new Array(r.readUInt16BE(e+6)),authorities:new Array(r.readUInt16BE(e+8)),additionals:new Array(r.readUInt16BE(e+10))}};B.decode.bytes=12;B.encodingLength=function(){return 12};var X=v.unknown={};X.encode=function(r,e,n){return e||(e=w.alloc(X.encodingLength(r))),n||(n=0),e.writeUInt16BE(r.length,n),r.copy(e,n+2),X.encode.bytes=r.length+2,e};X.encode.bytes=0;X.decode=function(r,e){e||(e=0);let n=r.readUInt16BE(e),t=r.slice(e+2,e+2+n);return X.decode.bytes=n+2,t};X.decode.bytes=0;X.encodingLength=function(r){return r.length+2};var W=v.ns={};W.encode=function(r,e,n){return e||(e=w.alloc(W.encodingLength(r))),n||(n=0),p.encode(r,e,n+2),e.writeUInt16BE(p.encode.bytes,n),W.encode.bytes=p.encode.bytes+2,e};W.encode.bytes=0;W.decode=function(r,e){e||(e=0);let n=r.readUInt16BE(e),t=p.decode(r,e+2);return W.decode.bytes=n+2,t};W.decode.bytes=0;W.encodingLength=function(r){return p.encodingLength(r)+2};var G=v.soa={};G.encode=function(r,e,n){e||(e=w.alloc(G.encodingLength(r))),n||(n=0);let t=n;return n+=2,p.encode(r.mname,e,n),n+=p.encode.bytes,p.encode(r.rname,e,n,{mail:!0}),n+=p.encode.bytes,e.writeUInt32BE(r.serial||0,n),n+=4,e.writeUInt32BE(r.refresh||0,n),n+=4,e.writeUInt32BE(r.retry||0,n),n+=4,e.writeUInt32BE(r.expire||0,n),n+=4,e.writeUInt32BE(r.minimum||0,n),n+=4,e.writeUInt16BE(n-t-2,t),G.encode.bytes=n-t,e};G.encode.bytes=0;G.decode=function(r,e){e||(e=0);let n=e,t={};return e+=2,t.mname=p.decode(r,e),e+=p.decode.bytes,t.rname=p.decode(r,e,{mail:!0}),e+=p.decode.bytes,t.serial=r.readUInt32BE(e),e+=4,t.refresh=r.readUInt32BE(e),e+=4,t.retry=r.readUInt32BE(e),e+=4,t.expire=r.readUInt32BE(e),e+=4,t.minimum=r.readUInt32BE(e),e+=4,G.decode.bytes=e-n,t};G.decode.bytes=0;G.encodingLength=function(r){return 22+p.encodingLength(r.mname)+p.encodingLength(r.rname)};var Q=v.txt={};Q.encode=function(r,e,n){Array.isArray(r)||(r=[r]);for(let i=0;i<r.length;i++)if(typeof r[i]=="string"&&(r[i]=w.from(r[i])),!w.isBuffer(r[i]))throw new Error("Must be a Buffer");e||(e=w.alloc(Q.encodingLength(r))),n||(n=0);let t=n;return n+=2,r.forEach(function(i){e[n++]=i.length,i.copy(e,n,0,i.length),n+=i.length}),e.writeUInt16BE(n-t-2,t),Q.encode.bytes=n-t,e};Q.encode.bytes=0;Q.decode=function(r,e){e||(e=0);let n=e,t=r.readUInt16BE(e);e+=2;let i=[];for(;t>0;){let s=r[e++];if(--t,t<s)throw new Error("Buffer overflow");i.push(r.slice(e,e+s)),e+=s,t-=s}return Q.decode.bytes=e-n,i};Q.decode.bytes=0;Q.encodingLength=function(r){Array.isArray(r)||(r=[r]);let e=2;return r.forEach(function(n){typeof n=="string"?e+=w.byteLength(n)+1:e+=n.length+1}),e};var J=v.null={};J.encode=function(r,e,n){e||(e=w.alloc(J.encodingLength(r))),n||(n=0),typeof r=="string"&&(r=w.from(r)),r||(r=w.alloc(0));let t=n;n+=2;let i=r.length;return r.copy(e,n,0,i),n+=i,e.writeUInt16BE(n-t-2,t),J.encode.bytes=n-t,e};J.encode.bytes=0;J.decode=function(r,e){e||(e=0);let n=e,t=r.readUInt16BE(e);e+=2;let i=r.slice(e,e+t);return e+=t,J.decode.bytes=e-n,i};J.decode.bytes=0;J.encodingLength=function(r){return r?(w.isBuffer(r)?r.length:w.byteLength(r))+2:2};var Z=v.hinfo={};Z.encode=function(r,e,n){e||(e=w.alloc(Z.encodingLength(r))),n||(n=0);let t=n;return n+=2,E.encode(r.cpu,e,n),n+=E.encode.bytes,E.encode(r.os,e,n),n+=E.encode.bytes,e.writeUInt16BE(n-t-2,t),Z.encode.bytes=n-t,e};Z.encode.bytes=0;Z.decode=function(r,e){e||(e=0);let n=e,t={};return e+=2,t.cpu=E.decode(r,e),e+=E.decode.bytes,t.os=E.decode(r,e),e+=E.decode.bytes,Z.decode.bytes=e-n,t};Z.decode.bytes=0;Z.encodingLength=function(r){return E.encodingLength(r.cpu)+E.encodingLength(r.os)+2};var _=v.ptr={},vt=v.cname=_,wt=v.dname=_;_.encode=function(r,e,n){return e||(e=w.alloc(_.encodingLength(r))),n||(n=0),p.encode(r,e,n+2),e.writeUInt16BE(p.encode.bytes,n),_.encode.bytes=p.encode.bytes+2,e};_.encode.bytes=0;_.decode=function(r,e){e||(e=0);let n=p.decode(r,e+2);return _.decode.bytes=p.decode.bytes+2,n};_.decode.bytes=0;_.encodingLength=function(r){return p.encodingLength(r)+2};var f=v.srv={};f.encode=function(r,e,n){e||(e=w.alloc(f.encodingLength(r))),n||(n=0),e.writeUInt16BE(r.priority||0,n+2),e.writeUInt16BE(r.weight||0,n+4),e.writeUInt16BE(r.port||0,n+6),p.encode(r.target,e,n+8);let t=p.encode.bytes+6;return e.writeUInt16BE(t,n),f.encode.bytes=t+2,e};f.encode.bytes=0;f.decode=function(r,e){e||(e=0);let n=r.readUInt16BE(e),t={};return t.priority=r.readUInt16BE(e+2),t.weight=r.readUInt16BE(e+4),t.port=r.readUInt16BE(e+6),t.target=p.decode(r,e+8),f.decode.bytes=n+2,t};f.decode.bytes=0;f.encodingLength=function(r){return 8+p.encodingLength(r.target)};var T=v.caa={};T.ISSUER_CRITICAL=1<<7;T.encode=function(r,e,n){let t=T.encodingLength(r);return e||(e=w.alloc(T.encodingLength(r))),n||(n=0),r.issuerCritical&&(r.flags=T.ISSUER_CRITICAL),e.writeUInt16BE(t-2,n),n+=2,e.writeUInt8(r.flags||0,n),n+=1,E.encode(r.tag,e,n),n+=E.encode.bytes,e.write(r.value,n),n+=w.byteLength(r.value),T.encode.bytes=t,e};T.encode.bytes=0;T.decode=function(r,e){e||(e=0);let n=r.readUInt16BE(e);e+=2;let t=e,i={};return i.flags=r.readUInt8(e),e+=1,i.tag=E.decode(r,e),e+=E.decode.bytes,i.value=r.toString("utf-8",e,t+n),i.issuerCritical=!!(i.flags&T.ISSUER_CRITICAL),T.decode.bytes=n+2,i};T.decode.bytes=0;T.encodingLength=function(r){return E.encodingLength(r.tag)+E.encodingLength(r.value)+2};var ie=v.mx={};ie.encode=function(r,e,n){e||(e=w.alloc(ie.encodingLength(r))),n||(n=0);let t=n;return n+=2,e.writeUInt16BE(r.preference||0,n),n+=2,p.encode(r.exchange,e,n),n+=p.encode.bytes,e.writeUInt16BE(n-t-2,t),ie.encode.bytes=n-t,e};ie.encode.bytes=0;ie.decode=function(r,e){e||(e=0);let n=e,t={};return e+=2,t.preference=r.readUInt16BE(e),e+=2,t.exchange=p.decode(r,e),e+=p.decode.bytes,ie.decode.bytes=e-n,t};ie.encodingLength=function(r){return 4+p.encodingLength(r.exchange)};var ee=v.a={};ee.encode=function(r,e,n){return e||(e=w.alloc(ee.encodingLength(r))),n||(n=0),e.writeUInt16BE(4,n),n+=2,de.v4.encode(r,e,n),ee.encode.bytes=6,e};ee.encode.bytes=0;ee.decode=function(r,e){e||(e=0),e+=2;let n=de.v4.decode(r,e);return ee.decode.bytes=6,n};ee.decode.bytes=0;ee.encodingLength=function(){return 6};var ne=v.aaaa={};ne.encode=function(r,e,n){return e||(e=w.alloc(ne.encodingLength(r))),n||(n=0),e.writeUInt16BE(16,n),n+=2,de.v6.encode(r,e,n),ne.encode.bytes=18,e};ne.encode.bytes=0;ne.decode=function(r,e){e||(e=0),e+=2;let n=de.v6.decode(r,e);return ne.decode.bytes=18,n};ne.decode.bytes=0;ne.encodingLength=function(){return 18};var F=v.option={};F.encode=function(r,e,n){e||(e=w.alloc(F.encodingLength(r))),n||(n=0);let t=n,i=Qe.toCode(r.code);if(e.writeUInt16BE(i,n),n+=2,r.data)e.writeUInt16BE(r.data.length,n),n+=2,r.data.copy(e,n),n+=r.data.length;else switch(i){case 8:let s=r.sourcePrefixLength||0,a=r.family||de.familyOf(r.ip),o=de.encode(r.ip,w.alloc),c=Math.ceil(s/8);e.writeUInt16BE(c+4,n),n+=2,e.writeUInt16BE(a,n),n+=2,e.writeUInt8(s,n++),e.writeUInt8(r.scopePrefixLength||0,n++),o.copy(e,n,0,c),n+=c;break;case 11:r.timeout?(e.writeUInt16BE(2,n),n+=2,e.writeUInt16BE(r.timeout,n),n+=2):(e.writeUInt16BE(0,n),n+=2);break;case 12:let h=r.length||0;e.writeUInt16BE(h,n),n+=2,e.fill(0,n,n+h),n+=h;break;case 14:let m=r.tags.length*2;e.writeUInt16BE(m,n),n+=2;for(let l of r.tags)e.writeUInt16BE(l,n),n+=2;break;default:throw new Error(`Unknown roption code: ${r.code}`)}return F.encode.bytes=n-t,e};F.encode.bytes=0;F.decode=function(r,e){e||(e=0);let n={};n.code=r.readUInt16BE(e),n.type=Qe.toString(n.code),e+=2;let t=r.readUInt16BE(e);switch(e+=2,n.data=r.slice(e,e+t),n.code){case 8:n.family=r.readUInt16BE(e),e+=2,n.sourcePrefixLength=r.readUInt8(e++),n.scopePrefixLength=r.readUInt8(e++);let i=w.alloc(n.family===1?4:16);r.copy(i,0,e,e+t-4),n.ip=de.decode(i);break;case 11:t>0&&(n.timeout=r.readUInt16BE(e),e+=2);break;case 14:n.tags=[];for(let s=0;s<t;s+=2)n.tags.push(r.readUInt16BE(e)),e+=2}return F.decode.bytes=t+4,n};F.decode.bytes=0;F.encodingLength=function(r){if(r.data)return r.data.length+4;switch(Qe.toCode(r.code)){case 8:let n=r.sourcePrefixLength||0;return Math.ceil(n/8)+8;case 11:return typeof r.timeout=="number"?6:4;case 12:return r.length+4;case 14:return 4+r.tags.length*2}throw new Error(`Unknown roption code: ${r.code}`)};var L=v.opt={};L.encode=function(r,e,n){e||(e=w.alloc(L.encodingLength(r))),n||(n=0);let t=n,i=pe(r,F);return e.writeUInt16BE(i,n),n=Se(r,F,e,n+2),L.encode.bytes=n-t,e};L.encode.bytes=0;L.decode=function(r,e){e||(e=0);let n=e,t=[],i=r.readUInt16BE(e);e+=2;let s=0;for(;i>0;)t[s++]=F.decode(r,e),e+=F.decode.bytes,i-=F.decode.bytes;return L.decode.bytes=e-n,t};L.decode.bytes=0;L.encodingLength=function(r){return 2+pe(r||[],F)};var O=v.dnskey={};O.PROTOCOL_DNSSEC=3;O.ZONE_KEY=128;O.SECURE_ENTRYPOINT=32768;O.encode=function(r,e,n){e||(e=w.alloc(O.encodingLength(r))),n||(n=0);let t=n,i=r.key;if(!w.isBuffer(i))throw new Error("Key must be a Buffer");return n+=2,e.writeUInt16BE(r.flags,n),n+=2,e.writeUInt8(O.PROTOCOL_DNSSEC,n),n+=1,e.writeUInt8(r.algorithm,n),n+=1,i.copy(e,n,0,i.length),n+=i.length,O.encode.bytes=n-t,e.writeUInt16BE(O.encode.bytes-2,t),e};O.encode.bytes=0;O.decode=function(r,e){e||(e=0);let n=e;var t={},i=r.readUInt16BE(e);if(e+=2,t.flags=r.readUInt16BE(e),e+=2,r.readUInt8(e)!==O.PROTOCOL_DNSSEC)throw new Error("Protocol must be 3");return e+=1,t.algorithm=r.readUInt8(e),e+=1,t.key=r.slice(e,n+i+2),e+=t.key.length,O.decode.bytes=e-n,t};O.decode.bytes=0;O.encodingLength=function(r){return 6+w.byteLength(r.key)};var b=v.rrsig={};b.encode=function(r,e,n){e||(e=w.alloc(b.encodingLength(r))),n||(n=0);let t=n,i=r.signature;if(!w.isBuffer(i))throw new Error("Signature must be a Buffer");return n+=2,e.writeUInt16BE(te.toType(r.typeCovered),n),n+=2,e.writeUInt8(r.algorithm,n),n+=1,e.writeUInt8(r.labels,n),n+=1,e.writeUInt32BE(r.originalTTL,n),n+=4,e.writeUInt32BE(r.expiration,n),n+=4,e.writeUInt32BE(r.inception,n),n+=4,e.writeUInt16BE(r.keyTag,n),n+=2,p.encode(r.signersName,e,n),n+=p.encode.bytes,i.copy(e,n,0,i.length),n+=i.length,b.encode.bytes=n-t,e.writeUInt16BE(b.encode.bytes-2,t),e};b.encode.bytes=0;b.decode=function(r,e){e||(e=0);let n=e;var t={},i=r.readUInt16BE(e);return e+=2,t.typeCovered=te.toString(r.readUInt16BE(e)),e+=2,t.algorithm=r.readUInt8(e),e+=1,t.labels=r.readUInt8(e),e+=1,t.originalTTL=r.readUInt32BE(e),e+=4,t.expiration=r.readUInt32BE(e),e+=4,t.inception=r.readUInt32BE(e),e+=4,t.keyTag=r.readUInt16BE(e),e+=2,t.signersName=p.decode(r,e),e+=p.decode.bytes,t.signature=r.slice(e,n+i+2),e+=t.signature.length,b.decode.bytes=e-n,t};b.decode.bytes=0;b.encodingLength=function(r){return 20+p.encodingLength(r.signersName)+w.byteLength(r.signature)};var x=v.rp={};x.encode=function(r,e,n){e||(e=w.alloc(x.encodingLength(r))),n||(n=0);let t=n;return n+=2,p.encode(r.mbox||".",e,n,{mail:!0}),n+=p.encode.bytes,p.encode(r.txt||".",e,n),n+=p.encode.bytes,x.encode.bytes=n-t,e.writeUInt16BE(x.encode.bytes-2,t),e};x.encode.bytes=0;x.decode=function(r,e){e||(e=0);let n=e,t={};return e+=2,t.mbox=p.decode(r,e,{mail:!0})||".",e+=p.decode.bytes,t.txt=p.decode(r,e)||".",e+=p.decode.bytes,x.decode.bytes=e-n,t};x.decode.bytes=0;x.encodingLength=function(r){return 2+p.encodingLength(r.mbox||".")+p.encodingLength(r.txt||".")};var C={};C.encode=function(r,e,n){e||(e=w.alloc(C.encodingLength(r))),n||(n=0);let t=n;for(var i=[],s=0;s<r.length;s++){var a=te.toType(r[s]);i[a>>8]===void 0&&(i[a>>8]=[]),i[a>>8][a>>3&31]|=1<<7-(a&7)}for(s=0;s<i.length;s++)if(i[s]!==void 0){var o=w.from(i[s]);e.writeUInt8(s,n),n+=1,e.writeUInt8(o.length,n),n+=1,o.copy(e,n),n+=o.length}return C.encode.bytes=n-t,e};C.encode.bytes=0;C.decode=function(r,e,n){e||(e=0);let t=e;for(var i=[];e-t<n;){var s=r.readUInt8(e);e+=1;var a=r.readUInt8(e);e+=1;for(var o=0;o<a;o++)for(var c=r.readUInt8(e+o),h=0;h<8;h++)if(c&1<<7-h){var m=te.toString(s<<8|o<<3|h);i.push(m)}e+=a}return C.decode.bytes=e-t,i};C.decode.bytes=0;C.encodingLength=function(r){for(var e=[],n=0;n<r.length;n++){var t=te.toType(r[n]);e[t>>8]=Math.max(e[t>>8]||0,t&255)}var i=0;for(n=0;n<e.length;n++)e[n]!==void 0&&(i+=2+Math.ceil((e[n]+1)/8));return i};var q=v.nsec={};q.encode=function(r,e,n){e||(e=w.alloc(q.encodingLength(r))),n||(n=0);let t=n;return n+=2,p.encode(r.nextDomain,e,n),n+=p.encode.bytes,C.encode(r.rrtypes,e,n),n+=C.encode.bytes,q.encode.bytes=n-t,e.writeUInt16BE(q.encode.bytes-2,t),e};q.encode.bytes=0;q.decode=function(r,e){e||(e=0);let n=e;var t={},i=r.readUInt16BE(e);return e+=2,t.nextDomain=p.decode(r,e),e+=p.decode.bytes,t.rrtypes=C.decode(r,e,i-(e-n)),e+=C.decode.bytes,q.decode.bytes=e-n,t};q.decode.bytes=0;q.encodingLength=function(r){return 2+p.encodingLength(r.nextDomain)+C.encodingLength(r.rrtypes)};var z=v.nsec3={};z.encode=function(r,e,n){e||(e=w.alloc(z.encodingLength(r))),n||(n=0);let t=n,i=r.salt;if(!w.isBuffer(i))throw new Error("salt must be a Buffer");let s=r.nextDomain;if(!w.isBuffer(s))throw new Error("nextDomain must be a Buffer");return n+=2,e.writeUInt8(r.algorithm,n),n+=1,e.writeUInt8(r.flags,n),n+=1,e.writeUInt16BE(r.iterations,n),n+=2,e.writeUInt8(i.length,n),n+=1,i.copy(e,n,0,i.length),n+=i.length,e.writeUInt8(s.length,n),n+=1,s.copy(e,n,0,s.length),n+=s.length,C.encode(r.rrtypes,e,n),n+=C.encode.bytes,z.encode.bytes=n-t,e.writeUInt16BE(z.encode.bytes-2,t),e};z.encode.bytes=0;z.decode=function(r,e){e||(e=0);let n=e;var t={},i=r.readUInt16BE(e);e+=2,t.algorithm=r.readUInt8(e),e+=1,t.flags=r.readUInt8(e),e+=1,t.iterations=r.readUInt16BE(e),e+=2;let s=r.readUInt8(e);e+=1,t.salt=r.slice(e,e+s),e+=s;let a=r.readUInt8(e);return e+=1,t.nextDomain=r.slice(e,e+a),e+=a,t.rrtypes=C.decode(r,e,i-(e-n)),e+=C.decode.bytes,z.decode.bytes=e-n,t};z.decode.bytes=0;z.encodingLength=function(r){return 8+r.salt.length+r.nextDomain.length+C.encodingLength(r.rrtypes)};var V=v.ds={};V.encode=function(r,e,n){e||(e=w.alloc(V.encodingLength(r))),n||(n=0);let t=n,i=r.digest;if(!w.isBuffer(i))throw new Error("Digest must be a Buffer");return n+=2,e.writeUInt16BE(r.keyTag,n),n+=2,e.writeUInt8(r.algorithm,n),n+=1,e.writeUInt8(r.digestType,n),n+=1,i.copy(e,n,0,i.length),n+=i.length,V.encode.bytes=n-t,e.writeUInt16BE(V.encode.bytes-2,t),e};V.encode.bytes=0;V.decode=function(r,e){e||(e=0);let n=e;var t={},i=r.readUInt16BE(e);return e+=2,t.keyTag=r.readUInt16BE(e),e+=2,t.algorithm=r.readUInt8(e),e+=1,t.digestType=r.readUInt8(e),e+=1,t.digest=r.slice(e,n+i+2),e+=t.digest.length,V.decode.bytes=e-n,t};V.decode.bytes=0;V.encodingLength=function(r){return 6+w.byteLength(r.digest)};var I=v.sshfp={};I.getFingerprintLengthForHashType=function(e){switch(e){case 1:return 20;case 2:return 32}};I.encode=function(e,n,t){n||(n=w.alloc(I.encodingLength(e))),t||(t=0);let i=t;t+=2,n[t]=e.algorithm,t+=1,n[t]=e.hash,t+=1;let s=w.from(e.fingerprint.toUpperCase(),"hex");if(s.length!==I.getFingerprintLengthForHashType(e.hash))throw new Error("Invalid fingerprint length");return s.copy(n,t),t+=s.byteLength,I.encode.bytes=t-i,n.writeUInt16BE(I.encode.bytes-2,i),n};I.encode.bytes=0;I.decode=function(e,n){n||(n=0);let t=n,i={};n+=2,i.algorithm=e[n],n+=1,i.hash=e[n],n+=1;let s=I.getFingerprintLengthForHashType(i.hash);return i.fingerprint=e.slice(n,n+s).toString("hex").toUpperCase(),n+=s,I.decode.bytes=n-t,i};I.decode.bytes=0;I.encodingLength=function(r){return 4+w.from(r.fingerprint,"hex").byteLength};var H=v.naptr={};H.encode=function(r,e,n){e||(e=w.alloc(H.encodingLength(r))),n||(n=0);let t=n;return n+=2,e.writeUInt16BE(r.order||0,n),n+=2,e.writeUInt16BE(r.preference||0,n),n+=2,E.encode(r.flags,e,n),n+=E.encode.bytes,E.encode(r.services,e,n),n+=E.encode.bytes,E.encode(r.regexp,e,n),n+=E.encode.bytes,p.encode(r.replacement,e,n),n+=p.encode.bytes,H.encode.bytes=n-t,e.writeUInt16BE(H.encode.bytes-2,t),e};H.encode.bytes=0;H.decode=function(r,e){e||(e=0);let n=e,t={};return e+=2,t.order=r.readUInt16BE(e),e+=2,t.preference=r.readUInt16BE(e),e+=2,t.flags=E.decode(r,e),e+=E.decode.bytes,t.services=E.decode(r,e),e+=E.decode.bytes,t.regexp=E.decode(r,e),e+=E.decode.bytes,t.replacement=p.decode(r,e),e+=p.decode.bytes,H.decode.bytes=e-n,t};H.decode.bytes=0;H.encodingLength=function(r){return E.encodingLength(r.flags)+E.encodingLength(r.services)+E.encodingLength(r.regexp)+p.encodingLength(r.replacement)+6};var j=v.tlsa={};j.encode=function(r,e,n){e||(e=w.alloc(j.encodingLength(r))),n||(n=0);let t=n,i=r.certificate;if(!w.isBuffer(i))throw new Error("Certificate must be a Buffer");return n+=2,e.writeUInt8(r.usage,n),n+=1,e.writeUInt8(r.selector,n),n+=1,e.writeUInt8(r.matchingType,n),n+=1,i.copy(e,n,0,i.length),n+=i.length,j.encode.bytes=n-t,e.writeUInt16BE(j.encode.bytes-2,t),e};j.encode.bytes=0;j.decode=function(r,e){e||(e=0);let n=e,t={},i=r.readUInt16BE(e);return e+=2,t.usage=r.readUInt8(e),e+=1,t.selector=r.readUInt8(e),e+=1,t.matchingType=r.readUInt8(e),e+=1,t.certificate=r.slice(e,n+i+2),e+=t.certificate.length,j.decode.bytes=e-n,t};j.decode.bytes=0;j.encodingLength=function(r){return 5+w.byteLength(r.certificate)};var Ze=v.record=function(r){switch(r.toUpperCase()){case"A":return ee;case"PTR":return _;case"CNAME":return vt;case"DNAME":return wt;case"TXT":return Q;case"NULL":return J;case"AAAA":return ne;case"SRV":return f;case"HINFO":return Z;case"CAA":return T;case"NS":return W;case"SOA":return G;case"MX":return ie;case"OPT":return L;case"DNSKEY":return O;case"RRSIG":return b;case"RP":return x;case"NSEC":return q;case"NSEC3":return z;case"SSHFP":return I;case"DS":return V;case"NAPTR":return H;case"TLSA":return j}return X},D=v.answer={};D.encode=function(r,e,n){e||(e=w.alloc(D.encodingLength(r))),n||(n=0);let t=n;if(p.encode(r.name,e,n),n+=p.encode.bytes,e.writeUInt16BE(te.toType(r.type),n),r.type.toUpperCase()==="OPT"){if(r.name!==".")throw new Error("OPT name must be root.");e.writeUInt16BE(r.udpPayloadSize||4096,n+2),e.writeUInt8(r.extendedRcode||0,n+4),e.writeUInt8(r.ednsVersion||0,n+5),e.writeUInt16BE(r.flags||0,n+6),n+=8,L.encode(r.options||[],e,n),n+=L.encode.bytes}else{let i=Ne.toClass(r.class===void 0?"IN":r.class);r.flush&&(i|=Je),e.writeUInt16BE(i,n+2),e.writeUInt32BE(r.ttl||0,n+4),n+=8;let s=Ze(r.type);s.encode(r.data,e,n),n+=s.encode.bytes}return D.encode.bytes=n-t,e};D.encode.bytes=0;D.decode=function(r,e){e||(e=0);let n={},t=e;if(n.name=p.decode(r,e),e+=p.decode.bytes,n.type=te.toString(r.readUInt16BE(e)),n.type==="OPT")n.udpPayloadSize=r.readUInt16BE(e+2),n.extendedRcode=r.readUInt8(e+4),n.ednsVersion=r.readUInt8(e+5),n.flags=r.readUInt16BE(e+6),n.flag_do=(n.flags>>15&1)===1,n.options=L.decode(r,e+8),e+=8+L.decode.bytes;else{let i=r.readUInt16BE(e+2);n.ttl=r.readUInt32BE(e+4),n.class=Ne.toString(i&mt),n.flush=!!(i&Je);let s=Ze(n.type);n.data=s.decode(r,e+8),e+=8+s.decode.bytes}return D.decode.bytes=e-t,n};D.decode.bytes=0;D.encodingLength=function(r){let e=r.data!==null&&r.data!==void 0?r.data:r.options;return p.encodingLength(r.name)+8+Ze(r.type).encodingLength(e)};var A=v.question={};A.encode=function(r,e,n){e||(e=w.alloc(A.encodingLength(r))),n||(n=0);let t=n;return p.encode(r.name,e,n),n+=p.encode.bytes,e.writeUInt16BE(te.toType(r.type),n),n+=2,e.writeUInt16BE(Ne.toClass(r.class===void 0?"IN":r.class),n),n+=2,A.encode.bytes=n-t,r};A.encode.bytes=0;A.decode=function(r,e){e||(e=0);let n=e,t={};return t.name=p.decode(r,e),e+=p.decode.bytes,t.type=te.toString(r.readUInt16BE(e)),e+=2,t.class=Ne.toString(r.readUInt16BE(e)),e+=2,!!(t.class&In)&&(t.class&=yt),A.decode.bytes=e-n,t};A.decode.bytes=0;A.encodingLength=function(r){return p.encodingLength(r.name)+4};v.AUTHORITATIVE_ANSWER=1<<10;v.TRUNCATED_RESPONSE=1<<9;v.RECURSION_DESIRED=1<<8;v.RECURSION_AVAILABLE=1<<7;v.AUTHENTIC_DATA=1<<5;v.CHECKING_DISABLED=1<<4;v.DNSSEC_OK=1<<15;v.encode=function(r,e,n){let t=!e;t&&(e=w.alloc(v.encodingLength(r))),n||(n=0);let i=n;return r.questions||(r.questions=[]),r.answers||(r.answers=[]),r.authorities||(r.authorities=[]),r.additionals||(r.additionals=[]),B.encode(r,e,n),n+=B.encode.bytes,n=Se(r.questions,A,e,n),n=Se(r.answers,D,e,n),n=Se(r.authorities,D,e,n),n=Se(r.additionals,D,e,n),v.encode.bytes=n-i,t&&v.encode.bytes!==e.length?e.slice(0,v.encode.bytes):e};v.encode.bytes=0;v.decode=function(r,e){e||(e=0);let n=e,t=B.decode(r,e);return e+=B.decode.bytes,e=Pe(t.questions,A,r,e),e=Pe(t.answers,D,r,e),e=Pe(t.authorities,D,r,e),e=Pe(t.additionals,D,r,e),v.decode.bytes=e-n,t};v.decode.bytes=0;v.encodingLength=function(r){return B.encodingLength(r)+pe(r.questions||[],A)+pe(r.answers||[],D)+pe(r.authorities||[],D)+pe(r.additionals||[],D)};v.streamEncode=function(r){let e=v.encode(r),n=w.alloc(2);n.writeUInt16BE(e.byteLength);let t=w.concat([n,e]);return v.streamEncode.bytes=t.byteLength,t};v.streamEncode.bytes=0;v.streamDecode=function(r){let e=r.readUInt16BE(0);if(r.byteLength<e+2)return null;let n=v.decode(r.slice(2));return v.streamDecode.bytes=v.decode.bytes,n};v.streamDecode.bytes=0;function pe(r,e){let n=0;for(let t=0;t<r.length;t++)n+=e.encodingLength(r[t]);return n}function Se(r,e,n,t){for(let i=0;i<r.length;i++)e.encode(r[i],n,t),t+=e.encode.bytes;return t}function Pe(r,e,n,t){for(let i=0;i<r.length;i++)r[i]=e.decode(n,t),t+=e.decode.bytes;return t}});var _n=k((ar,Nn)=>{"use strict";var Pn=Ct;process.nextTick($t,42);Nn.exports=Et;function Et(r){var e=t;return n;function n(i){e(i||Ut)}function t(i){var s=[i];e=a,r(o);function a(c){s.push(c)}function o(c){var h=arguments;for(e=St(c)?t:m;s.length;)m(s.shift());function m(l){Pn(kt,l,h)}}}}function St(r){return Object.prototype.toString.call(r)==="[object Error]"}function Ut(){}function kt(r,e){r.apply(null,e)}function $t(r){r===42&&(Pn=process.nextTick)}function Ct(r,e,n){process.nextTick(function(){r(e,n)})}});var Rn=k((or,Bn)=>{var fe=Ln(),Dt=require("dgram"),Ot=_n(),Ft=require("events"),nn=require("os"),en=function(){};Bn.exports=function(r){r||(r={});var e=new Ft.EventEmitter,n=typeof r.port=="number"?r.port:5353,t=r.type||"udp4",i=r.ip||r.host||(t==="udp4"?"224.0.0.251":null),s={address:i,port:n},a={},o=!1,c=null;if(t==="udp6"&&(!i||!r.interface))throw new Error("For IPv6 multicast you must specify `ip` and `interface`");var h=r.socket||Dt.createSocket({type:t,reuseAddr:r.reuseAddr!==!1,toString:function(){return t}});h.on("error",function(l){l.code==="EACCES"||l.code==="EADDRINUSE"?e.emit("error",l):e.emit("warning",l)}),h.on("message",function(l,g){try{l=fe.decode(l)}catch(u){e.emit("warning",u);return}e.emit("packet",l,g),l.type==="query"&&e.emit("query",l,g),l.type==="response"&&e.emit("response",l,g)}),h.on("listening",function(){n||(n=s.port=h.address().port),r.multicast!==!1&&(e.update(),c=setInterval(e.update,5e3),h.setMulticastTTL(r.ttl||255),h.setMulticastLoopback(r.loopback!==!1))});var m=Ot(function(l){if(!n||r.bind===!1)return l(null);h.once("error",l),h.bind(n,r.bind||r.interface,function(){h.removeListener("error",l),l(null)})});return m(function(l){if(l)return e.emit("error",l);e.emit("ready")}),e.send=function(l,g,u){if(typeof g=="function")return e.send(l,null,g);u||(u=en),g?!g.host&&!g.address&&(g.address=s.address):g=s,m(d);function d(y){if(o)return u();if(y)return u(y);var U=fe.encode(l);h.send(U,0,U.length,g.port,g.address||g.host,u)}},e.response=e.respond=function(l,g,u){Array.isArray(l)&&(l={answers:l}),l.type="response",l.flags=(l.flags||0)|fe.AUTHORITATIVE_ANSWER,e.send(l,g,u)},e.query=function(l,g,u,d){if(typeof g=="function")return e.query(l,null,null,g);if(typeof g=="object"&&g&&g.port)return e.query(l,null,g,u);if(typeof u=="function")return e.query(l,g,null,u);d||(d=en),typeof l=="string"&&(l=[{name:l,type:g||"ANY"}]),Array.isArray(l)&&(l={type:"query",questions:l}),l.type="query",e.send(l,u,d)},e.destroy=function(l){if(l||(l=en),o)return process.nextTick(l);o=!0,clearInterval(c);for(var g in a)try{h.dropMembership(i,g)}catch(u){}a={},h.close(l)},e.update=function(){for(var l=r.interface?[].concat(r.interface):It(),g=!1,u=0;u<l.length;u++){var d=l[u];if(!a[d])try{h.addMembership(i,d),a[d]=!0,g=!0}catch(y){e.emit("warning",y)}}if(g){if(h.setMulticastInterface)try{h.setMulticastInterface(r.interface||Tt())}catch(y){e.emit("warning",y)}e.emit("networkInterface")}},e};function Tt(){for(var r=nn.networkInterfaces(),e=Object.keys(r),n=0;n<e.length;n++)for(var t=r[e[n]],i=0;i<t.length;i++){var s=t[i];if(An(s.family)&&!s.internal)return nn.platform()==="darwin"&&e[n]==="en0"?s.address:"0.0.0.0"}return"127.0.0.1"}function It(){for(var r=nn.networkInterfaces(),e=Object.keys(r),n=[],t=0;t<e.length;t++)for(var i=r[e[t]],s=0;s<i.length;s++){var a=i[s];if(An(a.family)){n.push(a.address);break}}return n}function An(r){return r===4||r==="IPv4"}});var bn=k((cr,Mn)=>{"use strict";Mn.exports=function r(e,n){if(e===n)return!0;if(e&&n&&typeof e=="object"&&typeof n=="object"){if(e.constructor!==n.constructor)return!1;var t,i,s;if(Array.isArray(e)){if(t=e.length,t!=n.length)return!1;for(i=t;i--!==0;)if(!r(e[i],n[i]))return!1;return!0}if(e instanceof Map&&n instanceof Map){if(e.size!==n.size)return!1;for(i of e.entries())if(!n.has(i[0]))return!1;for(i of e.entries())if(!r(i[1],n.get(i[0])))return!1;return!0}if(e instanceof Set&&n instanceof Set){if(e.size!==n.size)return!1;for(i of e.entries())if(!n.has(i[0]))return!1;return!0}if(ArrayBuffer.isView(e)&&ArrayBuffer.isView(n)){if(t=e.length,t!=n.length)return!1;for(i=t;i--!==0;)if(e[i]!==n[i])return!1;return!0}if(e.constructor===RegExp)return e.source===n.source&&e.flags===n.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===n.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===n.toString();if(s=Object.keys(e),t=s.length,t!==Object.keys(n).length)return!1;for(i=t;i--!==0;)if(!Object.prototype.hasOwnProperty.call(n,s[i]))return!1;for(i=t;i--!==0;){var a=s[i];if(!r(e[a],n[a]))return!1}return!0}return e!==e&&n!==n}});var xn=k(ue=>{"use strict";var tn=ue&&ue.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ue,"__esModule",{value:!0});ue.Server=void 0;var Lt=tn(Rn()),Pt=tn(bn()),Nt=tn(Oe()),_e=class{constructor(e,n){this.registry={},this.mdns=(0,Lt.default)(e),this.mdns.setMaxListeners(0),this.mdns.on("query",this.respondToQuery.bind(this)),this.errorCallback=n!=null?n:function(t){throw t}}register(e){let n=t=>{var i=this.registry[t.type];if(!i)i=this.registry[t.type]=[];else if(i.some(this.isDuplicateRecord(t)))return;i.push(t)};Array.isArray(e)?e.forEach(n):n(e)}unregister(e){let n=t=>{let i=t.type;i in this.registry&&(this.registry[i]=this.registry[i].filter(s=>s.name!==t.name))};Array.isArray(e)?e.forEach(n):n(e)}respondToQuery(e){let n=this;e.questions.forEach(t=>{var i=t.type,s=t.name,a=i==="ANY"?Object.keys(n.registry).map(n.recordsFor.bind(n,s)).flat(1):n.recordsFor(s,i);if(a.length!==0){var o=[];i!=="ANY"&&(a.forEach(c=>{c.type==="PTR"&&(o=o.concat(n.recordsFor(c.data,"SRV")).concat(n.recordsFor(c.data,"TXT")))}),o.filter(function(c){return c.type==="SRV"}).map(function(c){return c.data.target}).filter(this.unique()).forEach(function(c){o=o.concat(n.recordsFor(c,"A")).concat(n.recordsFor(c,"AAAA"))})),n.mdns.respond({answers:a,additionals:o},c=>{c&&this.errorCallback(c)})}})}recordsFor(e,n){return n in this.registry?this.registry[n].filter(t=>{var i=~e.indexOf(".")?t.name:t.name.split(".")[0];return(0,Nt.default)(i,e)}):[]}isDuplicateRecord(e){return n=>e.type===n.type&&e.name===n.name&&(0,Pt.default)(e.data,n.data)}unique(){var e=[];return n=>~e.indexOf(n)?!1:(e.push(n),!0)}};ue.Server=_e;ue.default=_e});var qn=k(rn=>{"use strict";Object.defineProperty(rn,"__esModule",{value:!0});rn.default=(r,e)=>{if(e===void 0)return!0;let n=r.txt,t=Object.entries(e).map(([i,s])=>{let a=n[i];return!(a===void 0||s!=a)});return t.length==0?!0:!t.includes(!1)}});var zn=k(sn=>{"use strict";Object.defineProperty(sn,"__esModule",{value:!0});sn.default=r=>Object.keys(r).filter(e=>!e.includes("binary")).reduce((e,n)=>Object.assign(e,{[n]:r[n]}),{})});var Vn=k(an=>{"use strict";Object.defineProperty(an,"__esModule",{value:!0});an.default=_t;function _t(r,e){if(r===void 0||e===void 0)return!1;let n=Object.keys(r),t=Object.keys(e);if(n.length!=t.length)return!1;for(let i of n)if(r[i]!=e[i])return!1;return!0}});var Yn=k(he=>{"use strict";var Ue=he&&he.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(he,"__esModule",{value:!0});he.Browser=void 0;var At=Ue(qe()),se=Ue(Oe()),Bt=require("events"),on=ze(),Hn=Ue(qn()),Rt=Ue(zn()),Mt=Ue(Vn()),jn=".local",bt="_services._dns-sd._udp"+jn,me=class extends Bt.EventEmitter{constructor(e,n,t){if(super(),this.onresponse=void 0,this.serviceMap={},this.wildcard=!1,this._services=[],typeof n=="function")return new me(e,null,n);this.mdns=e,this.txt=new At.default(n!==null&&n.txt!=null?n.txt:void 0),n===null||n.type===void 0?(this.name=bt,this.wildcard=!0):(this.name=(0,on.toString)({name:n.type,protocol:n.protocol||"tcp"})+jn,n.name&&(this.name=n.name+"."+this.name),this.wildcard=!1),n!=null&&n.txt!==void 0&&(this.txtQuery=(0,Rt.default)(n.txt)),t&&this.on("up",t),this.start()}start(){if(!(this.onresponse||this.name===void 0)){var e=this,n={};this.wildcard||(n[this.name]=!0),this.onresponse=(t,i)=>{e.wildcard&&t.answers.forEach(s=>{s.type!=="PTR"||s.name!==e.name||s.name in n||(n[s.data]=!0,e.mdns.query(s.data,"PTR"))}),Object.keys(n).forEach(function(s){e.goodbyes(s,t).forEach(e.removeService.bind(e));var a=e.buildServicesFor(s,t,e.txt,i);a.length!==0&&a.forEach(o=>{if(e.serviceMap[o.fqdn]){e.updateService(o);return}e.addService(o)})})},this.mdns.on("response",this.onresponse),this.update()}}stop(){this.onresponse&&(this.mdns.removeListener("response",this.onresponse),this.onresponse=void 0)}update(){this.mdns.query(this.name,"PTR")}get services(){return this._services}addService(e){(0,Hn.default)(e,this.txtQuery)!==!1&&(this._services.push(e),this.serviceMap[e.fqdn]=!0,this.emit("up",e))}updateService(e){var n;if(!(0,Mt.default)(e.txt,((n=this._services.find(t=>(0,se.default)(t.fqdn,e.fqdn)))===null||n===void 0?void 0:n.txt)||{})){if(!(0,Hn.default)(e,this.txtQuery)){this.removeService(e.fqdn);return}this._services=this._services.map(function(t){return(0,se.default)(t.fqdn,e.fqdn)?e:t}),this.emit("txt-update",e)}}removeService(e){var n,t;this._services.some(function(i,s){if((0,se.default)(i.fqdn,e))return n=i,t=s,!0}),!(!n||t===void 0)&&(this._services.splice(t,1),delete this.serviceMap[e],this.emit("down",n))}goodbyes(e,n){return n.answers.concat(n.additionals).filter(t=>t.type==="PTR"&&t.ttl===0&&(0,se.default)(t.name,e)).map(t=>t.data)}buildServicesFor(e,n,t,i){var s=n.answers.concat(n.additionals).filter(a=>a.ttl>0);return s.filter(a=>a.type==="PTR"&&(0,se.default)(a.name,e)).map(a=>{let o={addresses:[],subtypes:[]};if(s.filter(c=>c.type==="PTR"&&(0,se.default)(c.data,a.data)&&c.name.includes("._sub")).forEach(c=>{let h=(0,on.toType)(c.name);o.subtypes.push(h.subtype)}),s.filter(c=>(c.type==="SRV"||c.type==="TXT")&&(0,se.default)(c.name,a.data)).forEach(c=>{if(c.type==="SRV"){var h=c.name.split("."),m=h[0],l=(0,on.toType)(h.slice(1,-1).join("."));o.name=m,o.fqdn=c.name,o.host=c.data.target,o.referer=i,o.port=c.data.port,o.type=l.name,o.protocol=l.protocol}else c.type==="TXT"&&(o.rawTxt=c.data,o.txt=this.txt.decodeAll(c.data))}),!!o.name)return s.filter(c=>(c.type==="A"||c.type==="AAAA")&&(0,se.default)(c.name,o.host)).forEach(c=>o.addresses.push(c.data)),o}).filter(a=>!!a)}};he.Browser=me;he.default=me});var Kn=k(R=>{"use strict";var Be=R&&R.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(R,"__esModule",{value:!0});R.Browser=R.Service=R.Bonjour=void 0;var xt=Be(En()),qt=Be(xn()),cn=Be(Yn());R.Browser=cn.default;var zt=Be(Ve());R.Service=zt.default;var Ae=class{constructor(e={},n){this.server=new qt.default(e,n),this.registry=new xt.default(this.server)}publish(e){return this.registry.publish(e)}unpublishAll(e){return this.registry.unpublishAll(e)}find(e=null,n){return new cn.default(this.server.mdns,e,n)}findOne(e=null,n=1e4,t){let i=new cn.default(this.server.mdns,e);var s;return i.once("up",a=>{s!==void 0&&clearTimeout(s),i.stop(),t&&t(a)}),s=setTimeout(()=>{i.stop(),t&&t(null)},n),i}destroy(e){this.registry.destroy(),this.server.mdns.destroy(e)}};R.Bonjour=Ae;R.default=Ae});var Ht={};fn(Ht,{DEFAULT_SETTINGS:()=>Me,default:()=>be});module.exports=et(Ht);var S=require("obsidian");var K=require("obsidian"),oe="local-chat-view",Ce=class extends K.ItemView{constructor(n,t){super(n);this.knownUsers=new Map;this.plugin=t}getViewType(){return oe}getDisplayText(){return"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0438\u0439 \u0427\u0430\u0442"}getIcon(){return"message-circle"}async onOpen(){let n=this.containerEl.children[1];n.empty(),n.addClass("local-chat-view-container");let t=n.createDiv({cls:"chat-sidebar"});t.createEl("h5",{text:"\u041E\u043D\u043B\u0430\u0439\u043D:",cls:"chat-user-list-header"}),this.userListEl=t.createDiv({cls:"chat-user-list"});let i=n.createDiv({cls:"chat-main-area"});this.messageContainerEl=i.createDiv({cls:"chat-message-area"}),this.messageContainerEl.id="chat-message-area-id";let s=i.createDiv({cls:"chat-input-area"});this.inputEl=s.createEl("input",{type:"text",placeholder:"\u0412\u0432\u0435\u0434\u0456\u0442\u044C \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F...",cls:"chat-input"}),this.sendButtonEl=s.createEl("button",{cls:"chat-send-button"}),(0,K.setIcon)(this.sendButtonEl,"send-horizontal"),this.sendButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438"),this.fileButtonEl=s.createEl("button",{cls:"chat-file-button"}),(0,K.setIcon)(this.fileButtonEl,"paperclip"),this.fileButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B"),this.fileButtonEl.onClickEvent(this.handleSendFileClick.bind(this)),this.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.handleSendMessage())}),this.sendButtonEl.addEventListener("click",()=>{this.handleSendMessage()}),console.log(`[${this.plugin.manifest.name}] ChatView \u0432\u0456\u0434\u043A\u0440\u0438\u0442\u043E`),this.inputEl.focus()}handleSendFileClick(){let n=createEl("input",{type:"file"});n.onchange=async t=>{if(!n.files||n.files.length===0)return;let i=null;for(let s=0;s<n.files.length;s++){let a=n.files[s];console.log(`\u041E\u0431\u0440\u0430\u043D\u043E \u0444\u0430\u0439\u043B: ${a.name}, \u0440\u043E\u0437\u043C\u0456\u0440: ${a.size}`),await this.plugin.initiateSendFile(a,i)}n.value=""},n.click()}async onClose(){console.log(`[${this.plugin.manifest.name}] ChatView \u0437\u0430\u043A\u0440\u0438\u0442\u043E`)}handleSendMessage(){let n=this.inputEl.value.trim();if(n)try{this.plugin.sendMessage(null,n),this.inputEl.value="",this.inputEl.focus()}catch(t){console.error(`[${this.plugin.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F:`,t),new K.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F.")}}displayMessage(n,t,i,s){let a=this.messageContainerEl.createDiv({cls:`chat-message ${s?"own-message":"other-message"}`}),o=a.createDiv({cls:"message-header"});o.createSpan({cls:"message-sender",text:s?"\u0412\u0438":n}),o.createSpan({cls:"message-timestamp",text:new Date(i).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let c=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");a.createDiv({cls:"message-content"}).innerHTML=c,this.scrollToBottom()}addUserToList(n){if(this.knownUsers.has(n.nickname)){let s=this.knownUsers.get(n.nickname);s!=null&&s.element&&(s.element.removeClass("user-offline"),s.element.addClass("user-online"));return}let t=this.userListEl.createDiv({cls:"chat-user-list-item user-online"});t.dataset.nickname=n.nickname;let i=t.createSpan({cls:"user-icon"});(0,K.setIcon)(i,"user"),t.createSpan({cls:"user-nickname",text:n.nickname}),this.knownUsers.set(n.nickname,{...n,element:t})}removeUserFromList(n){let t=this.knownUsers.get(n);t!=null&&t.element?(t.element.remove(),this.knownUsers.delete(n)):console.warn(`[${this.plugin.manifest.name}] \u0421\u043F\u0440\u043E\u0431\u0430 \u0432\u0438\u0434\u0430\u043B\u0438\u0442\u0438 \u043D\u0435\u0456\u0441\u043D\u0443\u044E\u0447\u043E\u0433\u043E \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0430 \u0437\u0456 \u0441\u043F\u0438\u0441\u043A\u0443: ${n}`)}clearMessages(){this.messageContainerEl.empty(),new K.Notice("\u0406\u0441\u0442\u043E\u0440\u0456\u044E \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u044C \u043E\u0447\u0438\u0449\u0435\u043D\u043E (\u0432 \u043F\u043E\u0442\u043E\u0447\u043D\u043E\u043C\u0443 \u0432\u0456\u043A\u043D\u0456).")}displayFileOffer(n,t){let i=this.messageContainerEl.createDiv({cls:"chat-message file-offer",attr:{"data-file-id":t.fileId}}),s=i.createDiv({cls:"message-header"});s.createSpan({cls:"message-sender",text:n}),s.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let a=i.createDiv({cls:"message-content"});a.setText(`${n} \u043F\u0440\u043E\u043F\u043E\u043D\u0443\u0454 \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B: `),a.createEl("strong",{text:t.filename}),a.createSpan({text:` (${this.formatFileSize(t.size)})`});let o=i.createDiv({cls:"file-offer-actions"});o.createEl("button",{text:"\u041F\u0440\u0438\u0439\u043D\u044F\u0442\u0438"}).addEventListener("click",()=>{this.plugin.acceptFileOffer(n,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"accepted")}),o.createEl("button",{text:"\u0412\u0456\u0434\u0445\u0438\u043B\u0438\u0442\u0438",cls:"mod-danger"}).addEventListener("click",()=>{this.plugin.declineFileOffer(n,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"declined")}),this.scrollToBottom()}updateFileProgress(n,t,i,s,a){let o=this.messageContainerEl.querySelector(`.chat-message[data-file-id="${n}"]`);if(!o)if(t==="upload"){console.warn(`UI element for uploading file ${n} not implemented yet.`);return}else{console.warn(`Could not find message element for file transfer ${n} to update progress.`);return}let c=o.querySelector(".file-progress-container");if(!c){c=o.createDiv({cls:"file-progress-container"});let g=o.querySelector(".file-offer-actions");g&&g.empty()}c.empty();let h=s>0?Math.round(i/s*100):0,m=c.createEl("progress");m.max=s,m.value=i;let l=c.createSpan({cls:"progress-text"});switch(a){case"starting":l.setText(t==="download"?" \u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u043F\u043E\u0447\u0430\u043B\u043E\u0441\u044F... 0%":" \u0412\u0456\u0434\u043F\u0440\u0430\u0432\u043A\u0430 \u043F\u043E\u0447\u0430\u043B\u0430\u0441\u044F... 0%");break;case"progressing":l.setText(` ${h}% (${this.formatFileSize(i)} / ${this.formatFileSize(s)})`);break;case"completed":m.remove();let g=t==="download"?"\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.":"\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.";l.setText(` ${g} (${this.formatFileSize(s)})`),o.addClass("transfer-completed");break;case"error":m.remove(),l.setText(" \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456."),l.addClass("progress-error"),o.addClass("transfer-error");break;case"accepted":l.setText(" \u041F\u0440\u0438\u0439\u043D\u044F\u0442\u043E. \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0434\u0430\u043D\u0438\u0445..."),o.removeClass("offer-declined"),o.addClass("offer-accepted");break;case"declined":m.remove(),l.setText(" \u0412\u0456\u0434\u0445\u0438\u043B\u0435\u043D\u043E."),o.removeClass("offer-accepted"),o.addClass("offer-declined");break}this.scrollToBottom()}formatFileSize(n){if(n===0)return"0 Bytes";let t=1024,i=["Bytes","KB","MB","GB","TB"],s=Math.floor(Math.log(n)/Math.log(t));return parseFloat((n/Math.pow(t,s)).toFixed(2))+" "+i[s]}scrollToBottom(){setTimeout(()=>{this.messageContainerEl.scrollTop=this.messageContainerEl.scrollHeight},50)}displayUploadProgress(n){let t=this.messageContainerEl.createDiv({cls:"chat-message own-message file-upload",attr:{"data-file-id":n.fileId}}),i=t.createDiv({cls:"message-header"});i.createSpan({cls:"message-sender",text:"\u0412\u0438"}),i.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let s=t.createDiv({cls:"message-content"});s.setText("\u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443: "),s.createEl("strong",{text:n.filename}),s.createSpan({text:` (${this.formatFileSize(n.size)})`}),n.recipientNickname&&s.createSpan({text:` \u0434\u043E ${n.recipientNickname}`}),t.createDiv({cls:"file-progress-container"}),this.updateFileProgress(n.fileId,"upload",0,n.size,"starting"),this.scrollToBottom()}};var we=ae(require("net")),N=ae(require("fs")),hn=ae(require("path")),De=class{constructor(e,n){this.server=null;this.activeServerSockets=new Map;this.receivingFiles=new Map;this.sendingFiles=new Map;this.socketBuffers=new Map;if(this.port=e,this.callbacks=n,!n)throw new Error("NetworkManager callbacks are required.");let t=["onMessageReceived","onFileOfferReceived","onFileAcceptReceived","onFileDeclineReceived","onFileTransferStart","onFileTransferProgress","onFileTransferComplete","onFileTransferError","onNetworkError"];for(let i of t)typeof n[i]!="function"&&(console.warn(`NetworkManager: Callback '${i}' is missing or not a function.`),n[i]=(...s)=>{console.warn(`NetworkManager: Called missing callback '${i}' with args:`,s)})}startServer(){return new Promise((e,n)=>{if(this.server){console.warn("NetworkManager: Server is already running."),e();return}this.server=we.createServer(),this.server.on("connection",t=>{this._handleConnection(t)}),this.server.on("error",t=>{console.error("NetworkManager: Server error:",t),this.callbacks.onNetworkError("Server listen",t),this.server=null,n(t)}),this.server.on("close",()=>{console.log("NetworkManager: Server closed."),this.server=null,this.activeServerSockets.clear(),this.socketBuffers.clear()}),this.server.listen(this.port,()=>{var s,a;let t=(s=this.server)==null?void 0:s.address(),i=typeof t=="string"?this.port:(a=t==null?void 0:t.port)!=null?a:this.port;console.log(`NetworkManager: Server listening on port ${i}`),e()})})}stopServer(){return new Promise(e=>{if(!this.server){e();return}console.log("NetworkManager: Stopping server..."),this.activeServerSockets.forEach((n,t)=>{n.destroyed||n.destroy()}),this.activeServerSockets.clear(),this.socketBuffers.clear(),this.receivingFiles.forEach(n=>this._cleanupReceivingFile(n.fileId,new Error("Server stopped"))),this.sendingFiles.forEach(n=>this._cleanupSendingFile(n.fileId,new Error("Server stopped"))),this.server.close(n=>{n&&(console.error("NetworkManager: Error closing server:",n),this.callbacks.onNetworkError("Server close",n)),this.server=null,console.log("NetworkManager: Server stopped successfully."),e()})})}_handleConnection(e){var i,s;let n=`${e.remoteAddress}:${e.remotePort}`,t=n;console.log(`NetworkManager: Client connected: ${n}`),this.activeServerSockets.set(t,e),this.socketBuffers.set(t,""),(s=(i=this.callbacks).onClientConnected)==null||s.call(i,{ip:e.remoteAddress||"unknown",port:e.remotePort||0}),e.on("data",a=>{this._handleData(e,t,a)}),e.on("end",()=>{console.log(`NetworkManager: Client disconnected (end): ${n}`),this._handleDisconnect(t)}),e.on("close",a=>{console.log(`NetworkManager: Client connection closed (hadError: ${a}): ${n}`),this._handleDisconnect(t)}),e.on("error",a=>{console.error(`NetworkManager: Socket error from ${n}:`,a),this.callbacks.onNetworkError(`Socket ${n}`,a),this._handleDisconnect(t),e.destroy()})}_handleDisconnect(e){var i,s;let n=this.activeServerSockets.get(e);n&&((s=(i=this.callbacks).onClientDisconnected)==null||s.call(i,{ip:n.remoteAddress||"unknown",port:n.remotePort||0}));let t=null;if(this.receivingFiles.forEach((a,o)=>{a.socket===n&&(t=o)}),t){console.warn(`NetworkManager: Connection closed during file receive: ${t}`);let a=this.receivingFiles.get(t);a&&a.receivedBytes<a.expectedSize?this._cleanupReceivingFile(t,new Error(`Connection closed prematurely after ${a.receivedBytes}/${a.expectedSize} bytes`)):a&&this._finalizeReceivingFile(t)}this.activeServerSockets.delete(e),this.socketBuffers.delete(e),console.log(`NetworkManager: Cleaned up resources for ${e}`)}_handleData(e,n,t){let i=`${e.remoteAddress}:${e.remotePort}`,s=(this.socketBuffers.get(n)||"")+t.toString("utf-8"),a;if(this.receivingFiles.forEach(h=>{h.socket===e&&(a=h)}),a){try{a.writeStream.write(t),a.receivedBytes+=t.length,this.callbacks.onFileTransferProgress(a.fileId,"download",a.receivedBytes,a.expectedSize),a.receivedBytes>=a.expectedSize&&console.log(`NetworkManager: Received expected bytes for file ${a.fileId}`)}catch(h){console.error(`NetworkManager: Error writing file chunk for ${a.fileId}:`,h),this._cleanupReceivingFile(a.fileId,h),e.destroy()}this.socketBuffers.set(n,"");return}let o=-1,c=0;for(let h=0;h<s.length;h++)if(s[h]===`
`){let m=s.substring(c,h).trim();if(o=h,c=h+1,m)try{let l=JSON.parse(m);l.type==="fileDataHeader"&&l.fileId?this._handleFileHeader(e,l.fileId):this._processJsonMessage(e,l)}catch(l){console.warn(`NetworkManager: Received non-JSON message or parse error from ${i}:`,m,l)}}o===-1?this.socketBuffers.set(n,s):this.socketBuffers.set(n,s.substring(c))}_handleFileHeader(e,n){let t=this.receivingFiles.get(n);t?(console.log(`NetworkManager: Received file header for ${n}. Starting download.`),t.socket=e,this.callbacks.onFileTransferStart(n,"download",t.expectedSize)):(console.error(`NetworkManager: Received file header for unknown or unprepared file transfer: ${n}. Closing connection.`),e.end())}_processJsonMessage(e,n){let t={ip:e.remoteAddress||"unknown",port:e.remotePort||0};switch(this.callbacks.onMessageReceived(t,n),n.type){case"fileOffer":n.fileId&&n.filename&&typeof n.size=="number"?this.callbacks.onFileOfferReceived(t,{fileId:n.fileId,filename:n.filename,size:n.size}):console.warn("NetworkManager: Received invalid fileOffer:",n);break;case"fileAccept":n.fileId?this.callbacks.onFileAcceptReceived(t,n.fileId):console.warn("NetworkManager: Received invalid fileAccept:",n);break;case"fileDecline":n.fileId?this.callbacks.onFileDeclineReceived(t,n.fileId):console.warn("NetworkManager: Received invalid fileDecline:",n);break}}sendData(e,n,t){return new Promise((i,s)=>{let a=new we.Socket,o=!1;a.connect(n,e,()=>{o=!0,console.log(`NetworkManager: Connected to ${e}:${n} for sending data.`);try{let c=JSON.stringify(t)+`
`;a.write(c,"utf-8",h=>{h?(console.error(`NetworkManager: Error writing data to ${e}:${n}:`,h),this.callbacks.onNetworkError(`Send data to ${e}:${n}`,h),a.destroy(),s(h)):(console.log(`NetworkManager: Data sent successfully to ${e}:${n}`),a.end(),i())})}catch(c){console.error("NetworkManager: Error stringifying payload or writing:",c),this.callbacks.onNetworkError(`Send data (prepare) to ${e}:${n}`,c),a.destroy(),s(c)}}),a.on("error",c=>{console.error(o?`NetworkManager: Socket error after connection to ${e}:${n}:`:`NetworkManager: Connection error to ${e}:${n}:`,c.message),this.callbacks.onNetworkError(`Connect/Send to ${e}:${n}`,c),s(c),a.destroy()}),a.on("close",c=>{})})}prepareToReceiveFile(e,n,t,i){return new Promise((s,a)=>{if(this.receivingFiles.has(e)){console.warn(`NetworkManager: Already preparing to receive file ${e}.`),a(new Error(`Already receiving file with ID ${e}`));return}try{let o=hn.dirname(n);N.existsSync(o)||(N.mkdirSync(o,{recursive:!0}),console.log(`NetworkManager: Created directory ${o} for receiving file.`));let c=N.createWriteStream(n),h={fileId:e,filePath:n,writeStream:c,receivedBytes:0,expectedSize:t,senderInfo:i};c.on("error",m=>{console.error(`NetworkManager: WriteStream error for ${e} (${n}):`,m),this._cleanupReceivingFile(e,m),a(m)}),c.on("open",()=>{console.log(`NetworkManager: Ready to receive file ${e} at ${n}`),this.receivingFiles.set(e,h),s()}),c.on("close",()=>{console.log(`NetworkManager: WriteStream closed for ${e}`)})}catch(o){console.error(`NetworkManager: Error preparing to receive file ${e}:`,o),this.callbacks.onNetworkError(`Prepare receive ${e}`,o),a(o)}})}startFileTransfer(e,n,t,i){return new Promise(async(s,a)=>{console.log(`NetworkManager: Starting file transfer ${t} to ${e}:${n} from ${i}`);let o;try{if(o=await N.promises.stat(i),!o.isFile())throw new Error("Source path is not a file.")}catch(u){console.error(`NetworkManager: Error accessing file ${i}:`,u),this.callbacks.onFileTransferError(t,"upload",u),a(u);return}let c=o.size,h=new we.Socket,m={fileId:t,filePath:i,socket:h,receiverInfo:`${e}:${n}`,sentBytes:0,totalSize:c};this.sendingFiles.set(t,m);let l=!1,g=!1;h.connect(n,e,()=>{console.log(`NetworkManager: Connected to ${e}:${n} for file transfer ${t}.`);let u={type:"fileDataHeader",fileId:t};h.write(JSON.stringify(u)+`
`,"utf-8",d=>{if(d){console.error(`NetworkManager: Error sending file header for ${t}:`,d),this._cleanupSendingFile(t,d),a(d);return}l=!0,console.log(`NetworkManager: File header sent for ${t}. Starting stream.`);try{let y=N.createReadStream(i);m.readStream=y,g=!0,this.callbacks.onFileTransferStart(t,"upload",c),y.on("data",U=>{let $=h.write(U);m.sentBytes+=U.length,this.callbacks.onFileTransferProgress(t,"upload",m.sentBytes,c),$||(y.pause(),h.once("drain",()=>{y.resume()}))}),y.on("end",()=>{console.log(`NetworkManager: File stream ended for ${t}. All data sent.`),h.end(),s()}),y.on("error",U=>{console.error(`NetworkManager: ReadStream error for ${t}:`,U),this._cleanupSendingFile(t,U),a(U)}),y.on("close",()=>{console.log(`NetworkManager: ReadStream closed for ${t}`)})}catch(y){console.error(`NetworkManager: Error creating ReadStream for ${t}:`,y),this._cleanupSendingFile(t,y),a(y)}})}),h.on("error",u=>{console.error(`NetworkManager: File transfer socket error for ${t} to ${e}:${n}:`,u.message),l?g&&this._cleanupSendingFile(t,u):(this._cleanupSendingFile(t,u),a(u))}),h.on("close",u=>{if(console.log(`NetworkManager: File transfer connection closed for ${t} (hadError: ${u})`),u&&this.sendingFiles.has(t)){let d=new Error(`Connection closed with error during upload of ${t}`);this._cleanupSendingFile(t,d),a(d)}else if(!u&&this.sendingFiles.has(t)&&m.sentBytes===m.totalSize)this.callbacks.onFileTransferComplete(t,"upload",null),this.sendingFiles.delete(t);else if(this.sendingFiles.has(t)){let d=new Error(`Connection closed prematurely during upload of ${t}`);this._cleanupSendingFile(t,d),a(d)}})})}_finalizeReceivingFile(e){let n=this.receivingFiles.get(e);if(n){if(console.log(`NetworkManager: Finalizing received file ${e} at ${n.filePath}`),n.receivedBytes!==n.expectedSize){console.warn(`NetworkManager: File ${e} received size mismatch! Expected ${n.expectedSize}, got ${n.receivedBytes}.`),this._cleanupReceivingFile(e,new Error(`Size mismatch: expected ${n.expectedSize}, received ${n.receivedBytes}`));return}n.writeStream.end(()=>{console.log(`NetworkManager: WriteStream finalized for ${e}`),this.callbacks.onFileTransferComplete(e,"download",n.filePath),this.receivingFiles.delete(e),n.socket&&!n.socket.destroyed&&n.socket.destroy()})}}_cleanupReceivingFile(e,n){let t=this.receivingFiles.get(e);t&&(console.error(`NetworkManager: Cleaning up receiving file ${e} due to error:`,n.message),t.writeStream.end(),t.writeStream.close(async()=>{try{N.existsSync(t.filePath)&&(await N.promises.unlink(t.filePath),console.log(`NetworkManager: Deleted incomplete file ${t.filePath}`))}catch(i){console.error(`NetworkManager: Error deleting incomplete file ${t.filePath}:`,i)}finally{this.callbacks.onFileTransferError(e,"download",n),this.receivingFiles.delete(e),t.socket&&!t.socket.destroyed&&t.socket.destroy()}}))}_cleanupSendingFile(e,n){let t=this.sendingFiles.get(e);t&&(console.error(`NetworkManager: Cleaning up sending file ${e} due to error:`,n.message),t.readStream&&!t.readStream.destroyed&&t.readStream.destroy(),t.socket.destroyed||t.socket.destroy(),this.callbacks.onFileTransferError(e,"upload",n),this.sendingFiles.delete(e))}};var Xn=ae(Kn()),ye=ae(require("net")),Vt="obsidian-local-chat",Re=class{constructor(e,n){this.bonjour=null;this.publishedService=null;this.browser=null;this.discoveredUsers=new Map;if(!e||!e.nickname||!e.port)throw new Error("UserDiscovery: Missing required config (nickname, port).");if(!n||typeof n.onUserFound!="function"||typeof n.onUserLeft!="function"||typeof n.onDiscoveryError!="function")throw new Error("UserDiscovery: Missing required callbacks (onUserFound, onUserLeft, onDiscoveryError).");this.config={...e,serviceType:e.serviceType||Vt},this.callbacks=n,this.ownServiceKey=`${this.config.nickname}:${this.config.port}`,console.log(`[UserDiscovery] \u0406\u043D\u0456\u0446\u0456\u0430\u043B\u0456\u0437\u043E\u0432\u0430\u043D\u043E \u0434\u043B\u044F '${this.config.nickname}' \u043D\u0430 \u043F\u043E\u0440\u0442\u0456 ${this.config.port}, \u0442\u0438\u043F \u0441\u0435\u0440\u0432\u0456\u0441\u0443 '${this.config.serviceType}'`)}async start(){if(this.bonjour){console.warn("[UserDiscovery] Discovery is already running.");return}console.log("[UserDiscovery] Starting mDNS discovery...");try{this.bonjour=new Xn.Bonjour,this.discoveredUsers.clear(),this.publishService(),this.startBrowse(),console.log("[UserDiscovery] Publishing and Browse started.")}catch(e){throw console.error("[UserDiscovery] Failed to initialize Bonjour:",e),this.callbacks.onDiscoveryError("Bonjour Initialization",e),await this.stop(),e}}async stop(){if(!this.bonjour)return;console.log("[UserDiscovery] Stopping mDNS discovery...");let e=this.bonjour;if(this.bonjour=null,this.browser)try{this.browser.stop(),console.log("[UserDiscovery] Browser stopped.")}catch(n){console.warn("[UserDiscovery] Error stopping browser:",n.message)}finally{this.browser=null}try{await new Promise((n,t)=>{console.log("[UserDiscovery] Calling unpublishAll..."),e.unpublishAll(i=>{i?console.warn("[UserDiscovery] Error during unpublishAll:",i.message):console.log("[UserDiscovery] UnpublishAll completed."),n()}),setTimeout(()=>{console.warn("[UserDiscovery] UnpublishAll timeout reached, proceeding with destroy."),n()},2e3)}),console.log("[UserDiscovery] Calling destroy..."),e.destroy(),console.log("[UserDiscovery] Bonjour instance destroyed.")}catch(n){console.error("[UserDiscovery] Error during Bonjour cleanup (destroy):",n),this.callbacks.onDiscoveryError("Bonjour Cleanup",n)}finally{this.publishedService=null,this.browser=null,this.bonjour===e&&(this.bonjour=null)}this.discoveredUsers.clear(),console.log("[UserDiscovery] Discovery stopped and resources released.")}getUserInfo(e){return this.discoveredUsers.get(e)||null}getAllUsers(){return Array.from(this.discoveredUsers.values())}publishService(){if(this.bonjour)try{this.publishedService=this.bonjour.publish({name:this.config.nickname,type:this.config.serviceType,port:this.config.port}),console.log(`[UserDiscovery] Service '${this.config.nickname}' published on port ${this.config.port}.`),this.publishedService.on("error",e=>{console.error(`[UserDiscovery] Error publishing service '${this.config.nickname}':`,e),this.callbacks.onDiscoveryError("Service Publish",e),this.publishedService=null})}catch(e){console.error("[UserDiscovery] Exception during bonjour.publish:",e),this.callbacks.onDiscoveryError("Service Publish Init",e)}}startBrowse(){if(this.bonjour)try{this.browser=this.bonjour.find({type:this.config.serviceType}),this.browser.on("up",e=>{this._handleServiceUp(e)}),this.browser.on("down",e=>{this._handleServiceDown(e)}),this.browser.on("error",e=>{console.error("[UserDiscovery] Browser error:",e),this.callbacks.onDiscoveryError("Service Browse",e)}),console.log(`[UserDiscovery] Started Browse for '${this.config.serviceType}' services.`)}catch(e){console.error("[UserDiscovery] Exception during bonjour.find:",e),this.callbacks.onDiscoveryError("Service Browse Init",e)}}_handleServiceUp(e){let n=`${e.name}:${e.port}`;if(e.name===this.config.nickname&&e.port===this.config.port)return;if(this.discoveredUsers.has(e.name)){let s=this.discoveredUsers.get(e.name),a=this._selectIpAddress(e.addresses);if(a&&(s.ip!==a||s.port!==e.port)){console.log(`[UserDiscovery] Updating user info for ${e.name}: IP ${s.ip}=>${a}, Port ${s.port}=>${e.port}`);let o={nickname:e.name,ip:a,port:e.port};this.discoveredUsers.set(e.name,o),this.callbacks.onUserFound(o)}return}let t=this._selectIpAddress(e.addresses);if(!t){console.warn(`[UserDiscovery] Could not find suitable IP address for service ${e.name} in addresses:`,e.addresses);return}let i={nickname:e.name,ip:t,port:e.port};this.discoveredUsers.set(i.nickname,i),console.log(`[UserDiscovery] >>> User Found: ${i.nickname} (${i.ip}:${i.port})`),this.callbacks.onUserFound(i)}_handleServiceDown(e){if(!(e.name===this.config.nickname&&e.port===this.config.port)&&this.discoveredUsers.has(e.name)){let n=this.discoveredUsers.get(e.name);this.discoveredUsers.delete(e.name),console.log(`[UserDiscovery] <<< User Left: ${n.nickname} (was ${n.ip}:${n.port})`),this.callbacks.onUserLeft({nickname:n.nickname})}}_selectIpAddress(e){if(!e||e.length===0)return null;let n=null;for(let t of e)try{let i=ye.isIP(t);if(i===4&&!this._isLoopback(t))return t;i===4&&!n&&(n=t)}catch(i){console.warn(`[UserDiscovery] Error checking IP version for address '${t}':`,i)}if(n)return n;for(let t of e)if(!this._isLoopback(t))return t;return e[0]||null}_isLoopback(e){try{if(ye.isIPv4(e))return e.startsWith("127.");if(ye.isIPv6(e))return e==="::1"||e.toLowerCase()==="::ffff:127.0.0.1"}catch(n){}return!1}};var ln=ae(require("fs")),M=ae(require("path")),Me={userNickname:`ObsidianUser_${Math.random().toString(36).substring(2,8)}`,listenPort:61337,saveHistory:!0,downloadPath:""},be=class extends S.Plugin{constructor(){super(...arguments);this.chatView=null;this.networkManager=null;this.userDiscovery=null;this.outgoingFileOffers=new Map;this.incomingFileOffers=new Map}async onload(){let n=`[${this.manifest.name}]`;console.log(`${n} Loading plugin...`),await this.loadSettings(),console.log(`${n} Settings loaded. Nickname: ${this.settings.userNickname}, Port: ${this.settings.listenPort}`);let t=this.createNetworkCallbacks(),i=this.createUserDiscoveryCallbacks();this.networkManager=new De(this.settings.listenPort,t),this.userDiscovery=new Re({nickname:this.settings.userNickname,port:this.settings.listenPort},i);try{await this.networkManager.startServer(),console.log(`${n} TCP server started on port ${this.settings.listenPort}.`),await this.userDiscovery.start(),console.log(`${n} User discovery started.`),new S.Notice(`${this.manifest.name}: Chat service active.`)}catch(s){console.error(`${n} CRITICAL ERROR starting network services:`,s),new S.Notice(`[${this.manifest.name}] Failed to start chat services! Error: ${s.message}. Chat will be unavailable.`),await this.cleanupNetworkServices();return}this.registerView(oe,s=>(this.chatView=new Ce(s,this),this.populateInitialChatViewState(),this.chatView)),this.addRibbonIcon("message-circle","Open Local Chat",()=>this.activateView()),this.addCommand({id:"open-local-chat-view",name:"Open Local Chat panel",callback:()=>this.activateView()}),this.addSettingTab(new dn(this.app,this)),console.log(`${n} Plugin loaded successfully.`)}async onunload(){console.log(`[${this.manifest.name}] Unloading plugin...`),await this.cleanupNetworkServices(),this.app.workspace.detachLeavesOfType(oe),this.chatView=null,this.outgoingFileOffers.clear(),this.incomingFileOffers.clear(),console.log(`[${this.manifest.name}] Plugin unloaded.`)}populateInitialChatViewState(){var n;this.chatView&&((n=this.userDiscovery)==null||n.getAllUsers().forEach(t=>{var i;return(i=this.chatView)==null?void 0:i.addUserToList(t)}),console.log(`[${this.manifest.name}] Populated initial chat view state.`))}async cleanupNetworkServices(){if(this.userDiscovery){try{await this.userDiscovery.stop(),console.log(`[${this.manifest.name}] User discovery stopped.`)}catch(n){console.error(`[${this.manifest.name}] Error stopping UserDiscovery:`,n)}this.userDiscovery=null}if(this.networkManager){try{await this.networkManager.stopServer(),console.log(`[${this.manifest.name}] TCP server stopped.`)}catch(n){console.error(`[${this.manifest.name}] Error stopping NetworkManager:`,n)}this.networkManager=null}}createNetworkCallbacks(){return{onMessageReceived:this.handleIncomingMessage.bind(this),onFileOfferReceived:this.handleIncomingFileOffer.bind(this),onFileAcceptReceived:this.handleFileAcceptReceived.bind(this),onFileDeclineReceived:this.handleFileDeclineReceived.bind(this),onFileTransferStart:this.handleFileTransferStart.bind(this),onFileTransferProgress:this.handleFileTransferProgress.bind(this),onFileTransferComplete:this.handleFileTransferComplete.bind(this),onFileTransferError:this.handleFileTransferError.bind(this),onClientConnected:n=>console.log(`[${this.manifest.name}] Client connected: ${n.ip}:${n.port}`),onClientDisconnected:n=>console.log(`[${this.manifest.name}] Client disconnected: ${n.ip}:${n.port}`),onNetworkError:(n,t)=>{["ECONNREFUSED","ETIMEDOUT","EHOSTUNREACH"].some(s=>t.message.includes(s))?console.warn(`[${this.manifest.name}] Network Error (${n}): ${t.message}`):(console.error(`[${this.manifest.name}] Serious Network Error (${n}):`,t),new S.Notice(`Network Error (${n}): ${t.message}`))}}}createUserDiscoveryCallbacks(){return{onUserFound:this.handleUserFound.bind(this),onUserLeft:this.handleUserLeft.bind(this),onDiscoveryError:(n,t)=>{console.error(`[${this.manifest.name}] Discovery Error (${n}):`,t),new S.Notice(`Discovery Error: ${t.message}`)}}}handleIncomingMessage(n,t){var a,o;let i=(a=this.userDiscovery)==null?void 0:a.getAllUsers().find(c=>c.ip===n.ip&&c.port===n.port),s=(i==null?void 0:i.nickname)||t.senderNickname||`${n.ip}:${n.port}`;t.type==="text"&&t.content?(console.log(`[${this.manifest.name}] Received text from ${s}`),(o=this.chatView)==null||o.displayMessage(s,t.content,t.timestamp||Date.now(),!1),this.isChatViewActive()||new S.Notice(`${s}: ${t.content.substring(0,50)}...`)):console.warn(`[${this.manifest.name}] Received unknown message type:`,t)}handleIncomingFileOffer(n,t){var o,c;let i=(o=this.userDiscovery)==null?void 0:o.getAllUsers().find(h=>h.ip===n.ip&&h.port===n.port),s=(i==null?void 0:i.nickname)||"Unknown Sender",a=`${n.ip}:${n.port}`;console.log(`[${this.manifest.name}] Received file offer '${t.filename}' from ${s} (${a}) (ID: ${t.fileId})`),this.incomingFileOffers.set(t.fileId,{...t,senderNickname:s,senderAddress:a}),(c=this.chatView)==null||c.displayFileOffer(s,t),this.isChatViewActive()||new S.Notice(`File offer '${t.filename}' from ${s}`)}handleFileAcceptReceived(n,t){console.log(`[${this.manifest.name}] Received fileAccept for ${t} from ${n.ip}:${n.port}`);let i=this.outgoingFileOffers.get(t);if(!i){console.error(`[${this.manifest.name}] Unknown outgoing offer ID for fileAccept: ${t}`);return}if(!this.networkManager){console.error(`[${this.manifest.name}] NM inactive, cannot start transfer ${t}`);return}console.log(`[${this.manifest.name}] Starting upload for ${i.filename}`),this.networkManager.startFileTransfer(n.ip,n.port,t,i.filePath).then(()=>console.log(`[${this.manifest.name}] Upload initiated for ${t}.`)).catch(s=>{var a,o;console.error(`[${this.manifest.name}] Failed initiate startFileTransfer ${t}:`,s),new S.Notice(`Failed to start sending ${i.filename}.`),this.outgoingFileOffers.delete(t),(o=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||o.call(a,t,"upload",0,i.size,"error")})}handleFileDeclineReceived(n,t){var s,a;console.log(`[${this.manifest.name}] Received fileDecline for ${t} from ${n.ip}:${n.port}`);let i=this.outgoingFileOffers.get(t);i?(new S.Notice(`User declined file: ${i.filename}`),this.outgoingFileOffers.delete(t),(a=(s=this.chatView)==null?void 0:s.updateFileProgress)==null||a.call(s,t,"upload",0,i.size||0,"declined")):console.warn(`[${this.manifest.name}] Received fileDecline for unknown outgoing offer ID: ${t}`)}handleFileTransferStart(n,t,i){var s,a;console.log(`[${this.manifest.name}] Transfer started: ${n} (${t}), Size: ${i}`),(a=(s=this.chatView)==null?void 0:s.updateFileProgress)==null||a.call(s,n,t,0,i,"starting")}handleFileTransferProgress(n,t,i,s){var a,o;(o=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||o.call(a,n,t,i,s,"progressing")}handleFileTransferComplete(n,t,i){var h,m;let s=t==="download"?this.incomingFileOffers.get(n):this.outgoingFileOffers.get(n),a=(s==null?void 0:s.filename)||(i?M.basename(i):"file"),o=(s==null?void 0:s.size)||0,c=t==="download"?`File '${a}' received.`:`File '${a}' sent.`;console.log(`[${this.manifest.name}] ${c} (ID: ${n})`),new S.Notice(c,4e3),t==="download"&&this.incomingFileOffers.delete(n),t==="upload"&&this.outgoingFileOffers.delete(n),(m=(h=this.chatView)==null?void 0:h.updateFileProgress)==null||m.call(h,n,t,o,o,"completed")}handleFileTransferError(n,t,i){var o,c;console.error(`[${this.manifest.name}] File transfer error: ${n} (${t})`,i);let s=t==="upload"?this.outgoingFileOffers.get(n):this.incomingFileOffers.get(n),a=(s==null?void 0:s.filename)||"file";new S.Notice(`Error transferring file '${a}': ${i.message}`,5e3),t==="upload"&&this.outgoingFileOffers.delete(n),t==="download"&&this.incomingFileOffers.delete(n),(c=(o=this.chatView)==null?void 0:o.updateFileProgress)==null||c.call(o,n,t,0,0,"error")}handleUserFound(n){var t;console.log(`[${this.manifest.name}] User Found: ${n.nickname} (${n.ip}:${n.port})`),(t=this.chatView)==null||t.addUserToList(n)}handleUserLeft(n){var t;console.log(`[${this.manifest.name}] User Left: ${n.nickname}`),(t=this.chatView)==null||t.removeUserFromList(n.nickname)}async sendMessage(n,t){var g;let i=this.settings.userNickname,s=Date.now();if(!(t!=null&&t.trim()))return;let a=t.trim();if((g=this.chatView)==null||g.displayMessage(i,a,s,!0),!this.networkManager){new S.Notice("Network Error: Service not active.");return}if(n!==null&&!this.userDiscovery){new S.Notice("Discovery Error: Cannot send private message.");return}let o=this.networkManager,c=this.userDiscovery,h={type:"text",senderNickname:i,content:a,timestamp:s},m=null,l=0;try{if(n===null){let u=c?c.getAllUsers().filter(y=>y.nickname!==i):[];if(u.length===0){console.log(`[${this.manifest.name}] No users for broadcast.`);return}l=(await Promise.allSettled(u.map(y=>o.sendData(y.ip,y.port,h).catch(U=>Promise.reject({nickname:y.nickname,error:U}))))).filter(y=>y.status==="rejected").length,l>0?(console.warn(`[${this.manifest.name}] Failed broadcast to ${l} user(s).`),m=`Message sent, but failed for ${l} user(s).`):console.log(`[${this.manifest.name}] Broadcast message initiated for ${u.length} users.`)}else{let u=c?c.getUserInfo(n):null;if(!u)throw new Error(`User ${n} not found.`);await o.sendData(u.ip,u.port,h),console.log(`[${this.manifest.name}] Private message sent to ${n}.`)}}catch(u){console.error(`[${this.manifest.name}] Error sending message:`,u),m=`Error sending message: ${u.message}`}m&&new S.Notice(m)}async initiateSendFile(n,t){var g,u,d;if(!this.networkManager){new S.Notice("Network service not ready.");return}if(t!==null&&!this.userDiscovery){new S.Notice("User discovery not ready.");return}let i=`file_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,s=n.name,a=n.size,o=n.path||`PLACEHOLDER_PATH/${s}`;if(o.startsWith("PLACEHOLDER_PATH")){new S.Notice("Error: File path determination not implemented.",1e4),console.error("initiateSendFile: CRITICAL - File path determination needs implementation!");return}this.outgoingFileOffers.set(i,{fileId:i,filePath:o,filename:s,size:a,recipientNickname:t}),console.log(`[${this.manifest.name}] Initiating file send: ${s} (ID: ${i})`),(g=this.chatView)==null||g.displayUploadProgress({fileId:i,filename:s,size:a,recipientNickname:t});let c={type:"fileOffer",senderNickname:this.settings.userNickname,fileId:i,filename:s,size:a},h=this.networkManager,m=this.userDiscovery,l=null;try{if(t===null){let y=m?m.getAllUsers().filter($=>$.nickname!==this.settings.userNickname):[];if(y.length===0)throw new Error("No users found to send file offer.");let U=y.map($=>h.sendData($.ip,$.port,c).catch(P=>console.warn(`Failed sending fileOffer broadcast to ${$.nickname}: ${P.message}`)));await Promise.all(U),console.log(`[${this.manifest.name}] File offer ${i} broadcasted.`)}else{let y=m?m.getUserInfo(t):null;if(!y)throw new Error(`User ${t} not found.`);await h.sendData(y.ip,y.port,c),console.log(`[${this.manifest.name}] File offer ${i} sent to ${t}.`)}}catch(y){console.error(`[${this.manifest.name}] Error sending fileOffer for ${i}:`,y),l=`Error sending file offer: ${y.message}`,this.outgoingFileOffers.delete(i),(d=(u=this.chatView)==null?void 0:u.updateFileProgress)==null||d.call(u,i,"upload",0,a,"error")}l&&new S.Notice(l)}async acceptFileOffer(n,t){var a,o,c,h;if(!this.networkManager){new S.Notice("Network service not ready.");return}let i=this.incomingFileOffers.get(t);if(!i){new S.Notice("Error: File offer not found or already handled.");return}let s=((a=this.userDiscovery)==null?void 0:a.getUserInfo(n))||null;if(!s&&i.senderAddress){let m=i.senderAddress.split(":");if(m.length===2){let l=parseInt(m[1]);m[0]&&!isNaN(l)&&(s={nickname:n,ip:m[0],port:l})}}if(!s){new S.Notice(`Error: Cannot find address for sender ${n}.`);return}try{let m=await this.determineSavePath(i.filename);console.log(`[${this.manifest.name}] Accepting file ${t}. Save path: ${m}`),await this.networkManager.prepareToReceiveFile(t,m,i.size,`${n} (${s.ip}:${s.port})`);let l={type:"fileAccept",receiverNickname:this.settings.userNickname,fileId:t};await this.networkManager.sendData(s.ip,s.port,l),console.log(`[${this.manifest.name}] Acceptance for ${t} sent. Waiting for data...`)}catch(m){console.error(`[${this.manifest.name}] Error accepting file ${t}:`,m),new S.Notice(`Error accepting file: ${m.message}`),this.networkManager&&((o=this.networkManager.receivingFiles)!=null&&o.has(t))&&this.networkManager._cleanupReceivingFile(t,m),this.incomingFileOffers.delete(t),(h=(c=this.chatView)==null?void 0:c.updateFileProgress)==null||h.call(c,t,"download",0,i.size,"error")}}async declineFileOffer(n,t){var a,o,c,h,m;if(!this.networkManager){console.error("NM not ready");return}let i=this.incomingFileOffers.get(t);if(!i){(o=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||o.call(a,t,"download",0,0,"declined");return}let s=((c=this.userDiscovery)==null?void 0:c.getUserInfo(n))||null;if(!s&&i.senderAddress){let l=i.senderAddress.split(":");if(l.length===2){let g=parseInt(l[1]);l[0]&&!isNaN(g)&&(s={nickname:n,ip:l[0],port:g})}}if(s){let l={type:"fileDecline",receiverNickname:this.settings.userNickname,fileId:t};this.networkManager.sendData(s.ip,s.port,l).then(()=>console.log(`[${this.manifest.name}] Decline message for ${t} sent.`)).catch(g=>console.warn(`[${this.manifest.name}] Failed sending decline message for ${t}: ${g.message}`))}else console.warn(`[${this.manifest.name}] Sender ${n} not found, cannot send decline for ${t}.`);this.incomingFileOffers.delete(t),(m=(h=this.chatView)==null?void 0:h.updateFileProgress)==null||m.call(h,t,"download",0,i.size||0,"declined")}async loadSettings(){this.settings=Object.assign({},Me,await this.loadData())}async saveSettings(){await this.saveData(this.settings),console.log(`[${this.manifest.name}] Settings saved.`)}async activateView(){let{workspace:n}=this.app,t=null,i=n.getLeavesOfType(oe);if(i.length>0)t=i[0],console.log(`[${this.manifest.name}] activateView: Revealing existing leaf.`);else{console.log(`[${this.manifest.name}] activateView: Creating new leaf.`);let s=n.getRightLeaf(!1);if(s||(console.log(`[${this.manifest.name}] activateView: Could not get right leaf, trying left.`),s=n.getLeftLeaf(!1)),s)t=s,await t.setViewState({type:oe,active:!0}),console.log(`[${this.manifest.name}] activateView: New leaf created and view state set.`);else{console.error(`[${this.manifest.name}] activateView: Failed to get leaf for new view.`),new S.Notice("Error: Could not open chat panel.");return}}t?n.revealLeaf(t):console.error(`[${this.manifest.name}] activateView: leafToReveal is unexpectedly null before revealLeaf.`)}isChatViewActive(){let n=this.app.workspace.activeLeaf;return!!n&&n.getViewState().type===oe}async determineSavePath(n){var u;let t=((u=this.settings.downloadPath)==null?void 0:u.trim())||"",i=!1;if(!t){i=!0;try{let d=this.app.vault.getConfig("attachmentFolderPath");d&&typeof d=="string"?t=d.startsWith("/")?d.substring(1):d:t=""}catch(d){t=""}}try{let d=this.app.vault.getAbstractFileByPath(t);d&&!(d instanceof S.TFolder)?(console.warn(`[<span class="math-inline">{this.manifest.name}] Specified download path '</span>{downloadDir}' exists but is not a folder. Using vault root.`),t=""):d||(console.log(`[${this.manifest.name}] Creating download directory: ${t}`),t?await this.app.vault.createFolder(t):console.log(`[${this.manifest.name}] Download path is vault root, no need to create folder.`))}catch(d){console.error(`[<span class="math-inline">{this.manifest.name}] Error ensuring download directory '</span>{downloadDir}' exists, using vault root.`,d),t=""}let s=this.app.vault.adapter;if(typeof s.getBasePath!="function")throw new Error("Cannot determine vault base path via adapter.");let a=s.getBasePath(),o=M.join(a,t),c=0,h=this.sanitizeFilename(n),m=h,l=M.join(o,m),g=100;for(;await this.adapterFileExists(l)&&c<g;){c++;let d=M.extname(h);m=`${M.basename(h,d)} (${c})${d}`,l=M.join(o,m)}if(c>=g)throw new Error(`Failed to find unique filename for ${n} after ${g} attempts.`);return console.log(`[${this.manifest.name}] Determined save path: ${l}`),l}async adapterFileExists(n){try{let t=this.app.vault.adapter;if(typeof t.getBasePath!="function"||typeof t.stat!="function")return ln.existsSync(n);let i=t.getBasePath(),s=M.relative(i,n).replace(/\\/g,"/");return!s||s.startsWith("..")?(console.warn(`[${this.manifest.name}] Calculated relative path is outside vault: ${s}. Checking with fs.existsSync.`),ln.existsSync(n)):!!await t.stat(s)}catch(t){return!1}}sanitizeFilename(n){let t=/[<>:"/\\|?*\x00-\x1F]/g,i=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,s=n.replace(t,"_");return i.test(s)&&(s=`_${s}`),s.trim()||"downloaded_file"}},dn=class extends S.PluginSettingTab{constructor(n,t){super(n,t);this.plugin=t}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Local Chat Settings"}),new S.Setting(n).setName("Your Nickname").setDesc("How you will appear to others on the network.").addText(t=>t.setPlaceholder("Enter nickname").setValue(this.plugin.settings.userNickname).onChange(async i=>{this.plugin.settings.userNickname=(i==null?void 0:i.trim())||Me.userNickname,await this.plugin.saveSettings()})),new S.Setting(n).setName("Listening Port").setDesc("TCP port the plugin will use. Requires Obsidian restart to apply.").addText(t=>t.setPlaceholder(String(Me.listenPort)).setValue(String(this.plugin.settings.listenPort)).onChange(async i=>{let s=parseInt(i),a=!1;!isNaN(s)&&s>1024&&s<65535?this.plugin.settings.listenPort!==s&&(this.plugin.settings.listenPort=s,a=!0):i!==String(this.plugin.settings.listenPort)&&(t.setValue(String(this.plugin.settings.listenPort)),new S.Notice("Invalid port. Enter a number between 1025 and 65534.")),a&&(await this.plugin.saveSettings(),new S.Notice("Port changed. Restart Obsidian for the change to take effect."))})),new S.Setting(n).setName("Download Folder").setDesc("Where to save received files. Leave empty to use the vault attachment folder (relative to vault root).").addText(t=>t.setPlaceholder("e.g., ChatDownloads").setValue(this.plugin.settings.downloadPath).onChange(async i=>{this.plugin.settings.downloadPath=(i==null?void 0:i.trim())||"",await this.plugin.saveSettings()})),new S.Setting(n).setName("Save Chat History").setDesc("Whether to keep message history between Obsidian sessions.").addToggle(t=>t.setValue(this.plugin.settings.saveHistory).onChange(async i=>{this.plugin.settings.saveHistory=i,await this.plugin.saveSettings()}))}};
