/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var O=Object.create;var k=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,A=Object.prototype.hasOwnProperty;var D=(d,n)=>()=>(n||d((n={exports:{}}).exports,n),n.exports),P=(d,n)=>{for(var e in n)k(d,e,{get:n[e],enumerable:!0})},W=(d,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of x(n))!A.call(d,s)&&s!==e&&k(d,s,{get:()=>n[s],enumerable:!(t=T(n,s))||t.enumerable});return d};var B=(d,n,e)=>(e=d!=null?O(U(d)):{},W(n||!d||!d.__esModule?k(e,"default",{value:d,enumerable:!0}):e,d)),V=d=>W(k({},"__esModule",{value:!0}),d);var $=D((q,F)=>{"use strict";F.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}});var _={};P(_,{default:()=>E});module.exports=V(_);var c=require("obsidian");var f=require("obsidian"),S="local-chat-view",w=class extends f.ItemView{constructor(e,t){super(e);this.knownUsers=new Map;this.plugin=t}getViewType(){return S}getDisplayText(){return"Local Chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.containerEl.children[1];if(!e)return;e.empty(),e.addClass("local-chat-view-container");let t=e.createDiv({cls:"chat-sidebar"});t.createEl("h5",{text:"Online:",cls:"chat-user-list-header"}),this.userListEl=t.createDiv({cls:"chat-user-list"});let s=e.createDiv({cls:"chat-main-area"});this.messageContainerEl=s.createDiv({cls:"chat-message-area"}),this.messageContainerEl.id="chat-message-area-id";let r=s.createDiv({cls:"chat-input-area"});this.inputEl=r.createEl("input",{type:"text",placeholder:"Enter message (Markdown supported)...",cls:"chat-input"}),this.sendButtonEl=r.createEl("button",{cls:"chat-send-button",attr:{"aria-label":"Send"}}),(0,f.setIcon)(this.sendButtonEl,"send-horizontal"),this.fileButtonEl=r.createEl("button",{cls:"chat-file-button",attr:{"aria-label":"Send File"}}),(0,f.setIcon)(this.fileButtonEl,"paperclip"),this.inputEl.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.handleSendMessage())}),this.sendButtonEl.addEventListener("click",this.handleSendMessage.bind(this)),this.fileButtonEl.onClickEvent(this.handleSendFileClick.bind(this)),this.populateInitialViewState(),this.inputEl.focus(),console.log(`[${this.plugin.manifest.name}] ChatView opened.`)}async onClose(){console.log(`[${this.plugin.manifest.name}] ChatView closed`)}populateInitialViewState(){console.log(`[${this.plugin.manifest.name}] Populating initial chat view state...`);let e=this.plugin.getAllUsers();this.clearUserList(),e.forEach(t=>this.addUserToList(t))}handleSendMessage(){let e=this.inputEl.value.trim();if(!e)return;let t=null;this.plugin.sendMessage(t,e),this.inputEl.value="",this.inputEl.focus()}handleSendFileClick(){let e=createEl("input",{type:"file"});e.onchange=async()=>{if(!e.files||e.files.length===0)return;let t=null;for(let s=0;s<e.files.length;s++)await this.plugin.initiateSendFile(e.files[s],t);e.value=""},e.click()}async displayMessage(e,t,s,r,a=!1){if(!this.messageContainerEl)return;let i=this.messageContainerEl.createDiv({cls:`chat-message ${r?"own-message":"other-message"}`});i.dataset.rawMessage=t;let o=i.createDiv({cls:"message-header"});o.createSpan({cls:"message-sender",text:r?"You":e});let l=o.createDiv({cls:"message-controls"});l.createSpan({cls:"message-timestamp",text:new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let g=l.createEl("button",{cls:"message-copy-button",attr:{"aria-label":"Copy message"}});(0,f.setIcon)(g,"copy"),g.addEventListener("click",p=>{p.stopPropagation(),navigator.clipboard.writeText(t).then(()=>{new f.Notice("Message copied!",1500),(0,f.setIcon)(g,"check"),setTimeout(()=>(0,f.setIcon)(g,"copy"),1500)}).catch(v=>{console.error("Failed to copy message:",v),new f.Notice("Failed to copy message.",2e3)})});let h=i.createDiv({cls:"message-content"});try{await f.MarkdownRenderer.renderMarkdown(t,h,this.app.vault.getRoot().path,this),h.querySelectorAll("a").forEach(p=>{!p.classList.contains("internal-link")&&(p.href.startsWith("http:")||p.href.startsWith("https:"))&&(p.setAttribute("target","_blank"),p.setAttribute("rel","noopener noreferrer"))})}catch(p){console.error("Error rendering markdown:",p),h.setText(`Error rendering message: ${t}`)}let m=this.messageContainerEl.scrollHeight-this.messageContainerEl.clientHeight<=this.messageContainerEl.scrollTop+5;(!a||m)&&this.scrollToBottom()}addUserToList(e){if(!this.userListEl){console.error("addUserToList Error: userListEl not ready.");return}if(this.knownUsers.has(e.nickname))return;let t=this.userListEl.createDiv({cls:"chat-user-list-item user-online",attr:{"data-nickname":e.nickname}});(0,f.setIcon)(t.createSpan({cls:"user-icon"}),"user"),t.createSpan({cls:"user-nickname",text:e.nickname}),this.knownUsers.set(e.nickname,{nickname:e.nickname,element:t})}removeUserFromList(e){var s;let t=this.knownUsers.get(e);(s=t==null?void 0:t.element)==null||s.remove(),this.knownUsers.delete(e)}clearUserList(){this.userListEl&&this.userListEl.empty(),this.knownUsers.clear()}displayFileOffer(e,t){if(!this.messageContainerEl)return;let s=this.messageContainerEl.createDiv({cls:"chat-message file-offer",attr:{"data-file-id":t.fileId}}),r=s.createDiv({cls:"message-header"});r.createSpan({cls:"message-sender",text:e}),r.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let a=s.createDiv({cls:"message-content"});a.setText(`${e} offers file: `),a.createEl("strong",{text:t.filename}),a.createSpan({text:` (${this.formatFileSize(t.size)})`});let i=s.createDiv({cls:"file-offer-actions"});i.createEl("button",{text:"Accept"}).addEventListener("click",()=>{this.plugin.acceptFileOffer(e,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"accepted")}),i.createEl("button",{text:"Decline",cls:"mod-danger"}).addEventListener("click",()=>{this.plugin.declineFileOffer(e,t.fileId),this.updateFileProgress(t.fileId,"download",0,t.size,"declined")}),this.scrollToBottom()}updateFileProgress(e,t,s,r,a){var m;if(!this.messageContainerEl)return;let i=this.messageContainerEl.querySelector(`.chat-message[data-file-id="${e}"]`);if(!i){(t!=="upload"||a!=="starting")&&console.warn(`No msg element for file ${e} (status: ${a})`);return}let o=i.querySelector(".file-progress-container");o||(o=i.createDiv({cls:"file-progress-container"}),(m=i.querySelector(".file-offer-actions"))==null||m.empty()),o.empty();let l=r>0?Math.round(s/r*100):a==="completed"?100:0,g=o.createEl("progress");g.max=r,g.value=s;let h=o.createSpan({cls:"progress-text"});switch(i.removeClass("transfer-completed","transfer-error","offer-accepted","offer-declined"),a){case"starting":h.setText(t==="download"?" Download starting... 0%":" Upload starting... 0%");break;case"progressing":h.setText(` ${l}% (${this.formatFileSize(s)} / ${this.formatFileSize(r)})`);break;case"completed":g.remove(),h.setText(` ${t==="download"?"Received":"Sent"} successfully. (${this.formatFileSize(r)})`),i.addClass("transfer-completed");break;case"error":g.remove(),h.setText(" Transfer Error."),h.addClass("progress-error"),i.addClass("transfer-error");break;case"accepted":h.setText(" Accepted. Waiting for data..."),i.addClass("offer-accepted");break;case"declined":g.remove(),h.setText(" Declined."),i.addClass("offer-declined");break;case"waiting_accept":h.setText(" Waiting for acceptance..."),g.remove();break}this.scrollToBottom()}displayUploadProgress(e){if(!this.messageContainerEl)return;let t=this.messageContainerEl.createDiv({cls:"chat-message own-message file-upload",attr:{"data-file-id":e.fileId}}),s=t.createDiv({cls:"message-header"});s.createSpan({cls:"message-sender",text:"You"}),s.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let r=t.createDiv({cls:"message-content"});r.setText("Sending file: "),r.createEl("strong",{text:e.filename}),r.createSpan({text:` (${this.formatFileSize(e.size)})`}),e.recipientNickname&&r.createSpan({text:` to ${e.recipientNickname}`}),t.createDiv({cls:"file-progress-container"}),this.updateFileProgress(e.fileId,"upload",0,e.size,"waiting_accept"),this.scrollToBottom()}formatFileSize(e,t=2){if(e<=0)return"0 Bytes";let s=1024,r=t<0?0:t,a=["Bytes","KB","MB","GB","TB"],i=Math.floor(Math.log(e)/Math.log(s));return parseFloat((e/Math.pow(s,i)).toFixed(r))+" "+a[i]}scrollToBottom(){this.messageContainerEl&&setTimeout(()=>{this.messageContainerEl.scrollTop=this.messageContainerEl.scrollHeight},50)}};var b=B($()),C=class{constructor(n,e,t,s){this.wss=null;this.clients=new Map;this.clientsByNickname=new Map;this.port=n,this.serverNickname=e,this.callbacks=t,this.WSServerConstructor=s,console.log(`[WSServer] Initialized for server nickname: ${this.serverNickname}`)}start(){return new Promise((n,e)=>{if(this.wss){console.warn("[WSServer] Server already started."),n();return}try{console.log(`[WSServer] Starting server on port ${this.port}...`),this.wss=new this.WSServerConstructor({port:this.port}),this.wss.on("listening",()=>{console.log(`[WSServer] Successfully listening on port ${this.port}.`),n()}),this.wss.on("error",t=>{console.error("[WSServer] Server error:",t),this.callbacks.onError(t),this.wss=null,e(t)}),this.wss.on("connection",t=>{this._handleConnection(t)})}catch(t){console.error("[WSServer] Failed to create WebSocketServer:",t),this.callbacks.onError(t),e(t)}})}async stop(){return new Promise(n=>{if(!this.wss){n();return}console.log("[WSServer] Stopping server..."),this.clients.forEach(e=>{e.ws.terminate()}),this.clients.clear(),this.clientsByNickname.clear(),this.wss.close(e=>{e?(console.error("[WSServer] Error closing server:",e),this.callbacks.onError(e)):console.log("[WSServer] Server closed successfully."),this.wss=null,n()})})}_handleConnection(n){let e=`client_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;console.log(`[WSServer] Client connected with temporary ID: ${e}. Waiting for identification.`);let t={id:e,nickname:"",ws:n};this.clients.set(n,t),n.on("message",s=>{this._handleMessage(n,s)}),n.on("close",(s,r)=>{console.log(`[WSServer] Client connection closed. Code: ${s}, Reason: ${r.toString()}`),this._handleCloseOrError(n)}),n.on("error",s=>{console.error(`[WSServer] WebSocket error for client ${t.nickname||t.id}:`,s),this._handleCloseOrError(n,s)})}_handleMessage(n,e){let t=this.clients.get(n);if(!t){console.warn("[WSServer] Message from unknown client socket.");return}let s;try{s=JSON.parse(e.toString("utf-8"))}catch(r){console.warn(`[WSServer] Received non-JSON message from ${t.nickname||t.id}:`,e),n.send(JSON.stringify({type:"error",message:"Invalid message format (not JSON)."}));return}if(!t.nickname){if(s.type==="identify"){let r=s;if(r.nickname&&typeof r.nickname=="string"){let a=r.nickname.trim();if(!a){console.warn(`[WSServer] Received 'identify' with empty nickname from ${t.id}. Disconnecting.`),n.send(JSON.stringify({type:"error",message:"Nickname cannot be empty."})),n.terminate(),this.clients.delete(n);return}if(this.clientsByNickname.has(a)){console.warn(`[WSServer] Nickname '${a}' already taken. Disconnecting client ${t.id}.`),n.send(JSON.stringify({type:"error",message:"Nickname already taken."})),n.terminate(),this.clients.delete(n);return}t.nickname=a,this.clientsByNickname.set(t.nickname,n),console.log(`[WSServer] Client identified: ID=${t.id}, Nickname='${t.nickname}'`),this.callbacks.onClientConnected(t.id,t.nickname)}else console.warn(`[WSServer] Received invalid 'identify' message (missing/invalid nickname) from ${t.id}. Disconnecting.`),n.send(JSON.stringify({type:"error",message:"Invalid identification payload (missing nickname)."})),n.terminate(),this.clients.delete(n)}else console.warn(`[WSServer] Received invalid first message type '${s.type}' from ${t.id}. Disconnecting.`),n.send(JSON.stringify({type:"error",message:"Identification required as first message."})),n.terminate(),this.clients.delete(n);return}s.senderNickname||(s.senderNickname=t.nickname),this.callbacks.onMessage(t.id,t.nickname,s)}_handleCloseOrError(n,e){let t=this.clients.get(n);t&&(this.clients.delete(n),t.nickname?(this.clientsByNickname.delete(t.nickname),console.log(`[WSServer] Client '${t.nickname}' (ID: ${t.id}) disconnected.`),this.callbacks.onClientDisconnected(t.id,t.nickname)):console.log(`[WSServer] Unidentified client (ID: ${t.id}) disconnected.`))}broadcast(n,e){let t=JSON.stringify(e);this.clients.forEach(s=>{if(s.ws.readyState===b.WebSocket.OPEN&&s.id!==n)try{s.ws.send(t)}catch(r){console.error(`[WSServer] Failed to broadcast to ${s.nickname||s.id}:`,r)}})}sendToClient(n,e){let t=null;for(let[s,r]of this.clients.entries())if(r.id===n){t=s;break}if(t&&t.readyState===b.WebSocket.OPEN)try{return t.send(JSON.stringify(e)),!0}catch(s){return console.error(`[WSServer] Failed to send message to client ID ${n}:`,s),this._handleCloseOrError(t,s),!1}return!1}sendToClientByNickname(n,e){let t=this.clientsByNickname.get(n);if(t&&t.readyState===b.WebSocket.OPEN)try{return t.send(JSON.stringify(e)),!0}catch(s){return console.error(`[WSServer] Failed to send message to client '${n}':`,s),this._handleCloseOrError(t,s),!1}return console.warn(`[WSServer] Client with nickname '${n}' not found for sending message.`),!1}findClientIdByNickname(n){var t;let e=this.clientsByNickname.get(n);return e&&((t=this.clients.get(e))==null?void 0:t.id)||null}handleLocalMessage(n,e){n.senderNickname!==this.serverNickname&&(console.warn(`[WSServer] handleLocalMessage: Payload sender '${n.senderNickname}' differs from server nickname '${this.serverNickname}'. Correcting.`),n.senderNickname=this.serverNickname),console.log(`[WSServer] Handling local message (Type: ${n.type}, To: ${e!=null?e:"broadcast"})`),this.callbacks.onMessage("local_server",this.serverNickname,n),e===null?(console.log(`[WSServer] Broadcasting local message type ${n.type}`),this.broadcast(null,n)):e===this.serverNickname?console.log(`[WSServer] Local message addressed to self (${e}), already handled.`):(console.log(`[WSServer] Sending local message privately to ${e}`),this.sendToClientByNickname(e,n)||console.warn(`[WSServer] Failed to send local private message: Recipient '${e}' not found or disconnected.`))}};var L=require("obsidian"),M=class{constructor(n){this.socket=null;this.serverAddress=null;this._isConnected=!1;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectDelay=5e3;this.requestedNickname=null;this.callbacks=n}get isConnected(){return this._isConnected&&!!this.socket&&this.socket.readyState===WebSocket.OPEN}connect(n,e){if(this.socket&&(this.socket.readyState===WebSocket.CONNECTING||this.socket.readyState===WebSocket.OPEN)){console.warn(`[WSClient] Already connected or connecting to ${this.serverAddress}.`);return}if(!n){console.error("[WSClient] Cannot connect: Server address is empty.");return}this.serverAddress=n,this.requestedNickname=e,this._isConnected=!1,console.log(`[WSClient] Attempting to connect to ${this.serverAddress}...`);try{this.socket=new WebSocket(this.serverAddress),this.socket.onopen=t=>this._handleOpen(t),this.socket.onmessage=t=>this._handleMessage(t),this.socket.onerror=t=>this._handleError(t),this.socket.onclose=t=>this._handleClose(t)}catch(t){console.error(`[WSClient] Error creating WebSocket connection to ${this.serverAddress}:`,t),this.callbacks.onError(t),this.socket=null}}disconnect(){this.socket&&(console.log(`[WSClient] Disconnecting from ${this.serverAddress}...`),this.reconnectAttempts=this.maxReconnectAttempts+1,this.socket.close(1e3,"Client disconnecting normally")),this.socket=null,this._isConnected=!1,this.serverAddress=null,this.requestedNickname=null}async sendMessage(n){return new Promise((e,t)=>{if(!this._isConnected||!this.socket||this.socket.readyState!==WebSocket.OPEN){console.warn("[WSClient] Cannot send message: Not connected."),t(new Error("WebSocket is not connected."));return}try{this.socket.send(JSON.stringify(n)),e()}catch(s){console.error("[WSClient] Error sending message:",s),this.callbacks.onError(s),t(s)}})}_handleOpen(n){if(console.log(`[WSClient] Connection opened successfully to ${this.serverAddress}`),this._isConnected=!0,this.reconnectAttempts=0,this.requestedNickname){let e={type:"identify",nickname:this.requestedNickname};console.log("[WSClient] Sending identification:",e),this.sendMessage(e).catch(t=>{console.error("[WSClient] Failed to send identification message:",t)})}else{console.error("[WSClient] Cannot identify: Nickname was not provided during connect."),this.disconnect();return}this.callbacks.onOpen(n)}_handleMessage(n){if(typeof n.data=="string")try{let e=JSON.parse(n.data);this.callbacks.onMessage(e)}catch(e){console.error("[WSClient] Received non-JSON text message or parse error:",n.data,e)}else n.data instanceof ArrayBuffer?console.log(`[WSClient] Received binary message (ArrayBuffer), ${n.data.byteLength} bytes.`):n.data instanceof Blob?console.log(`[WSClient] Received binary message (Blob), ${n.data.size} bytes.`):console.warn("[WSClient] Received message with unknown data type:",n.data)}_handleError(n){console.error("[WSClient] WebSocket error:",n),this._isConnected=!1,this.callbacks.onError(n)}_handleClose(n){if(console.warn(`[WSClient] WebSocket closed. Code: ${n.code}, Reason: '${n.reason}', Clean: ${n.wasClean}`),this._isConnected=!1,this.socket=null,this.callbacks.onClose(n),n.code!==1e3&&this.reconnectAttempts<this.maxReconnectAttempts){this.reconnectAttempts++;let e=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);console.log(`[WSClient] Attempting reconnect #${this.reconnectAttempts} in ${e/1e3}s...`),setTimeout(()=>{this.serverAddress&&this.requestedNickname?this.connect(this.serverAddress,this.requestedNickname):console.log("[WSClient] Cannot reconnect: connection info missing.")},e)}else n.code!==1e3&&(console.error(`[WSClient] Max reconnect attempts (${this.maxReconnectAttempts}) reached. Giving up.`),new L.Notice("Failed to reconnect to chat server.",1e4))}};var u=require("obsidian"),y=class extends u.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Local Chat Settings"}),new u.Setting(e).setName("Instance Role");let t=new u.Setting(e).setName("Server Address"),s=new u.Setting(e).setName("Server Port");this.plugin.settings.role==="server"&&!u.Platform.isMobile?(t.settingEl.style.display="none",s.settingEl.style.display=""):(t.settingEl.style.display="",s.settingEl.style.display="none"),u.Platform.isMobile&&(s.settingEl.style.display="none"),new u.Setting(e).setName("Your Nickname"),new u.Setting(e).setName("Save Chat History")}};var N={role:"client",serverAddress:"ws://127.0.0.1:61338",serverPort:61338,userNickname:`ObsidianUser_${Math.random().toString(36).substring(2,8)}`,saveHistory:!0,downloadPath:""};var E=class extends c.Plugin{constructor(){super(...arguments);this.chatView=null;this.webSocketClientManager=null;this.webSocketServerManager=null;this.outgoingFileOffers=new Map;this.incomingFileOffers=new Map;this.knownUsers=new Map}async onload(){let e=`[${this.manifest.name}]`;console.log(`${e} Loading plugin...`),await this.loadSettings(),console.log(`${e} Role: ${this.settings.role}. Nickname: ${this.settings.userNickname}.`);let t=this.createClientCallbacks(),s=this.createServerCallbacks();if(this.settings.role==="server")if(c.Platform.isMobile)new c.Notice("Error: 'Server' role is not supported on mobile.",1e4),console.error(`${e} Cannot start in server mode on mobile.`);else{console.log(`${e} Initializing in SERVER mode on port ${this.settings.serverPort}...`);try{if(typeof require=="undefined")throw new Error("'require' is not available.");let r=$(),a=r.WebSocketServer||r.Server;if(typeof a!="function")throw new Error('WebSocketServer class could not be obtained via require("ws").');this.webSocketServerManager=new C(this.settings.serverPort,this.settings.userNickname,s,a),await this.webSocketServerManager.start(),this.handleUserFound({nickname:this.settings.userNickname}),new c.Notice(`${this.manifest.name}: Server started on port ${this.settings.serverPort}.`)}catch(r){console.error(`${e} CRITICAL ERROR starting WebSocket server:`,r),new c.Notice(`[${this.manifest.name}] Failed to start server! Error: ${r.message}.`,1e4),this.webSocketServerManager=null}}else console.log(`${e} Initializing in CLIENT mode. Connecting to ${this.settings.serverAddress}...`),!this.settings.serverAddress||!this.settings.serverAddress.toLowerCase().startsWith("ws")?new c.Notice(`[${this.manifest.name}] Invalid server address: "${this.settings.serverAddress}".`,1e4):(this.webSocketClientManager=new M(t),this.webSocketClientManager.connect(this.settings.serverAddress,this.settings.userNickname));this.registerView(S,r=>(this.chatView=new w(r,this),this.chatView)),this.addRibbonIcon("message-circle","Open Local Chat",()=>this.activateView()),this.addCommand({id:"open-local-chat-view",name:"Open Local Chat panel",callback:()=>this.activateView()}),this.addSettingTab(new y(this.app,this)),console.log(`${e} Plugin UI initialized.`)}async onunload(){console.log(`[${this.manifest.name}] Unloading plugin...`),await this.cleanupNetworkServices(),this.app.workspace.detachLeavesOfType(S),this.chatView=null,this.outgoingFileOffers.clear(),this.incomingFileOffers.clear(),this.knownUsers.clear(),console.log(`[${this.manifest.name}] Plugin unloaded.`)}populateInitialChatViewState(){this.chatView&&this.knownUsers.forEach(e=>{var t;return(t=this.chatView)==null?void 0:t.addUserToList(e)})}async cleanupNetworkServices(){if(this.webSocketClientManager&&(this.webSocketClientManager.disconnect(),this.webSocketClientManager=null),this.webSocketServerManager){try{await this.webSocketServerManager.stop()}catch(e){console.error(`[${this.manifest.name}] Error stopping WebSocket server:`,e)}this.webSocketServerManager=null}console.log(`[${this.manifest.name}] Network services cleaned up.`)}createClientCallbacks(){return{onOpen:()=>{console.log(`[${this.manifest.name}] Client: Connected.`),new c.Notice("Chat connected.",3e3)},onClose:e=>{var t,s;console.warn(`[${this.manifest.name}] Client: Disconnected. Code: ${e.code}`),new c.Notice("Chat disconnected.",5e3),this.knownUsers.clear(),(s=(t=this.chatView)==null?void 0:t.clearUserList)==null||s.call(t)},onError:e=>{console.error(`[${this.manifest.name}] Client: WS Error`,e),new c.Notice(`Chat Connection Error: ${e instanceof Error?e.message:"Unknown"}`,5e3)},onMessage:e=>this.handleServerMessage(e)}}createServerCallbacks(){return{onClientConnected:(e,t)=>{var r;console.log(`[${this.manifest.name}] Server: Client '${t}' connected (ID: ${e})`),this.handleUserFound({nickname:t});let s={type:"userList",users:this.getAllUsers(),timestamp:Date.now()};(r=this.webSocketServerManager)==null||r.sendToClient(e,s)},onClientDisconnected:(e,t)=>{console.log(`[${this.manifest.name}] Server: Client '${t}' disconnected (ID: ${e})`),this.handleUserLeft({nickname:t})},onMessage:(e,t,s)=>this.handleClientMessage(e,t,s),onError:e=>{console.error(`[${this.manifest.name}] Server Error:`,e),new c.Notice(`Chat Server Error: ${e.message}`,5e3)}}}handleServerMessage(e){var t,s,r,a;switch(console.debug(`[${this.manifest.name}] Received from server:`,e),e.type){case"text":{let i=e,o=i.senderNickname||"Server";(t=this.chatView)==null||t.displayMessage(o,i.content,i.timestamp||Date.now(),!1);break}case"fileOffer":{let i=e,o=i.senderNickname||"Unknown Sender";this.incomingFileOffers.set(i.fileId,{...i,senderNickname:o}),(s=this.chatView)==null||s.displayFileOffer(o,i),this.isChatViewActive()||new c.Notice(`File offer '${i.filename}' from ${o}`);break}case"fileAccept":{let i=e;this.handleRemoteFileAccept(i.fileId,i.senderNickname);break}case"fileDecline":{let i=e;this.handleRemoteFileDecline(i.fileId,i.senderNickname);break}case"userList":{let i=e;this.knownUsers.clear(),i.users.forEach(o=>this.knownUsers.set(o.nickname,o)),(a=(r=this.chatView)==null?void 0:r.clearUserList)==null||a.call(r),this.knownUsers.forEach(o=>{var l;return(l=this.chatView)==null?void 0:l.addUserToList(o)});break}case"userJoin":{let i=e;this.handleUserFound({nickname:i.nickname});break}case"userLeave":{let i=e;this.handleUserLeft({nickname:i.nickname});break}case"error":{let i=e;console.error(`[${this.manifest.name}] Error from server:`,i.message),new c.Notice(`Server error: ${i.message}`,5e3);break}default:console.warn(`[${this.manifest.name}] Received unhandled message type from server:`,e.type)}}handleClientMessage(e,t,s){var r,a;if(this.webSocketServerManager)switch(s.senderNickname=t,s.timestamp=s.timestamp||Date.now(),s.type){case"text":{let i=s;if(!i.content)return;i.recipient?this.webSocketServerManager.sendToClientByNickname(i.recipient,i)||this.webSocketServerManager.sendToClient(e,{type:"error",message:`User '${i.recipient}' not found.`,timestamp:Date.now()}):this.webSocketServerManager.broadcast(e,i),(r=this.chatView)==null||r.displayMessage(i.senderNickname,i.content,i.timestamp,!1);break}case"fileOffer":{let i=s;if(!i.fileId||!i.filename||typeof i.size!="number"){console.warn("Invalid fileOffer received");break}i.recipient?this.webSocketServerManager.sendToClientByNickname(i.recipient,i)||this.webSocketServerManager.sendToClient(e,{type:"error",message:`User '${i.recipient}' not found for file offer.`,timestamp:Date.now()}):(this.webSocketServerManager.broadcast(e,i),this.incomingFileOffers.set(i.fileId,{...i,senderNickname:t,senderClientId:e}),(a=this.chatView)==null||a.displayFileOffer(t,i));break}case"fileAccept":case"fileDecline":{let i=s;if(!i.fileId||!i.originalSender){console.warn(`Invalid ${i.type} received (missing fileId or originalSender)`);break}this.webSocketServerManager.sendToClientByNickname(i.originalSender,i)||this.webSocketServerManager.sendToClient(e,{type:"error",message:`Original sender '${i.originalSender}' not found for file response.`,timestamp:Date.now()});break}default:console.warn(`[${this.manifest.name}] Received unhandled message type from client ${t}:`,s.type)}}handleUserFound(e){var t;if(!this.knownUsers.has(e.nickname)&&(console.log(`[${this.manifest.name}] User Found/Joined: ${e.nickname}`),this.knownUsers.set(e.nickname,e),(t=this.chatView)==null||t.addUserToList(e),this.settings.role==="server"&&this.webSocketServerManager&&e.nickname!==this.settings.userNickname)){let s={type:"userJoin",nickname:e.nickname,timestamp:Date.now()},r=this.webSocketServerManager.findClientIdByNickname(e.nickname);this.webSocketServerManager.broadcast(r,s)}}handleUserLeft(e){var t;if(this.knownUsers.delete(e.nickname)&&(console.log(`[${this.manifest.name}] User Left: ${e.nickname}`),(t=this.chatView)==null||t.removeUserFromList(e.nickname),this.settings.role==="server"&&this.webSocketServerManager)){let s={type:"userLeave",nickname:e.nickname,timestamp:Date.now()};this.webSocketServerManager.broadcast(null,s)}}getAllUsers(){return Array.from(this.knownUsers.values())}async sendMessage(e,t){var i,o;let s=this.settings.userNickname;if(!(t!=null&&t.trim()))return;let r=Date.now();(i=this.chatView)==null||i.displayMessage(s,t.trim(),r,!0);let a={type:"text",senderNickname:s,content:t.trim(),timestamp:r,recipient:e};try{if(this.settings.role==="client"&&((o=this.webSocketClientManager)!=null&&o.isConnected))await this.webSocketClientManager.sendMessage(a);else if(this.settings.role==="server"&&this.webSocketServerManager)this.webSocketServerManager.handleLocalMessage(a,e);else throw new Error("Chat service not ready.")}catch(l){console.error(`[${this.manifest.name}] Error sending message:`,l),new c.Notice(`Send Error: ${l.message}`)}}async initiateSendFile(e,t){var g,h,m,p;if(!(this.settings.role==="client"?(g=this.webSocketClientManager)==null?void 0:g.isConnected:!!this.webSocketServerManager)){new c.Notice("Chat service not ready.");return}let r=`file_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,a=e.name,i=e.size,o={fileId:r,filePath:"N/A - Use fileObject",fileObject:e,filename:a,size:i,recipientNickname:t};this.outgoingFileOffers.set(r,o),console.log(`[${this.manifest.name}] Initiating file send offer: ${a} (ID: ${r})`),(h=this.chatView)==null||h.displayUploadProgress({fileId:r,filename:a,size:i,recipientNickname:t});let l={type:"fileOffer",senderNickname:this.settings.userNickname,fileId:r,filename:a,size:i,recipient:t,timestamp:Date.now()};try{if(this.settings.role==="client"&&this.webSocketClientManager)await this.webSocketClientManager.sendMessage(l);else if(this.settings.role==="server"&&this.webSocketServerManager)this.webSocketServerManager.handleLocalMessage(l,t);else throw new Error("Chat service not configured.");console.log(`[${this.manifest.name}] File offer ${r} sent.`)}catch(v){console.error(`[${this.manifest.name}] Error sending fileOffer ${r}:`,v),new c.Notice(`Error sending file offer: ${v.message}`),this.outgoingFileOffers.delete(r),(p=(m=this.chatView)==null?void 0:m.updateFileProgress)==null||p.call(m,r,"upload",0,i,"error")}}async acceptFileOffer(e,t){var i,o,l,g,h;let s=this.incomingFileOffers.get(t);if(!s){new c.Notice("Error: File offer expired or invalid.");return}if(!(this.settings.role==="client"?(i=this.webSocketClientManager)==null?void 0:i.isConnected:!!this.webSocketServerManager)){new c.Notice("Chat service not ready.");return}console.log(`[${this.manifest.name}] Accepting file offer ${t} from ${e}`),(l=(o=this.chatView)==null?void 0:o.updateFileProgress)==null||l.call(o,t,"download",0,s.size,"accepted");let a={type:"fileAccept",senderNickname:this.settings.userNickname,fileId:t,originalSender:e,timestamp:Date.now()};try{if(this.settings.role==="client"&&this.webSocketClientManager)await this.webSocketClientManager.sendMessage(a);else if(this.settings.role==="server"&&this.webSocketServerManager){if(!this.webSocketServerManager.sendToClientByNickname(e,a))throw new Error(`Cannot send acceptance, user ${e} not found.`)}else throw new Error("Chat service not configured.");console.log(`[${this.manifest.name}] Acceptance for ${t} sent.`)}catch(m){console.error(`[${this.manifest.name}] Error sending file acceptance for ${t}:`,m),new c.Notice(`Error accepting file: ${m.message}`),this.incomingFileOffers.delete(t),(h=(g=this.chatView)==null?void 0:g.updateFileProgress)==null||h.call(g,t,"download",0,s.size,"error")}}async declineFileOffer(e,t){var i,o,l,g,h;let s=this.incomingFileOffers.get(t);if(!s){(o=(i=this.chatView)==null?void 0:i.updateFileProgress)==null||o.call(i,t,"download",0,0,"declined");return}console.log(`[${this.manifest.name}] Declining file offer ${t} from ${e}`),this.incomingFileOffers.delete(t),(g=(l=this.chatView)==null?void 0:l.updateFileProgress)==null||g.call(l,t,"download",0,s.size||0,"declined");let r={type:"fileDecline",senderNickname:this.settings.userNickname,fileId:t,originalSender:e,timestamp:Date.now()};if(this.settings.role==="client"?(h=this.webSocketClientManager)==null?void 0:h.isConnected:!!this.webSocketServerManager)try{this.settings.role==="client"&&this.webSocketClientManager?await this.webSocketClientManager.sendMessage(r):this.settings.role==="server"&&this.webSocketServerManager&&(this.webSocketServerManager.sendToClientByNickname(e,r)||console.warn(`[${this.manifest.name}] Cannot send decline, user ${e} not found.`)),console.log(`[${this.manifest.name}] Decline message for ${t} sent (or attempted).`)}catch(m){console.warn(`[${this.manifest.name}] Error sending file decline for ${t}: ${m.message}`)}}async handleRemoteFileAccept(e,t){var r,a,i,o;let s=this.outgoingFileOffers.get(e);if(!s){console.warn(`[${this.manifest.name}] Received accept for unknown outgoing offer ${e}`);return}if(!s.fileObject){console.error(`[${this.manifest.name}] Cannot start upload for ${e}: File object missing from offer state.`),new c.Notice(`Error starting upload: Cannot access file ${s.filename}`),this.outgoingFileOffers.delete(e),(a=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||a.call(r,e,"upload",0,s.size,"error");return}console.log(`[${this.manifest.name}] User ${t} accepted file ${s.filename}. Starting upload...`),(o=(i=this.chatView)==null?void 0:i.updateFileProgress)==null||o.call(i,e,"upload",0,s.size,"starting"),console.error("<<<<< FILE UPLOAD STREAMING (from File object) VIA WEBSOCKET IS NOT IMPLEMENTED >>>>>"),new c.Notice(`File upload streaming for ${s.filename} not implemented yet.`),setTimeout(()=>this.handleFileTransferError(e,"upload",new Error("Upload not implemented")),1500)}handleFileTransferError(e,t,s){var o,l;let r=`[${this.manifest.name}]`;console.error(`${r} File transfer error: ${e} (${t})`,s);let a=t==="upload"?this.outgoingFileOffers.get(e):this.incomingFileOffers.get(e),i=(a==null?void 0:a.filename)||"file";new c.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456 \u0444\u0430\u0439\u043B\u0443 '${i}': ${s.message}`,7e3),t==="upload"?this.outgoingFileOffers.delete(e)&&console.log(`${r} Removed outgoing offer state for ${e}`):this.incomingFileOffers.delete(e)&&console.log(`${r} Removed incoming offer state for ${e}`),(l=(o=this.chatView)==null?void 0:o.updateFileProgress)==null||l.call(o,e,t,0,0,"error")}handleRemoteFileDecline(e,t){var r,a;let s=this.outgoingFileOffers.get(e);s?(console.log(`[${this.manifest.name}] User ${t} declined file ${s.filename}`),new c.Notice(`User ${t} declined file: ${s.filename}`),this.outgoingFileOffers.delete(e),(a=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||a.call(r,e,"upload",0,s.size||0,"declined")):console.warn(`[${this.manifest.name}] Received remote decline for unknown outgoing offer ID: ${e}`)}async loadSettings(){this.settings=Object.assign({},N,await this.loadData())}async saveSettings(){await this.saveData(this.settings),console.log(`[${this.manifest.name}] Settings saved.`),new c.Notice("Some chat settings require restart.",5e3)}async activateView(){var r;let{workspace:e}=this.app,t=null,s=e.getLeavesOfType(S);if(s.length>0)t=s[0];else{let a=(r=e.getRightLeaf(!1))!=null?r:e.getLeftLeaf(!1);if(a)t=a,await t.setViewState({type:S,active:!0});else{console.error(`[${this.manifest.name}] \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 \u043F\u0430\u043D\u0435\u043B\u044C \u0434\u043B\u044F \u0447\u0430\u0442\u0443.`),new c.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0432\u0456\u0434\u043A\u0440\u0438\u0442\u0438 \u043F\u0430\u043D\u0435\u043B\u044C \u0447\u0430\u0442\u0443.");return}}t&&e.revealLeaf(t)}isChatViewActive(){let e=this.app.workspace.activeLeaf;return!!e&&e.getViewState().type===S}};
