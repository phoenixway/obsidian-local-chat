/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var z=Object.create;var E=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var L=(u,i)=>{for(var t in i)E(u,t,{get:i[t],enumerable:!0})},O=(u,i,t,e)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of R(i))!_.call(u,s)&&s!==t&&E(u,s,{get:()=>i[s],enumerable:!(e=B(i,s))||e.enumerable});return u};var y=(u,i,t)=>(t=u!=null?z(A(u)):{},O(i||!u||!u.__esModule?E(t,"default",{value:u,enumerable:!0}):t,u)),V=u=>O(E({},"__esModule",{value:!0}),u);var U={};L(U,{DEFAULT_SETTINGS:()=>N,default:()=>T});module.exports=V(U);var d=require("obsidian");var k=require("obsidian"),S="local-chat-view",P=class extends k.ItemView{constructor(t,e){super(t);this.knownUsers=new Map;this.plugin=e}getViewType(){return S}getDisplayText(){return"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0438\u0439 \u0427\u0430\u0442"}getIcon(){return"message-circle"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("local-chat-view-container");let e=t.createDiv({cls:"chat-sidebar"});e.createEl("h5",{text:"\u041E\u043D\u043B\u0430\u0439\u043D:",cls:"chat-user-list-header"}),this.userListEl=e.createDiv({cls:"chat-user-list"});let s=t.createDiv({cls:"chat-main-area"});this.messageContainerEl=s.createDiv({cls:"chat-message-area"}),this.messageContainerEl.id="chat-message-area-id";let n=s.createDiv({cls:"chat-input-area"});this.inputEl=n.createEl("input",{type:"text",placeholder:"\u0412\u0432\u0435\u0434\u0456\u0442\u044C \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F...",cls:"chat-input"}),this.sendButtonEl=n.createEl("button",{cls:"chat-send-button"}),(0,k.setIcon)(this.sendButtonEl,"send-horizontal"),this.sendButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438"),this.fileButtonEl=n.createEl("button",{cls:"chat-file-button"}),(0,k.setIcon)(this.fileButtonEl,"paperclip"),this.fileButtonEl.setAttribute("aria-label","\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B"),this.fileButtonEl.onClickEvent(this.handleSendFileClick.bind(this)),this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.handleSendMessage())}),this.sendButtonEl.addEventListener("click",()=>{this.handleSendMessage()}),console.log(`[${this.plugin.manifest.name}] ChatView \u0432\u0456\u0434\u043A\u0440\u0438\u0442\u043E`),this.inputEl.focus()}handleSendFileClick(){let t=createEl("input",{type:"file"});t.onchange=async e=>{if(!t.files||t.files.length===0)return;let s=null;for(let n=0;n<t.files.length;n++){let r=t.files[n];console.log(`\u041E\u0431\u0440\u0430\u043D\u043E \u0444\u0430\u0439\u043B: ${r.name}, \u0440\u043E\u0437\u043C\u0456\u0440: ${r.size}`),await this.plugin.initiateSendFile(r,s)}t.value=""},t.click()}async onClose(){console.log(`[${this.plugin.manifest.name}] ChatView \u0437\u0430\u043A\u0440\u0438\u0442\u043E`)}handleSendMessage(){let t=this.inputEl.value.trim();if(t)try{this.plugin.sendMessage(null,t),this.inputEl.value="",this.inputEl.focus()}catch(e){console.error(`[${this.plugin.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F:`,e),new k.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F.")}}displayMessage(t,e,s,n){let r=this.messageContainerEl.createDiv({cls:`chat-message ${n?"own-message":"other-message"}`}),l=r.createDiv({cls:"message-header"});l.createSpan({cls:"message-sender",text:n?"\u0412\u0438":t}),l.createSpan({cls:"message-timestamp",text:new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let a=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");r.createDiv({cls:"message-content"}).innerHTML=a,this.scrollToBottom()}addUserToList(t){if(this.knownUsers.has(t.nickname)){let n=this.knownUsers.get(t.nickname);n!=null&&n.element&&(n.element.removeClass("user-offline"),n.element.addClass("user-online"));return}let e=this.userListEl.createDiv({cls:"chat-user-list-item user-online"});e.dataset.nickname=t.nickname;let s=e.createSpan({cls:"user-icon"});(0,k.setIcon)(s,"user"),e.createSpan({cls:"user-nickname",text:t.nickname}),this.knownUsers.set(t.nickname,{...t,element:e})}removeUserFromList(t){let e=this.knownUsers.get(t);e!=null&&e.element?(e.element.remove(),this.knownUsers.delete(t)):console.warn(`[${this.plugin.manifest.name}] \u0421\u043F\u0440\u043E\u0431\u0430 \u0432\u0438\u0434\u0430\u043B\u0438\u0442\u0438 \u043D\u0435\u0456\u0441\u043D\u0443\u044E\u0447\u043E\u0433\u043E \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0430 \u0437\u0456 \u0441\u043F\u0438\u0441\u043A\u0443: ${t}`)}clearMessages(){this.messageContainerEl.empty(),new k.Notice("\u0406\u0441\u0442\u043E\u0440\u0456\u044E \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u044C \u043E\u0447\u0438\u0449\u0435\u043D\u043E (\u0432 \u043F\u043E\u0442\u043E\u0447\u043D\u043E\u043C\u0443 \u0432\u0456\u043A\u043D\u0456).")}displayFileOffer(t,e){let s=this.messageContainerEl.createDiv({cls:"chat-message file-offer",attr:{"data-file-id":e.fileId}}),n=s.createDiv({cls:"message-header"});n.createSpan({cls:"message-sender",text:t}),n.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let r=s.createDiv({cls:"message-content"});r.setText(`${t} \u043F\u0440\u043E\u043F\u043E\u043D\u0443\u0454 \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u0444\u0430\u0439\u043B: `),r.createEl("strong",{text:e.filename}),r.createSpan({text:` (${this.formatFileSize(e.size)})`});let l=s.createDiv({cls:"file-offer-actions"});l.createEl("button",{text:"\u041F\u0440\u0438\u0439\u043D\u044F\u0442\u0438"}).addEventListener("click",()=>{this.plugin.acceptFileOffer(t,e.fileId),this.updateFileProgress(e.fileId,"download",0,e.size,"accepted")}),l.createEl("button",{text:"\u0412\u0456\u0434\u0445\u0438\u043B\u0438\u0442\u0438",cls:"mod-danger"}).addEventListener("click",()=>{this.plugin.declineFileOffer(t,e.fileId),this.updateFileProgress(e.fileId,"download",0,e.size,"declined")}),this.scrollToBottom()}updateFileProgress(t,e,s,n,r){let l=this.messageContainerEl.querySelector(`.chat-message[data-file-id="${t}"]`);if(!l)if(e==="upload"){console.warn(`UI element for uploading file ${t} not implemented yet.`);return}else{console.warn(`Could not find message element for file transfer ${t} to update progress.`);return}let a=l.querySelector(".file-progress-container");if(!a){a=l.createDiv({cls:"file-progress-container"});let f=l.querySelector(".file-offer-actions");f&&f.empty()}a.empty();let o=n>0?Math.round(s/n*100):0,c=a.createEl("progress");c.max=n,c.value=s;let g=a.createSpan({cls:"progress-text"});switch(r){case"starting":g.setText(e==="download"?" \u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u043F\u043E\u0447\u0430\u043B\u043E\u0441\u044F... 0%":" \u0412\u0456\u0434\u043F\u0440\u0430\u0432\u043A\u0430 \u043F\u043E\u0447\u0430\u043B\u0430\u0441\u044F... 0%");break;case"progressing":g.setText(` ${o}% (${this.formatFileSize(s)} / ${this.formatFileSize(n)})`);break;case"completed":c.remove();let f=e==="download"?"\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.":"\u041D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0443\u0441\u043F\u0456\u0448\u043D\u043E.";g.setText(` ${f} (${this.formatFileSize(n)})`),l.addClass("transfer-completed");break;case"error":c.remove(),g.setText(" \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456."),g.addClass("progress-error"),l.addClass("transfer-error");break;case"accepted":g.setText(" \u041F\u0440\u0438\u0439\u043D\u044F\u0442\u043E. \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0434\u0430\u043D\u0438\u0445..."),l.removeClass("offer-declined"),l.addClass("offer-accepted");break;case"declined":c.remove(),g.setText(" \u0412\u0456\u0434\u0445\u0438\u043B\u0435\u043D\u043E."),l.removeClass("offer-accepted"),l.addClass("offer-declined");break}this.scrollToBottom()}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,s=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+s[n]}scrollToBottom(){setTimeout(()=>{this.messageContainerEl.scrollTop=this.messageContainerEl.scrollHeight},50)}displayUploadProgress(t){let e=this.messageContainerEl.createDiv({cls:"chat-message own-message file-upload",attr:{"data-file-id":t.fileId}}),s=e.createDiv({cls:"message-header"});s.createSpan({cls:"message-sender",text:"\u0412\u0438"}),s.createSpan({cls:"message-timestamp",text:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})});let n=e.createDiv({cls:"message-content"});n.setText("\u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443: "),n.createEl("strong",{text:t.filename}),n.createSpan({text:` (${this.formatFileSize(t.size)})`}),t.recipientNickname&&n.createSpan({text:` \u0434\u043E ${t.recipientNickname}`}),e.createDiv({cls:"file-progress-container"}),this.updateFileProgress(t.fileId,"upload",0,t.size,"starting"),this.scrollToBottom()}};var M=y(require("net")),$=y(require("fs")),x=y(require("path")),C=class{constructor(i,t){this.server=null;this.activeServerSockets=new Map;this.receivingFiles=new Map;this.sendingFiles=new Map;this.socketBuffers=new Map;if(this.port=i,this.callbacks=t,!t)throw new Error("NetworkManager callbacks are required.");let e=["onMessageReceived","onFileOfferReceived","onFileAcceptReceived","onFileDeclineReceived","onFileTransferStart","onFileTransferProgress","onFileTransferComplete","onFileTransferError","onNetworkError"];for(let s of e)typeof t[s]!="function"&&(console.warn(`NetworkManager: Callback '${s}' is missing or not a function.`),t[s]=(...n)=>{console.warn(`NetworkManager: Called missing callback '${s}' with args:`,n)})}startServer(){return new Promise((i,t)=>{if(this.server){console.warn("NetworkManager: Server is already running."),i();return}this.server=M.createServer(),this.server.on("connection",e=>{this._handleConnection(e)}),this.server.on("error",e=>{console.error("NetworkManager: Server error:",e),this.callbacks.onNetworkError("Server listen",e),this.server=null,t(e)}),this.server.on("close",()=>{console.log("NetworkManager: Server closed."),this.server=null,this.activeServerSockets.clear(),this.socketBuffers.clear()}),this.server.listen(this.port,()=>{var n,r;let e=(n=this.server)==null?void 0:n.address(),s=typeof e=="string"?this.port:(r=e==null?void 0:e.port)!=null?r:this.port;console.log(`NetworkManager: Server listening on port ${s}`),i()})})}stopServer(){return new Promise(i=>{if(!this.server){i();return}console.log("NetworkManager: Stopping server..."),this.activeServerSockets.forEach((t,e)=>{t.destroyed||t.destroy()}),this.activeServerSockets.clear(),this.socketBuffers.clear(),this.receivingFiles.forEach(t=>this._cleanupReceivingFile(t.fileId,new Error("Server stopped"))),this.sendingFiles.forEach(t=>this._cleanupSendingFile(t.fileId,new Error("Server stopped"))),this.server.close(t=>{t&&(console.error("NetworkManager: Error closing server:",t),this.callbacks.onNetworkError("Server close",t)),this.server=null,console.log("NetworkManager: Server stopped successfully."),i()})})}_handleConnection(i){var s,n;let t=`${i.remoteAddress}:${i.remotePort}`,e=t;console.log(`NetworkManager: Client connected: ${t}`),this.activeServerSockets.set(e,i),this.socketBuffers.set(e,""),(n=(s=this.callbacks).onClientConnected)==null||n.call(s,{ip:i.remoteAddress||"unknown",port:i.remotePort||0}),i.on("data",r=>{this._handleData(i,e,r)}),i.on("end",()=>{console.log(`NetworkManager: Client disconnected (end): ${t}`),this._handleDisconnect(e)}),i.on("close",r=>{console.log(`NetworkManager: Client connection closed (hadError: ${r}): ${t}`),this._handleDisconnect(e)}),i.on("error",r=>{console.error(`NetworkManager: Socket error from ${t}:`,r),this.callbacks.onNetworkError(`Socket ${t}`,r),this._handleDisconnect(e),i.destroy()})}_handleDisconnect(i){var s,n;let t=this.activeServerSockets.get(i);t&&((n=(s=this.callbacks).onClientDisconnected)==null||n.call(s,{ip:t.remoteAddress||"unknown",port:t.remotePort||0}));let e=null;if(this.receivingFiles.forEach((r,l)=>{r.socket===t&&(e=l)}),e){console.warn(`NetworkManager: Connection closed during file receive: ${e}`);let r=this.receivingFiles.get(e);r&&r.receivedBytes<r.expectedSize?this._cleanupReceivingFile(e,new Error(`Connection closed prematurely after ${r.receivedBytes}/${r.expectedSize} bytes`)):r&&this._finalizeReceivingFile(e)}this.activeServerSockets.delete(i),this.socketBuffers.delete(i),console.log(`NetworkManager: Cleaned up resources for ${i}`)}_handleData(i,t,e){let s=`${i.remoteAddress}:${i.remotePort}`,n=(this.socketBuffers.get(t)||"")+e.toString("utf-8"),r;if(this.receivingFiles.forEach(o=>{o.socket===i&&(r=o)}),r){try{r.writeStream.write(e),r.receivedBytes+=e.length,this.callbacks.onFileTransferProgress(r.fileId,"download",r.receivedBytes,r.expectedSize),r.receivedBytes>=r.expectedSize&&console.log(`NetworkManager: Received expected bytes for file ${r.fileId}`)}catch(o){console.error(`NetworkManager: Error writing file chunk for ${r.fileId}:`,o),this._cleanupReceivingFile(r.fileId,o),i.destroy()}this.socketBuffers.set(t,"");return}let l=-1,a=0;for(let o=0;o<n.length;o++)if(n[o]===`
`){let c=n.substring(a,o).trim();if(l=o,a=o+1,c)try{let g=JSON.parse(c);g.type==="fileDataHeader"&&g.fileId?this._handleFileHeader(i,g.fileId):this._processJsonMessage(i,g)}catch(g){console.warn(`NetworkManager: Received non-JSON message or parse error from ${s}:`,c,g)}}l===-1?this.socketBuffers.set(t,n):this.socketBuffers.set(t,n.substring(a))}_handleFileHeader(i,t){let e=this.receivingFiles.get(t);e?(console.log(`NetworkManager: Received file header for ${t}. Starting download.`),e.socket=i,this.callbacks.onFileTransferStart(t,"download",e.expectedSize)):(console.error(`NetworkManager: Received file header for unknown or unprepared file transfer: ${t}. Closing connection.`),i.end())}_processJsonMessage(i,t){let e={ip:i.remoteAddress||"unknown",port:i.remotePort||0};switch(this.callbacks.onMessageReceived(e,t),t.type){case"fileOffer":t.fileId&&t.filename&&typeof t.size=="number"?this.callbacks.onFileOfferReceived(e,{fileId:t.fileId,filename:t.filename,size:t.size}):console.warn("NetworkManager: Received invalid fileOffer:",t);break;case"fileAccept":t.fileId?this.callbacks.onFileAcceptReceived(e,t.fileId):console.warn("NetworkManager: Received invalid fileAccept:",t);break;case"fileDecline":t.fileId?this.callbacks.onFileDeclineReceived(e,t.fileId):console.warn("NetworkManager: Received invalid fileDecline:",t);break}}sendData(i,t,e){return new Promise((s,n)=>{let r=new M.Socket,l=!1;r.connect(t,i,()=>{l=!0,console.log(`NetworkManager: Connected to ${i}:${t} for sending data.`);try{let a=JSON.stringify(e)+`
`;r.write(a,"utf-8",o=>{o?(console.error(`NetworkManager: Error writing data to ${i}:${t}:`,o),this.callbacks.onNetworkError(`Send data to ${i}:${t}`,o),r.destroy(),n(o)):(console.log(`NetworkManager: Data sent successfully to ${i}:${t}`),r.end(),s())})}catch(a){console.error("NetworkManager: Error stringifying payload or writing:",a),this.callbacks.onNetworkError(`Send data (prepare) to ${i}:${t}`,a),r.destroy(),n(a)}}),r.on("error",a=>{console.error(l?`NetworkManager: Socket error after connection to ${i}:${t}:`:`NetworkManager: Connection error to ${i}:${t}:`,a.message),this.callbacks.onNetworkError(`Connect/Send to ${i}:${t}`,a),n(a),r.destroy()}),r.on("close",a=>{})})}prepareToReceiveFile(i,t,e,s){return new Promise((n,r)=>{if(this.receivingFiles.has(i)){console.warn(`NetworkManager: Already preparing to receive file ${i}.`),r(new Error(`Already receiving file with ID ${i}`));return}try{let l=x.dirname(t);$.existsSync(l)||($.mkdirSync(l,{recursive:!0}),console.log(`NetworkManager: Created directory ${l} for receiving file.`));let a=$.createWriteStream(t),o={fileId:i,filePath:t,writeStream:a,receivedBytes:0,expectedSize:e,senderInfo:s};a.on("error",c=>{console.error(`NetworkManager: WriteStream error for ${i} (${t}):`,c),this._cleanupReceivingFile(i,c),r(c)}),a.on("open",()=>{console.log(`NetworkManager: Ready to receive file ${i} at ${t}`),this.receivingFiles.set(i,o),n()}),a.on("close",()=>{console.log(`NetworkManager: WriteStream closed for ${i}`)})}catch(l){console.error(`NetworkManager: Error preparing to receive file ${i}:`,l),this.callbacks.onNetworkError(`Prepare receive ${i}`,l),r(l)}})}startFileTransfer(i,t,e,s){return new Promise(async(n,r)=>{console.log(`NetworkManager: Starting file transfer ${e} to ${i}:${t} from ${s}`);let l;try{if(l=await $.promises.stat(s),!l.isFile())throw new Error("Source path is not a file.")}catch(h){console.error(`NetworkManager: Error accessing file ${s}:`,h),this.callbacks.onFileTransferError(e,"upload",h),r(h);return}let a=l.size,o=new M.Socket,c={fileId:e,filePath:s,socket:o,receiverInfo:`${i}:${t}`,sentBytes:0,totalSize:a};this.sendingFiles.set(e,c);let g=!1,f=!1;o.connect(t,i,()=>{console.log(`NetworkManager: Connected to ${i}:${t} for file transfer ${e}.`);let h={type:"fileDataHeader",fileId:e};o.write(JSON.stringify(h)+`
`,"utf-8",w=>{if(w){console.error(`NetworkManager: Error sending file header for ${e}:`,w),this._cleanupSendingFile(e,w),r(w);return}g=!0,console.log(`NetworkManager: File header sent for ${e}. Starting stream.`);try{let p=$.createReadStream(s);c.readStream=p,f=!0,this.callbacks.onFileTransferStart(e,"upload",a),p.on("data",m=>{let F=o.write(m);c.sentBytes+=m.length,this.callbacks.onFileTransferProgress(e,"upload",c.sentBytes,a),F||(p.pause(),o.once("drain",()=>{p.resume()}))}),p.on("end",()=>{console.log(`NetworkManager: File stream ended for ${e}. All data sent.`),o.end(),n()}),p.on("error",m=>{console.error(`NetworkManager: ReadStream error for ${e}:`,m),this._cleanupSendingFile(e,m),r(m)}),p.on("close",()=>{console.log(`NetworkManager: ReadStream closed for ${e}`)})}catch(p){console.error(`NetworkManager: Error creating ReadStream for ${e}:`,p),this._cleanupSendingFile(e,p),r(p)}})}),o.on("error",h=>{console.error(`NetworkManager: File transfer socket error for ${e} to ${i}:${t}:`,h.message),g?f&&this._cleanupSendingFile(e,h):(this._cleanupSendingFile(e,h),r(h))}),o.on("close",h=>{if(console.log(`NetworkManager: File transfer connection closed for ${e} (hadError: ${h})`),h&&this.sendingFiles.has(e)){let w=new Error(`Connection closed with error during upload of ${e}`);this._cleanupSendingFile(e,w),r(w)}else if(!h&&this.sendingFiles.has(e)&&c.sentBytes===c.totalSize)this.callbacks.onFileTransferComplete(e,"upload",null),this.sendingFiles.delete(e);else if(this.sendingFiles.has(e)){let w=new Error(`Connection closed prematurely during upload of ${e}`);this._cleanupSendingFile(e,w),r(w)}})})}_finalizeReceivingFile(i){let t=this.receivingFiles.get(i);if(t){if(console.log(`NetworkManager: Finalizing received file ${i} at ${t.filePath}`),t.receivedBytes!==t.expectedSize){console.warn(`NetworkManager: File ${i} received size mismatch! Expected ${t.expectedSize}, got ${t.receivedBytes}.`),this._cleanupReceivingFile(i,new Error(`Size mismatch: expected ${t.expectedSize}, received ${t.receivedBytes}`));return}t.writeStream.end(()=>{console.log(`NetworkManager: WriteStream finalized for ${i}`),this.callbacks.onFileTransferComplete(i,"download",t.filePath),this.receivingFiles.delete(i),t.socket&&!t.socket.destroyed&&t.socket.destroy()})}}_cleanupReceivingFile(i,t){let e=this.receivingFiles.get(i);e&&(console.error(`NetworkManager: Cleaning up receiving file ${i} due to error:`,t.message),e.writeStream.end(),e.writeStream.close(async()=>{try{$.existsSync(e.filePath)&&(await $.promises.unlink(e.filePath),console.log(`NetworkManager: Deleted incomplete file ${e.filePath}`))}catch(s){console.error(`NetworkManager: Error deleting incomplete file ${e.filePath}:`,s)}finally{this.callbacks.onFileTransferError(i,"download",t),this.receivingFiles.delete(i),e.socket&&!e.socket.destroyed&&e.socket.destroy()}}))}_cleanupSendingFile(i,t){let e=this.sendingFiles.get(i);e&&(console.error(`NetworkManager: Cleaning up sending file ${i} due to error:`,t.message),e.readStream&&!e.readStream.destroyed&&e.readStream.destroy(),e.socket.destroyed||e.socket.destroy(),this.callbacks.onFileTransferError(i,"upload",t),this.sendingFiles.delete(i))}};var b=y(require("fs")),v=y(require("path")),N={userNickname:`ObsidianUser_${Math.random().toString(36).substring(2,8)}`,listenPort:61337,saveHistory:!0,downloadPath:""},T=class extends d.Plugin{constructor(){super(...arguments);this.chatView=null;this.networkManager=null;this.outgoingFileOffers=new Map;this.incomingFileOffers=new Map}async onload(){console.log(`[${this.manifest.name}] \u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u043F\u043B\u0430\u0433\u0456\u043D\u0443...`),await this.loadSettings(),console.log(`[${this.manifest.name}] \u0412\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0454\u0442\u044C\u0441\u044F \u043F\u0441\u0435\u0432\u0434\u043E\u043D\u0456\u043C: ${this.settings.userNickname}`),console.log(`[${this.manifest.name}] \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u0438\u0439 \u043F\u043E\u0440\u0442: ${this.settings.listenPort}`);let t={onMessageReceived:this.handleIncomingMessage.bind(this),onFileOfferReceived:this.handleIncomingFileOffer.bind(this),onFileAcceptReceived:this.handleFileAcceptReceived.bind(this),onFileDeclineReceived:this.handleFileDeclineReceived.bind(this),onFileTransferStart:this.handleFileTransferStart.bind(this),onFileTransferProgress:this.handleFileTransferProgress.bind(this),onFileTransferComplete:this.handleFileTransferComplete.bind(this),onFileTransferError:this.handleFileTransferError.bind(this),onClientConnected:e=>{console.log(`[${this.manifest.name}] \u041A\u043B\u0456\u0454\u043D\u0442 \u043F\u0456\u0434\u043A\u043B\u044E\u0447\u0438\u0432\u0441\u044F: ${e.ip}:${e.port}`)},onClientDisconnected:e=>{console.log(`[${this.manifest.name}] \u041A\u043B\u0456\u0454\u043D\u0442 \u0432\u0456\u0434\u043A\u043B\u044E\u0447\u0438\u0432\u0441\u044F: ${e.ip}:${e.port}`)},onNetworkError:(e,s)=>{s.message.includes("ECONNREFUSED")||s.message.includes("ETIMEDOUT")?console.warn(`[${this.manifest.name}] \u041C\u0435\u0440\u0435\u0436\u0435\u0432\u0430 \u043F\u043E\u043C\u0438\u043B\u043A\u0430 (${e}): ${s.message}`):(console.error(`[${this.manifest.name}] \u0421\u0435\u0440\u0439\u043E\u0437\u043D\u0430 \u043C\u0435\u0440\u0435\u0436\u0435\u0432\u0430 \u043F\u043E\u043C\u0438\u043B\u043A\u0430 (${e}):`,s),new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043C\u0435\u0440\u0435\u0436\u0456 (${e}): ${s.message}`))}};this.networkManager=new C(this.settings.listenPort,t);try{await this.networkManager.startServer(),console.log(`[${this.manifest.name}] TCP \u0441\u0435\u0440\u0432\u0435\u0440 \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u043E \u043D\u0430 \u043F\u043E\u0440\u0442\u0456 ${this.settings.listenPort}.`),new d.Notice(`[${this.manifest.name}] \u0427\u0430\u0442 \u0430\u043A\u0442\u0438\u0432\u043D\u0438\u0439.`)}catch(e){console.error(`[${this.manifest.name}] \u041A\u0420\u0418\u0422\u0418\u0427\u041D\u0410 \u041F\u041E\u041C\u0418\u041B\u041A\u0410 \u0437\u0430\u043F\u0443\u0441\u043A\u0443 \u043C\u0435\u0440\u0435\u0436\u0435\u0432\u0438\u0445 \u0441\u0435\u0440\u0432\u0456\u0441\u0456\u0432:`,e),new d.Notice(`[${this.manifest.name}] \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u0438 \u0441\u0435\u0440\u0432\u0456\u0441\u0438 \u0447\u0430\u0442\u0443! \u041F\u043E\u043C\u0438\u043B\u043A\u0430: ${e.message}. \u0424\u0443\u043D\u043A\u0446\u0456\u043E\u043D\u0430\u043B \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0438\u0439.`),this.networkManager&&(await this.networkManager.stopServer(),this.networkManager=null);return}this.registerView(S,e=>(this.chatView=new P(e,this),this.chatView)),this.addRibbonIcon("message-circle","\u0412\u0456\u0434\u043A\u0440\u0438\u0442\u0438 \u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0438\u0439 \u0427\u0430\u0442",e=>{this.activateView()}),this.addCommand({id:"open-local-chat-view",name:"\u0412\u0456\u0434\u043A\u0440\u0438\u0442\u0438 \u043F\u0430\u043D\u0435\u043B\u044C \u041B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0427\u0430\u0442\u0443",callback:()=>{this.activateView()}}),this.addSettingTab(new D(this.app,this)),console.log(`[${this.manifest.name}] \u041F\u043B\u0430\u0433\u0456\u043D \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u0437\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E \u0442\u0430 \u0433\u043E\u0442\u043E\u0432\u0438\u0439 \u0434\u043E \u0440\u043E\u0431\u043E\u0442\u0438.`)}async onunload(){if(console.log(`[${this.manifest.name}] \u0412\u0438\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u043F\u043B\u0430\u0433\u0456\u043D\u0443...`),this.networkManager){try{await this.networkManager.stopServer(),console.log(`[${this.manifest.name}] TCP \u0441\u0435\u0440\u0432\u0435\u0440 \u0437\u0443\u043F\u0438\u043D\u0435\u043D\u043E.`)}catch(t){console.error(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u0437\u0443\u043F\u0438\u043D\u043A\u0438 NetworkManager:`,t)}this.networkManager=null}this.app.workspace.detachLeavesOfType(S),this.chatView=null,this.outgoingFileOffers.clear(),this.incomingFileOffers.clear(),console.log(`[${this.manifest.name}] \u041F\u043B\u0430\u0433\u0456\u043D \u0432\u0438\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E.`)}handleIncomingMessage(t,e){var n;console.log(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E message \u0432\u0456\u0434 ${t.ip}:${t.port}`,e);let s=e.senderNickname||`${t.ip}:${t.port}`;e.type==="text"&&e.content?((n=this.chatView)==null||n.displayMessage(s,e.content,e.timestamp||Date.now(),!1),this.isChatViewActive()||new d.Notice(`${s}: ${e.content.substring(0,50)}${e.content.length>50?"...":""}`)):console.warn(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E \u043D\u0435\u0432\u0456\u0434\u043E\u043C\u0438\u0439 \u0442\u0438\u043F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0430\u0431\u043E \u043D\u0435 'text':`,e)}handleIncomingFileOffer(t,e){var n;console.log(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E fileOffer \u0432\u0456\u0434 ${t.ip}:${t.port}`,e);let s="UnknownSender";this.incomingFileOffers.set(e.fileId,{...e,senderNickname:s,senderAddress:`${t.ip}:${t.port}`}),(n=this.chatView)==null||n.displayFileOffer(s,e),this.isChatViewActive()||new d.Notice(`\u041F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u044F \u0444\u0430\u0439\u043B\u0443 '${e.filename}' \u0432\u0456\u0434 ${s}`)}handleFileAcceptReceived(t,e){console.log(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E fileAccept \u0434\u043B\u044F ${e} \u0432\u0456\u0434 ${t.ip}:${t.port}`);let s=this.outgoingFileOffers.get(e);s&&this.networkManager?(console.log(`[${this.manifest.name}] \u041F\u043E\u0447\u0438\u043D\u0430\u0454\u043C\u043E \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443 ${s.filename} (${s.filePath})`),this.networkManager.startFileTransfer(t.ip,t.port,e,s.filePath).then(()=>{var n,r;console.log(`[${this.manifest.name}] StartFileTransfer \u0434\u043B\u044F ${e} \u0456\u043D\u0456\u0446\u0456\u0439\u043E\u0432\u0430\u043D\u043E.`),(r=(n=this.chatView)==null?void 0:n.updateFileProgress)==null||r.call(n,e,"upload",0,s.size,"starting")}).catch(n=>{var r,l;console.error(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u0456\u043D\u0456\u0446\u0456\u0430\u043B\u0456\u0437\u0430\u0446\u0456\u0457 startFileTransfer \u0434\u043B\u044F ${e}:`,n),new d.Notice(`\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043F\u043E\u0447\u0430\u0442\u0438 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0443 \u0444\u0430\u0439\u043B\u0443 ${s.filename}.`),this.outgoingFileOffers.delete(e),(l=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||l.call(r,e,"upload",0,s.size,"error")})):console.error(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E fileAccept \u0434\u043B\u044F \u043D\u0435\u0432\u0456\u0434\u043E\u043C\u043E\u0433\u043E \u0430\u0431\u043E \u043D\u0435\u0430\u043A\u0442\u0438\u0432\u043D\u043E\u0433\u043E fileId: ${e}`)}handleFileDeclineReceived(t,e){var n,r;console.log(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E fileDecline \u0434\u043B\u044F ${e} \u0432\u0456\u0434 ${t.ip}:${t.port}`);let s=this.outgoingFileOffers.get(e);s?(new d.Notice(`\u041A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447 \u0432\u0456\u0434\u0445\u0438\u043B\u0438\u0432 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0443 \u0444\u0430\u0439\u043B\u0443: ${s.filename}`),this.outgoingFileOffers.delete(e),(r=(n=this.chatView)==null?void 0:n.updateFileProgress)==null||r.call(n,e,"upload",0,s.size||0,"declined")):console.warn(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0430\u043D\u043E fileDecline \u0434\u043B\u044F \u043D\u0435\u0432\u0456\u0434\u043E\u043C\u043E\u0433\u043E fileId: ${e}`)}handleFileTransferStart(t,e,s){var n,r;console.log(`[${this.manifest.name}] \u041F\u043E\u0447\u0430\u0442\u043E\u043A \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456 \u0444\u0430\u0439\u043B\u0443 ${t} (${e}), \u0440\u043E\u0437\u043C\u0456\u0440: ${s}`),(r=(n=this.chatView)==null?void 0:n.updateFileProgress)==null||r.call(n,t,e,0,s,"starting")}handleFileTransferProgress(t,e,s,n){var r,l;console.log(`[${this.manifest.name}] \u041F\u0440\u043E\u0433\u0440\u0435\u0441 ${t} (${e}): ${s}/${n}`),(l=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||l.call(r,t,e,s,n,"progressing")}handleFileTransferComplete(t,e,s){var n,r,l,a;if(e==="download"&&s){let o=this.incomingFileOffers.get(t),c=(o==null?void 0:o.filename)||v.basename(s);console.log(`[${this.manifest.name}] \u0424\u0430\u0439\u043B ${t} (${c}) \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u043E\u0442\u0440\u0438\u043C\u0430\u043D\u043E: ${s}`),new d.Notice(`\u0424\u0430\u0439\u043B '${c}' \u0437\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043E.`),this.incomingFileOffers.delete(t),(r=(n=this.chatView)==null?void 0:n.updateFileProgress)==null||r.call(n,t,e,(o==null?void 0:o.size)||0,(o==null?void 0:o.size)||0,"completed")}else if(e==="upload"){let o=this.outgoingFileOffers.get(t),c=(o==null?void 0:o.filename)||"\u0444\u0430\u0439\u043B";console.log(`[${this.manifest.name}] \u0424\u0430\u0439\u043B ${t} (${c}) \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E.`),new d.Notice(`\u0424\u0430\u0439\u043B '${c}' \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E.`),this.outgoingFileOffers.delete(t),(a=(l=this.chatView)==null?void 0:l.updateFileProgress)==null||a.call(l,t,e,(o==null?void 0:o.size)||0,(o==null?void 0:o.size)||0,"completed")}}handleFileTransferError(t,e,s){var r,l,a,o;console.error(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456 \u0444\u0430\u0439\u043B\u0443 ${t} (${e}):`,s);let n=(e==="upload"?(r=this.outgoingFileOffers.get(t))==null?void 0:r.filename:(l=this.incomingFileOffers.get(t))==null?void 0:l.filename)||"\u0444\u0430\u0439\u043B";new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0435\u0440\u0435\u0434\u0430\u0447\u0456 \u0444\u0430\u0439\u043B\u0443 '${n}': ${s.message}`),e==="upload"&&this.outgoingFileOffers.delete(t),e==="download"&&this.incomingFileOffers.delete(t),(o=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||o.call(a,t,e,0,0,"error")}isChatViewActive(){let t=this.app.workspace.getLeavesOfType(S);return t.length===0?!1:t.some(e=>this.app.workspace.activeLeaf===e)}async determineSavePath(t){let e=this.settings.downloadPath;if(!e){let a=this.app.vault.getConfig("attachmentFolderPath");if(a&&typeof a=="string"){a.startsWith("/")?e=a.substring(1):e=a;try{this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}catch(o){console.error(`\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0441\u0442\u0432\u043E\u0440\u0438\u0442\u0438/\u043F\u0435\u0440\u0435\u0432\u0456\u0440\u0438\u0442\u0438 \u043F\u0430\u043F\u043A\u0443 \u0432\u043A\u043B\u0430\u0434\u0435\u043D\u044C ${e}, \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0454\u043C\u043E \u043A\u043E\u0440\u0456\u043D\u044C \u0441\u0445\u043E\u0432\u0438\u0449\u0430`,o),e=""}}else console.warn("\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 attachmentFolderPath \u0430\u0431\u043E \u0446\u0435 \u043D\u0435 \u0440\u044F\u0434\u043E\u043A, \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0454\u043C\u043E \u043A\u043E\u0440\u0456\u043D\u044C \u0441\u0445\u043E\u0432\u0438\u0449\u0430."),e=""}let s=this.app.vault.adapter.getBasePath(),n=v.join(s,e);try{b.existsSync(n)||await b.promises.mkdir(n,{recursive:!0})}catch(a){return console.error(`\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0441\u0442\u0432\u043E\u0440\u0438\u0442\u0438 \u0434\u0438\u0440\u0435\u043A\u0442\u043E\u0440\u0456\u044E ${n}, \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0454\u043C\u043E \u043A\u043E\u0440\u0456\u043D\u044C \u0441\u0445\u043E\u0432\u0438\u0449\u0430`,a),v.join(s,this.sanitizeFilename(t))}let r=v.join(n,this.sanitizeFilename(t)),l=1;for(;b.existsSync(r);){let a=v.extname(t),o=v.basename(t,a);r=v.join(n,`${this.sanitizeFilename(o)} (${l})${a}`),l++}return r}sanitizeFilename(t){return t.replace(/[<>:"/\\|?*\x00-\x1F]/g,"_").replace(/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,"_$1$2")}async acceptFileOffer(t,e){var r,l;if(!this.networkManager){console.error(`[${this.manifest.name}] acceptFileOffer: NetworkManager is not initialized.`),new d.Notice("\u041C\u0435\u0440\u0435\u0436\u0435\u0432\u0438\u0439 \u0441\u0435\u0440\u0432\u0456\u0441 \u043D\u0435 \u0430\u043A\u0442\u0438\u0432\u043D\u0438\u0439.");return}let s=this.incomingFileOffers.get(e);if(!s){console.error(`[${this.manifest.name}] acceptFileOffer: \u041D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0456\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0456\u044E \u043F\u0440\u043E \u0432\u0445\u0456\u0434\u043D\u0443 \u043F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u044E \u0444\u0430\u0439\u043B\u0443 ${e}`),new d.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u044E \u0444\u0430\u0439\u043B\u0443 \u043D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u043E.");return}let n=null;if(this.userDiscovery&&(n=this.userDiscovery.getUserInfo(t)),!n){console.log(`[${this.manifest.name}] acceptFileOffer: \u041A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447 ${t} \u043D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u0438\u0439 \u0447\u0435\u0440\u0435\u0437 UserDiscovery, \u0441\u043F\u0440\u043E\u0431\u0430 \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u0430\u0442\u0438 \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0443 \u0430\u0434\u0440\u0435\u0441\u0443 ${s.senderAddress}`);let a=(r=s.senderAddress)==null?void 0:r.split(":");if(s.senderAddress&&a&&a.length===2){let o=a[0],c=parseInt(a[1]);if(o&&!isNaN(c))n={nickname:t,ip:o,port:c},console.log(`[${this.manifest.name}] acceptFileOffer: \u0412\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0454\u043C\u043E \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0443 \u0430\u0434\u0440\u0435\u0441\u0443 ${o}:${c} \u0434\u043B\u044F ${t}`);else{new d.Notice(`\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0440\u043E\u0437\u043F\u0456\u0437\u043D\u0430\u0442\u0438 \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0443 \u0430\u0434\u0440\u0435\u0441\u0443 \u0434\u043B\u044F ${t}`),console.error(`[${this.manifest.name}] acceptFileOffer: \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0440\u043E\u0437\u043F\u0430\u0440\u0441\u0438\u0442\u0438 \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0443 \u0430\u0434\u0440\u0435\u0441\u0443: ${s.senderAddress}`);return}}else{new d.Notice(`\u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0437\u043D\u0430\u0439\u0442\u0438 \u0430\u0434\u0440\u0435\u0441\u0443 \u0432\u0456\u0434\u043F\u0440\u0430\u0432\u043D\u0438\u043A\u0430 ${t}`),console.error(`[${this.manifest.name}] acceptFileOffer: \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 \u0430\u0434\u0440\u0435\u0441\u0443 \u0432\u0456\u0434\u043F\u0440\u0430\u0432\u043D\u0438\u043A\u0430 \u0434\u043B\u044F ${t} (fileId: ${e})`);return}}try{let a=await this.determineSavePath(s.filename);console.log(`[${this.manifest.name}] acceptFileOffer: \u041F\u0440\u0438\u0439\u043D\u044F\u0442\u0442\u044F \u0444\u0430\u0439\u043B\u0443 ${e}. \u0428\u043B\u044F\u0445 \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u043D\u044F: ${a}`),await this.networkManager.prepareToReceiveFile(e,a,s.size,`${t} (${n.ip}:${n.port})`);let o={type:"fileAccept",receiverNickname:this.settings.userNickname,fileId:e};await this.networkManager.sendData(n.ip,n.port,o),console.log(`[${this.manifest.name}] acceptFileOffer: \u041F\u0456\u0434\u0442\u0432\u0435\u0440\u0434\u0436\u0435\u043D\u043D\u044F \u043F\u0440\u0438\u0439\u043D\u044F\u0442\u0442\u044F ${e} \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0434\u043E ${t}. \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0434\u0430\u043D\u0438\u0445...`)}catch(a){console.error(`[${this.manifest.name}] acceptFileOffer: \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0456\u0434 \u0447\u0430\u0441 \u043F\u0440\u0438\u0439\u043D\u044F\u0442\u0442\u044F \u0444\u0430\u0439\u043B\u0443 ${e}:`,a),new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0440\u0438 \u043F\u0440\u0438\u0439\u043D\u044F\u0442\u0442\u0456 \u0444\u0430\u0439\u043B\u0443: ${a.message}`),this.networkManager&&((l=this.networkManager.receivingFiles)!=null&&l.has(e))&&this.networkManager._cleanupReceivingFile(e,a)}}async declineFileOffer(t,e){var r,l,a,o;if(!this.networkManager){console.error(`[${this.manifest.name}] declineFileOffer: NetworkManager is not initialized.`);return}let s=this.incomingFileOffers.get(e);if(!s){console.warn(`[${this.manifest.name}] declineFileOffer: Cannot decline non-existent or already handled offer ${e}`),(l=(r=this.chatView)==null?void 0:r.updateFileProgress)==null||l.call(r,e,"download",0,0,"declined");return}let n=null;if(this.userDiscovery&&(n=this.userDiscovery.getUserInfo(t)),!n&&s.senderAddress){console.log(`[${this.manifest.name}] declineFileOffer: User ${t} not found live, using stored address ${s.senderAddress}`);let c=s.senderAddress.split(":");if(c.length===2){let g=c[0],f=parseInt(c[1]);g&&!isNaN(f)?n={nickname:t,ip:g,port:f}:console.warn(`[${this.manifest.name}] declineFileOffer: Failed to parse stored address ${s.senderAddress}`)}}if(n){let c={type:"fileDecline",receiverNickname:this.settings.userNickname,fileId:e};try{await this.networkManager.sendData(n.ip,n.port,c),console.log(`[${this.manifest.name}] Decline message for file ${e} sent to ${t}.`)}catch(g){console.warn(`[${this.manifest.name}] Failed to send decline message for ${e} to ${t}: ${g.message}`)}}else console.warn(`[${this.manifest.name}] Sender ${t} address unknown, cannot send decline message for ${e}. Declining locally.`);this.incomingFileOffers.delete(e),console.log(`[${this.manifest.name}] Removed incoming offer ${e} locally.`),(o=(a=this.chatView)==null?void 0:a.updateFileProgress)==null||o.call(a,e,"download",0,s.size||0,"declined")}async loadSettings(){this.settings=Object.assign({},N,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let t=this.app.workspace.getLeavesOfType(S);if(t.length>0)this.app.workspace.revealLeaf(t[0]);else{let e=this.app.workspace.getRightLeaf(!1);e?(await e.setViewState({type:S,active:!0}),this.app.workspace.revealLeaf(e)):(console.error(`[${this.manifest.name}] \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 \u043F\u0440\u0430\u0432\u0443 \u043F\u0430\u043D\u0435\u043B\u044C.`),new d.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u0432\u0456\u0434\u043A\u0440\u0438\u0442\u0438 \u043F\u0430\u043D\u0435\u043B\u044C \u0447\u0430\u0442\u0443."))}}async initiateSendFile(t,e){var o,c,g,f;if(!this.networkManager){new d.Notice("\u041C\u0435\u0440\u0435\u0436\u0435\u0432\u0438\u0439 \u0441\u0435\u0440\u0432\u0456\u0441 \u043D\u0435 \u0430\u043A\u0442\u0438\u0432\u043D\u0438\u0439."),console.error(`[${this.manifest.name}] initiateSendFile: NetworkManager is not initialized.`);return}if(e!==null&&!this.userDiscovery){new d.Notice("\u0421\u0435\u0440\u0432\u0456\u0441 \u0432\u0438\u044F\u0432\u043B\u0435\u043D\u043D\u044F \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0456\u0432 \u043D\u0435 \u0430\u043A\u0442\u0438\u0432\u043D\u0438\u0439."),console.warn(`[${this.manifest.name}] initiateSendFile: UserDiscovery is needed to send private file offer to ${e}`);return}let s=`file_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,n=t.name,r=t.size,l=t.path||"\u041D\u0415\u0412\u0406\u0414\u041E\u041C\u0418\u0419_\u0428\u041B\u042F\u0425_\u0414\u041E_\u0424\u0410\u0419\u041B\u0423/"+n;if(l.startsWith("\u041D\u0415\u0412\u0406\u0414\u041E\u041C\u0418\u0419_\u0428\u041B\u042F\u0425")){new d.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041D\u0435\u043C\u043E\u0436\u043B\u0438\u0432\u043E \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 \u0448\u043B\u044F\u0445 \u0434\u043E \u0444\u0430\u0439\u043B\u0443 \u0434\u043B\u044F \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F.",5e3),console.error("initiateSendFile: Failed to determine file path for",n);return}this.outgoingFileOffers.set(s,{fileId:s,filePath:l,filename:n,size:r,recipientNickname:e}),console.log(`[${this.manifest.name}] \u0406\u043D\u0456\u0446\u0456\u0439\u043E\u0432\u0430\u043D\u043E \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443: ${n} (${r} \u0431\u0430\u0439\u0442), ID: ${s}`);let a={type:"fileOffer",senderNickname:this.settings.userNickname,fileId:s,filename:n,size:r};(o=this.chatView)==null||o.displayUploadProgress({fileId:s,filename:n,size:r,recipientNickname:e});try{if(e===null){console.log(`[${this.manifest.name}] \u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F fileOffer (broadcast) \u0434\u043B\u044F ${s}`);let h=[];if(h.length===0)throw new d.Notice("\u041D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u043D\u0438\u0445 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0456\u0432 \u0434\u043B\u044F \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0444\u0430\u0439\u043B\u0443."),new Error("No recipients found for broadcast file offer.");let w=h.map(p=>this.networkManager.sendData(p.ip,p.port,a).catch(m=>console.warn(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F fileOffer (broadcast) \u0434\u043E ${p.nickname}: ${m.message}`)));await Promise.all(w),console.log(`[${this.manifest.name}] \u041F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u044E \u0444\u0430\u0439\u043B\u0443 ${s} \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E (broadcast). \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u0435\u0439...`)}else{console.log(`[${this.manifest.name}] \u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F fileOffer (private) \u0434\u043B\u044F ${s} \u0434\u043E ${e}`);let h=(c=this.userDiscovery)==null?void 0:c.getUserInfo(e);if(h)await this.networkManager.sendData(h.ip,h.port,a),console.log(`[${this.manifest.name}] \u041F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u044E \u0444\u0430\u0439\u043B\u0443 ${s} \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0434\u043E ${e}. \u041E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u043D\u044F \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u0456...`);else throw new Error(`\u041A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447 ${e} \u043D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u0438\u0439.`)}}catch(h){console.error(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043F\u0456\u0434 \u0447\u0430\u0441 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F fileOffer \u0434\u043B\u044F ${s}:`,h),new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u0440\u043E\u043F\u043E\u0437\u0438\u0446\u0456\u0457 \u0444\u0430\u0439\u043B\u0443: ${h.message}`),this.outgoingFileOffers.delete(s),(f=(g=this.chatView)==null?void 0:g.updateFileProgress)==null||f.call(g,s,"upload",0,r,"error")}}async sendMessage(t,e){var c;let s=this.settings.userNickname,n=Date.now();if(!(e!=null&&e.trim())){console.log(`[${this.manifest.name}] \u0421\u043F\u0440\u043E\u0431\u0430 \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 \u043F\u043E\u0440\u043E\u0436\u043D\u0454 \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F.`);return}let r=e.trim();if((c=this.chatView)==null||c.displayMessage(s,r,n,!0),!this.networkManager||!this.userDiscovery){console.error(`[${this.manifest.name}] sendMessage: NetworkManager \u0430\u0431\u043E UserDiscovery \u043D\u0435 \u0456\u043D\u0456\u0446\u0456\u0430\u043B\u0456\u0437\u043E\u0432\u0430\u043D\u043E.`),new d.Notice("\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041C\u0435\u0440\u0435\u0436\u0435\u0432\u0456 \u043A\u043E\u043C\u043F\u043E\u043D\u0435\u043D\u0442\u0438 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0456 \u0434\u043B\u044F \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F.");return}let l=this.networkManager,a=this.userDiscovery,o={type:"text",senderNickname:s,content:r,timestamp:n};try{if(t===null){console.log(`[${this.manifest.name}] \u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F (broadcast)...`);let f=a.getAllUsers().filter(m=>m.nickname!==s);if(f.length===0){console.log(`[${this.manifest.name}] \u041D\u0435\u043C\u0430\u0454 \u043E\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u0447\u0456\u0432 \u0434\u043B\u044F broadcast.`);return}let h=f.map(m=>l.sendData(m.ip,m.port,o).catch(F=>Promise.reject({nickname:m.nickname,address:`${m.ip}:${m.port}`,error:F}))),p=(await Promise.allSettled(h)).filter(m=>m.status==="rejected");p.length>0?(console.warn(`[${this.manifest.name}] \u041D\u0435 \u0432\u0434\u0430\u043B\u043E\u0441\u044F \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u0442\u0438 broadcast ${p.length} \u043E\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u0447\u0430\u043C:`),p.forEach(m=>{let F=m.reason;console.warn(`  - \u0414\u043E ${F.nickname} (${F.address}): ${F.error.message}`)})):console.log(`[${this.manifest.name}] Broadcast \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u0456\u043D\u0456\u0446\u0456\u0439\u043E\u0432\u0430\u043D\u043E \u0434\u043B\u044F ${f.length} \u043E\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u0447\u0456\u0432.`)}else{console.log(`[${this.manifest.name}] \u041D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u0440\u0438\u0432\u0430\u0442\u043D\u043E\u0433\u043E \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0434\u043E ${t}...`);let g=a.getUserInfo(t);if(g)try{await l.sendData(g.ip,g.port,o),console.log(`[${this.manifest.name}] \u041F\u0440\u0438\u0432\u0430\u0442\u043D\u0435 \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0443\u0441\u043F\u0456\u0448\u043D\u043E \u043D\u0430\u0434\u0456\u0441\u043B\u0430\u043D\u043E \u0434\u043E ${t}.`)}catch(f){console.error(`[${this.manifest.name}] \u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u0440\u0438\u0432\u0430\u0442\u043D\u043E\u0433\u043E \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0434\u043E ${t} (${g.ip}:${g.port}):`,f),new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u0434\u043E ${t}: ${f.message}`)}else console.error(`[${this.manifest.name}] \u041E\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u0447\u0430 \u043D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u043E: ${t}`),new d.Notice(`\u041F\u043E\u043C\u0438\u043B\u043A\u0430: \u041A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447 ${t} \u043D\u0435 \u0437\u043D\u0430\u0439\u0434\u0435\u043D\u0438\u0439 \u0430\u0431\u043E \u043E\u0444\u043B\u0430\u0439\u043D.`)}}catch(g){console.error(`[${this.manifest.name}] \u041D\u0435\u043E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u0430 \u043F\u043E\u043C\u0438\u043B\u043A\u0430 \u0432 sendMessage:`,g),new d.Notice("\u041D\u0435\u043E\u0447\u0456\u043A\u0443\u0432\u0430\u043D\u0430 \u043F\u043E\u043C\u0438\u043B\u043A\u0430 \u043D\u0430\u0434\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F.")}}},D=class extends d.PluginSettingTab{constructor(t,e){super(t,e);this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"\u041D\u0430\u043B\u0430\u0448\u0442\u0443\u0432\u0430\u043D\u043D\u044F \u041B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0427\u0430\u0442\u0443"}),new d.Setting(t).setName("\u0412\u0430\u0448 \u041F\u0441\u0435\u0432\u0434\u043E\u043D\u0456\u043C").setDesc("\u042F\u043A \u0432\u0430\u0441 \u0431\u0430\u0447\u0438\u0442\u0438\u043C\u0443\u0442\u044C \u0456\u043D\u0448\u0456 \u043A\u043E\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\u0456 \u0432 \u043C\u0435\u0440\u0435\u0436\u0456.").addText(e=>e.setPlaceholder("\u0412\u0432\u0435\u0434\u0456\u0442\u044C \u043F\u0441\u0435\u0432\u0434\u043E\u043D\u0456\u043C").setValue(this.plugin.settings.userNickname).onChange(async s=>{this.plugin.settings.userNickname=s.trim()||N.userNickname,await this.plugin.saveSettings()})),new d.Setting(t).setName("\u041F\u043E\u0440\u0442 \u0434\u043B\u044F \u043F\u0440\u043E\u0441\u043B\u0443\u0445\u043E\u0432\u0443\u0432\u0430\u043D\u043D\u044F").setDesc("TCP \u043F\u043E\u0440\u0442, \u044F\u043A\u0438\u0439 \u0431\u0443\u0434\u0435 \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0432\u0430\u0442\u0438 \u043F\u043B\u0430\u0433\u0456\u043D. \u041F\u043E\u0442\u0440\u0435\u0431\u0443\u0454 \u043F\u0435\u0440\u0435\u0437\u0430\u043F\u0443\u0441\u043A\u0443 Obsidian \u0434\u043B\u044F \u0437\u0430\u0441\u0442\u043E\u0441\u0443\u0432\u0430\u043D\u043D\u044F.").addText(e=>e.setPlaceholder(String(N.listenPort)).setValue(String(this.plugin.settings.listenPort)).onChange(async s=>{let n=parseInt(s);!isNaN(n)&&n>1024&&n<65535?this.plugin.settings.listenPort=n:(e.setValue(String(this.plugin.settings.listenPort)),new d.Notice("\u041D\u0435\u043A\u043E\u0440\u0435\u043A\u0442\u043D\u0438\u0439 \u043F\u043E\u0440\u0442. \u0412\u0432\u0435\u0434\u0456\u0442\u044C \u0447\u0438\u0441\u043B\u043E \u0432\u0456\u0434 1025 \u0434\u043E 65534.")),await this.plugin.saveSettings()})),new d.Setting(t).setName("\u0417\u0431\u0435\u0440\u0456\u0433\u0430\u0442\u0438 \u0456\u0441\u0442\u043E\u0440\u0456\u044E \u0447\u0430\u0442\u0443").setDesc("\u0427\u0438 \u0437\u0431\u0435\u0440\u0456\u0433\u0430\u0442\u0438 \u043F\u043E\u0432\u0456\u0434\u043E\u043C\u043B\u0435\u043D\u043D\u044F \u043C\u0456\u0436 \u0441\u0435\u0441\u0456\u044F\u043C\u0438 Obsidian.").addToggle(e=>e.setValue(this.plugin.settings.saveHistory).onChange(async s=>{this.plugin.settings.saveHistory=s,await this.plugin.saveSettings()}))}};
